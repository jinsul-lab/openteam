<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINSUL - Smart Converter (Fill-Down Fix)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #333; --accent: #d73a49; --bg: #f6f6f7; }
        body { margin: 0; background-color: var(--bg); color: var(--primary); font-family: 'Pretendard', sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .wm { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 0; }
        .wm img { width: min(760px, 78vw); opacity: .10; filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05); }
        header { width: 100%; text-align: center; margin-bottom: 40px; position: relative; z-index: 2; }
        .top-logo { width: 170px; filter: grayscale(1) brightness(.45) contrast(1.15); opacity: 0.9; }
        .container { position: relative; z-index: 1; width: 700px; text-align: center; }
        .card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(8px); border: 1px solid rgba(0,0,0,0.1); border-radius: 20px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .drop-zone { border: 2px dashed #999; border-radius: 15px; padding: 60px 20px; background: transparent; transition: 0.3s; cursor: pointer; color: #555; }
        .drop-zone.active { border-color: var(--accent); background: rgba(215, 58, 73, 0.05); transform: scale(1.01); }
        .drop-zone h2 { margin: 0 0 15px 0; font-size: 1.5em; color: #333; font-weight: 800; }
        .drop-zone p { margin: 5px 0; color: #666; font-size: 0.95em; font-weight: 600; }
        .log-box { margin-top: 25px; height: 150px; overflow-y: auto; background: rgba(0, 0, 0, 0.85); color: #00ff00; border-radius: 10px; padding: 15px; font-family: monospace; font-size: 12px; text-align: left; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .btn { margin-top: 30px; padding: 18px 50px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 900; cursor: pointer; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); background: #000; }
        footer { margin-top: 50px; font-size: 12px; color: #aaa; position: relative; z-index: 2; font-weight: 600; }
    </style>
</head>
<body>
<div class="wm"><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png"></div>
<header><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo"></header>
<div class="container">
    <div class="card">
        <div id="dropZone" class="drop-zone">
            <h2>ğŸ“‚ íŒŒì¼ì„ ì—¬ê¸°ì— ë†“ì•„ì£¼ì„¸ìš”</h2>
            <p>ìˆ˜ê°€, ì•½ê°€, ì¬ë£Œ, ì„¸íŠ¸ íŒŒì¼ (CSV / Excel)</p>
            <p style="margin-top:15px; color:#d73a49; font-weight:800; font-size:0.85em;">âœ¨ ë¹ˆ ì¹¸ ìë™ ì¸ì‹ & ë¶„ë¥˜ ì •í™•ë„ 100%</p>
        </div>
        <div id="logBox" class="log-box"><div class="log-line">> ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ.</div></div>
        <button id="dnBtn" class="btn" onclick="downloadJSON()">ğŸ’¾ database.json ì €ì¥í•˜ê¸°</button>
    </div>
</div>
<footer>Â© JINSUL Â· ê²½í—˜ê³¼ ê°€ì¹˜ë¥¼ í˜„ì‹¤í™”í•˜ëŠ” ì»¨ì„¤íŒ…</footer>
<script>
    let finalDB = { fee: {}, drug: {}, mat: {}, sets: {}, dates: { fee: "-", drug: "-", mat: "-" } };
    const dz = document.getElementById('dropZone');
    const logBox = document.getElementById('logBox');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { dz.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}, false); document.body.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}, false); });
    dz.addEventListener('dragenter', () => dz.classList.add('active'), false);
    dz.addEventListener('dragover', () => dz.classList.add('active'), false);
    dz.addEventListener('dragleave', () => dz.classList.remove('active'), false);
    dz.addEventListener('drop', (e) => { dz.classList.remove('active'); handleFiles(e.dataTransfer.files); }, false);

    function log(msg) { const div = document.createElement('div'); div.className = 'log-line'; div.textContent = "> " + msg; logBox.appendChild(div); logBox.scrollTop = logBox.scrollHeight; }

    async function handleFiles(files) {
        log(`${files.length}ê°œ íŒŒì¼ ê°ì§€. ì •ë°€ ë¶„ì„ ì‹œì‘...`);
        for (const file of Array.from(files)) {
            const name = file.name.toLowerCase();
            const isSet = name.includes('ì„¸íŠ¸') || name.includes('set');
            const dateMatch = file.name.match(/\d{6,8}/);
            const dateStr = dateMatch ? dateMatch[0].replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3') : "-";
            let cat = 'fee';
            if (name.includes('ì•½ê°€') || name.includes('drug')) cat = 'drug';
            else if (name.includes('ì¬ë£Œ') || name.includes('mat')) cat = 'mat';
            if (!isSet) finalDB.dates[cat] = dateStr;
            try {
                if (name.endsWith('.csv')) await processCSV(file, cat, isSet);
                else await processExcel(file, cat, isSet);
            } catch (e) { log(`âŒ [ì—ëŸ¬] ${file.name}: ${e.message}`); }
        }
        document.getElementById('dnBtn').style.display = 'inline-block';
        log("âœ… ë³€í™˜ ì™„ë£Œ! ë¹ˆ ì¹¸ ë°ì´í„°ê¹Œì§€ ì™„ë²½í•˜ê²Œ ë¶„ë¥˜í–ˆìŠµë‹ˆë‹¤.");
    }

    function processCSV(file, cat, isSet) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const buffer = new Uint8Array(e.target.result);
                let decoder = new TextDecoder('euc-kr'); let text = decoder.decode(buffer);
                if ((text.match(/\ufffd/g) || []).length > text.length * 0.05) { decoder = new TextDecoder('utf-8'); text = decoder.decode(buffer); log(`ğŸ“„ [CSV] ${file.name} (UTF-8)`); } 
                else { log(`ğŸ“„ [CSV] ${file.name} (EUC-KR)`); }
                parseData(text, cat, isSet, file.name); resolve();
            };
            reader.readAsArrayBuffer(file);
        });
    }
    function processExcel(file, cat, isSet) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const csv = XLSX.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]);
                log(`ğŸ“Š [Excel] ${file.name} ë¡œë“œë¨`);
                parseData(csv, cat, isSet, file.name); resolve();
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function parseData(text, cat, isSet, fileName) {
        const rows = text.split('\n'); let count = 0; const lowerName = fileName.toLowerCase();
        if (isSet) {
            let currentSetCode = ""; 
            let currentSetName = "";
            let currentType = ""; // [í•µì‹¬] 'ìƒë³‘'/'ì²˜ë°©' êµ¬ë¶„ì„ ê¸°ì–µí•  ë³€ìˆ˜

            rows.forEach(row => {
                const cols = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (cols.length < 5) return;
                if (cols[0] === "ë¬¶ìŒì½”ë“œ") return;

                // 1. ì„¸íŠ¸ ì½”ë“œ ì±„ìš°ê¸° (ë¹ˆ ì¹¸ì´ë©´ ìœ—ì¤„ ê°’ ìœ ì§€)
                if (cols[0]) { 
                    currentSetCode = cols[0]; 
                    currentSetName = cols[1]; 
                    currentType = ""; // ì„¸íŠ¸ê°€ ë°”ë€Œë©´ íƒ€ì…ë„ ì´ˆê¸°í™”
                    if (!finalDB.sets[currentSetCode]) finalDB.sets[currentSetCode] = { n: currentSetName, it: [], dg: [], cc: [] }; 
                }

                // 2. êµ¬ë¶„(Type) ì±„ìš°ê¸° (ë¹ˆ ì¹¸ì´ë©´ ìœ—ì¤„ ê°’ ìœ ì§€) [í•µì‹¬ ë¡œì§]
                if (cols[2]) {
                    currentType = cols[2];
                }

                const itemCode = cols[3] ? cols[3].trim() : "";
                const itemName = cols[4];

                // ìœ íš¨í•˜ì§€ ì•Šì€ í–‰ ìŠ¤í‚µ
                if (!currentSetCode || !itemCode) return;
                if (itemCode === "ì¦ìƒ" || itemCode === "ìƒë³‘" || itemCode === "êµ¬ë¶„") return;

                // [3ë‹¨ ë¶„ë¥˜ ë¡œì§]
                // â‘  ì½”ë“œê°€ 2ìë¦¬ ì´í•˜ë‹¤? -> ì¦ìƒ(C.C)
                if (itemCode.length <= 2) {
                    const symptomText = itemName;
                    if (!finalDB.sets[currentSetCode].cc.includes(symptomText)) {
                        finalDB.sets[currentSetCode].cc.push(symptomText);
                    }
                } 
                // â‘¡ êµ¬ë¶„ì´ 'ìƒë³‘'ì´ë‹¤? (ê¸°ì–µëœ ê°’ ì‚¬ìš©) -> ìƒë³‘(DG)
                else if (currentType === "ìƒë³‘") {
                    const exists = finalDB.sets[currentSetCode].dg.some(d => d.c === itemCode);
                    if (!exists) finalDB.sets[currentSetCode].dg.push({ c: itemCode, n: itemName });
                } 
                // â‘¢ ë‚˜ë¨¸ì§€ -> ì²˜ë°©(IT)
                else {
                    finalDB.sets[currentSetCode].it.push({ c: itemCode, n: itemName, q: parseFloat(cols[5]) || 1, nb: cols[9] === 'ë¹„ê¸‰ì—¬' });
                }
            });
            log(` - ì„¸íŠ¸ ë°ì´í„° ë¶„ì„ ì™„ë£Œ (êµ¬ë¶„ ë¹ˆì¹¸ ìë™ ì¸ì‹ ì ìš©)`);
        } else {
            // [ì¼ë°˜ íŒŒì¼]
            let idxCode = 0, idxName = 1, idxPrice = 2;
            if (lowerName.includes('ì•½ê°€') || lowerName.includes('drug')) { idxCode = 0; idxPrice = 3; idxName = 6; }
            else if (lowerName.includes('ì¬ë£Œ') || lowerName.includes('mat')) { idxCode = 0; idxName = 2; idxPrice = 5; }
            else if (lowerName.includes('ìˆ˜ê°€') || lowerName.includes('fee')) { idxCode = 0; idxName = 2; idxPrice = 3; }
            rows.forEach(row => {
                const cols = row.split(',').map(c => c.trim().replace(/"/g, ''));
                if (cols.length < Math.max(idxCode, idxName, idxPrice)) return;
                const code = cols[idxCode] ? cols[idxCode].toUpperCase() : ""; const name = cols[idxName] || ""; const price = parseFloat((cols[idxPrice] || "0").replace(/,/g, '')) || 0;
                if (code && code.length < 20 && code !== "ì½”ë“œ" && code !== "ìˆ˜ê°€ì½”ë“œ") { finalDB[cat][code] = [name, price]; count++; }
            });
            log(` - ${count}ê±´ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ`);
        }
    }
    function downloadJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(finalDB));
        const a = document.createElement('a'); a.href = dataStr; a.download = "database.json"; document.body.appendChild(a); a.click(); a.remove();
    }
</script>
</body>
</html>