<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINSUL - Database Master Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1e1e1e; --accent: #007bff; --success: #28a745; }
        body { font-family: 'Pretendard', sans-serif; background: #f0f2f5; padding: 40px; text-align: center; }
        .box { background: #fff; width: 650px; border-radius: 20px; padding: 40px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); display: inline-block; border: 1px solid #ddd; }
        .drop-zone { border: 3px dashed #333; padding: 60px; border-radius: 15px; cursor: pointer; background: #fafafa; transition: 0.3s; margin-bottom: 25px; }
        .drop-zone.dragover { background: #eef6ff; border-color: var(--accent); }
        #log { text-align: left; background: #000; color: #00ff41; padding: 18px; border-radius: 12px; font-family: 'Consolas', monospace; font-size: 11px; height: 200px; overflow-y: auto; margin-bottom: 25px; line-height: 1.5; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 18px; border-radius: 10px; font-weight: 800; border: none; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .dl-btn { background: var(--primary); color: #fff; }
        .dl-btn:disabled { background: #ccc; cursor: not-allowed; }
        .clear-btn { background: #dc3545; color: #fff; }
    </style>
</head>
<body>

    <div class="box">
        <img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" width="160" style="margin-bottom:20px; filter: grayscale(1);">
        <h2 style="letter-spacing:-1px;">í†µí•© ë°ì´í„°ë² ì´ìŠ¤ ë§ˆìŠ¤í„° ì»¨ë²„í„°</h2>
        
        <div id="dropZone" class="drop-zone">
            <div style="font-size:45px;">ğŸ“¥</div>
            <p>ìˆ˜ê°€, ì•½ê°€, ì¬ë£Œ, ì„¸íŠ¸ íŒŒì¼ì„ ì—¬ê¸°ì— ë˜ì§€ì„¸ìš”</p>
            <span style="font-size:12px; color:#999;">ëˆ„ì  ë°©ì‹ | í•œê¸€ ë³´ì • | 9MBê¸‰ ì´ˆì••ì¶• ì—”ì§„ íƒ‘ì¬</span>
        </div>
        <input type="file" id="fInput" multiple style="display:none" onchange="handleFiles(this.files)">

        <div id="log">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>

        <div class="btn-group">
            <button id="dlBtn" class="btn dl-btn" onclick="downloadJSON()" disabled>ìµœì í™” JSON ë‹¤ìš´ë¡œë“œ (0ê±´)</button>
            <button class="btn clear-btn" onclick="location.reload()">ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </div>

<script>
    // ì „ì—­ ì €ì¥ì†Œ (ë°°ì—´ ì••ì¶• ë°©ì‹)
    let finalDB = { fee: {}, drug: {}, mat: {}, sets: {} };
    let totalItems = 0;

    const dropZone = document.getElementById('dropZone');
    const logEl = document.getElementById('log');

    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => { dropZone.classList.remove('dragover'); };
    dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
    dropZone.onclick = () => document.getElementById('fInput').click();

    async function handleFiles(files) {
        if(totalItems === 0) logEl.innerHTML = '';
        for(const file of Array.from(files)) {
            addLog(`â–¶ [ë¶„ì„ ì‹œì‘] ${file.name}`);
            await processFile(file);
        }
        updateButton();
    }

    function processFile(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // í•œê¸€ ê¹¨ì§ ë°©ì§€: CP949 ì¸ì½”ë”© ê°•ì œ ì ìš©
                    const wb = XLSX.read(data, {type: 'array', codepage: 949});
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                    
                    const name = file.name.toLowerCase();
                    const headerStr = rows.slice(0, 5).map(r => r.join('')).join('');

                    if (headerStr.includes('ì¦ìƒ') || headerStr.includes('ìƒë³‘')) {
                        const count = parseSets(rows);
                        addLog(`âœ” ì²˜ë°©ì„¸íŠ¸ ${count}ê°œ ëˆ„ì  ì™„ë£Œ`, '#fff');
                    } else {
                        let cat = name.includes('ì•½ê°€') ? 'drug' : (name.includes('ì¬ë£Œ') ? 'mat' : 'fee');
                        const count = parseItems(rows, cat);
                        addLog(`âœ” ${cat.toUpperCase()} ë°ì´í„° ${count.toLocaleString()}ê±´ ëˆ„ì  ì™„ë£Œ`, '#fff');
                    }
                } catch (err) {
                    addLog(`âŒ ì˜¤ë¥˜: ${file.name} ë¶„ì„ ì‹¤íŒ¨`, '#ff5252');
                }
                resolve();
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function parseItems(rows, cat) {
        let cIdx = 0, nIdx = 2, pIdx = 3; 
        
        // í—¤ë” í–‰ì„ ì°¾ì•„ ì‹¤ì œ ì¸ë±ìŠ¤ ë³´ì • (ì˜ì›ë‹¨ê°€, ìƒí•œê°€ ë“± ëŒ€ì‘)
        const headerRow = rows.find(r => r.some(c => {
            const s = String(c);
            return s.includes('ì½”ë“œ') || s.includes('ìˆ˜ê°€') || s.includes('í’ˆëª…');
        }));

        if (headerRow) {
            cIdx = headerRow.findIndex(v => String(v).includes('ì½”ë“œ'));
            nIdx = headerRow.findIndex(v => String(v).includes('í•œê¸€ëª…') || String(v).includes('ëª…ì¹­') || String(v).includes('í’ˆëª…'));
            pIdx = headerRow.findIndex(v => String(v).includes('ì˜ì›ë‹¨ê°€') || String(v).includes('ë‹¨ê°€') || String(v).includes('ê¸ˆì•¡') || String(v).includes('ìƒí•œê°€'));
        }

        let count = 0;
        rows.forEach(r => {
            const code = String(r[cIdx] || '').trim().toUpperCase();
            if (code.length < 4 || code.includes('ì½”ë“œ')) return;

            const name = String(r[nIdx] || '').trim().substring(0, 40); // ëª…ì¹­ ìµœì í™”
            const price = parseInt(String(r[pIdx] || '0').replace(/[^0-9]/g, '')) || 0;

            if (price > 0) {
                // ì••ì¶• êµ¬ì¡° ì ìš©: ["ëª…ì¹­", ë‹¨ê°€]
                finalDB[cat][code] = [name, price];
                count++;
            }
        });
        totalItems += count;
        return count;
    }

    function parseSets(rows) {
        let bundles = {};
        let cur = null, sec = "";
        let count = 0;
        rows.forEach(r => {
            const a = String(r[0]||"").trim();
            if (a.startsWith('+') || a.startsWith('Z')) {
                cur = a; bundles[cur] = { n: String(r[1]||a).trim().substring(0,40), cc: [], dg: [], it: [] };
                sec = ""; count++; return;
            }
            if (!cur) return;
            const rowStr = r.join(" ");
            if (rowStr.includes("ì¦ìƒ")) sec = "CC"; 
            else if (rowStr.includes("ìƒë³‘")) sec = "DIAG"; 
            else if (rowStr.includes("ì²˜ë°©") || rowStr.includes("ITEM")) sec = "ITEM";

            if (sec === "CC" && r[4] && !String(r[4]).includes('PLAN')) bundles[cur].cc.push(r[4]);
            else if (sec === "DIAG" && r[3]) bundles[cur].dg.push([String(r[3]), String(r[4])]);
            else if (sec === "ITEM" && r[3]) {
                const code = String(r[3]).toUpperCase();
                if(code.length >= 4) {
                    bundles[cur].it.push({ 
                        c: code, n: String(r[4]).trim().substring(0,40), 
                        q: parseFloat(r[5])||1, nb: String(r[9]).includes('ë¹„ê¸‰ì—¬') 
                    });
                }
            }
        });
        finalDB.sets = { ...finalDB.sets, ...bundles };
        return count;
    }

    function addLog(msg, color = '#00e676') {
        const div = document.createElement('div');
        div.style.color = color;
        div.style.marginBottom = '5px';
        div.innerText = msg;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function updateButton() {
        const btn = document.getElementById('dlBtn');
        const setLen = Object.keys(finalDB.sets).length;
        btn.disabled = false;
        btn.innerText = `ìµœì í™” JSON ë‹¤ìš´ë¡œë“œ (ì´ ${totalItems.toLocaleString()}ê±´ / ì„¸íŠ¸ ${setLen}ê°œ)`;
    }

    function downloadJSON() {
        const blob = new Blob([JSON.stringify(finalDB)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "database.json";
        a.click();
    }
</script>
</body>
</html>
