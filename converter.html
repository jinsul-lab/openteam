<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINSUL DB Converter (Final Fix)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; background: #f4f4f4; }
        .box { background: white; padding: 30px; border-radius: 15px; display: inline-block; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input { margin: 10px 0; display: block; width: 100%; }
        #log { margin-top: 20px; font-size: 12px; color: blue; text-align: left; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="box">
        <h2>JINSUL 데이터 변환기 (최종)</h2>
        <p style="font-size:12px; color:red;">파일을 하나씩 선택하면 즉시 분석합니다.</p>
        <input type="file" accept=".xlsx,.xlsb,.csv" onchange="processFile(this)">
        <button id="dlBtn" onclick="downloadJSON()" style="padding:15px 30px; background:#333; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;" disabled>JSON 다운로드 (0건)</button>
        <div id="log"></div>
    </div>

<script>
    let finalDB = { fee: {}, drug: {}, mat: {}, sets: {} };
    let totalCount = 0;

    function processFile(input) {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
            
            // 헤더 위치 찾기
            let cIdx = -1, nIdx = -1, pIdx = -1;
            const headerRow = rows.find(r => r.some(c => String(c).includes('수가') || String(c).includes('코드')));
            
            if (headerRow) {
                cIdx = headerRow.findIndex(v => String(v).includes('코드'));
                nIdx = headerRow.findIndex(v => String(v).includes('한글명') || String(v).includes('명칭'));
                pIdx = headerRow.findIndex(v => String(v).includes('의원단가') || String(v).includes('단가') || String(v).includes('금액'));
            } else {
                // 헤더 못찾으면 강제 지정 (A, C, D열)
                cIdx = 0; nIdx = 2; pIdx = 3;
            }

            let count = 0;
            rows.forEach((r, i) => {
                const code = String(r[cIdx] || '').trim().toUpperCase();
                if (code.length < 4 || code === '수가코드') return;
                
                const name = String(r[nIdx] || '').trim();
                const price = parseInt(String(r[pIdx] || '0').replace(/[^0-9]/g, '')) || 0;
                
                finalDB.fee[code] = { n: name, p: price };
                count++;
            });

            totalCount += count;
            document.getElementById('log').innerHTML += `<div>✔ ${file.name}: ${count}건 분석 완료</div>`;
            const btn = document.getElementById('dlBtn');
            btn.disabled = false;
            btn.innerText = `JSON 다운로드 (총 ${totalCount}건)`;
        };
        reader.readAsArrayBuffer(file);
    }

    function downloadJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(finalDB));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "database.json";
        a.click();
    }
</script>
</body>
</html>
