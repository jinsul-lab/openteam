<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINSUL - Case Verification System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary-grey: #333; --accent-red: #d73a49; --border: rgba(0, 0, 0, 0.1); }
        body { margin: 0; background-color: #f6f6f7; color: #333; font-family: 'Pretendard', sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        /* [UI] ì‹±í¬ ë³´ë“œ (ìƒìí˜• ê³ ì •) */
        #syncBoard { position: fixed; top: 10px; right: 20px; background: #fff; border: 1px solid #222; border-radius: 10px; padding: 12px 18px; font-size: 11px; z-index: 1000; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 420px; }
        .sync-list { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .sync-item { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 80px; }
        .tag-name { font-weight: 800; color: #666; font-size: 10px; }
        .st-box { display: flex; gap: 4px; }
        .st-val { font-weight: 700; padding: 2px 4px; border-radius: 3px; font-size: 9px; background: #f5f5f5; color: #bbb; display: flex; align-items: center; gap: 2px; }
        
        .active-svr { color: #007bff !important; background: #eef6ff !important; }
        .active-loc { color: #28a745 !important; background: #effff3 !important; }
        .fail-val { color: #dc3545 !important; background: #fff0f1 !important; }
        .loading-val { color: #856404 !important; background: #fff3cd !important; border: 1px solid #ffeeba; }
        .debug-msg { font-size: 10px; color: #888; margin-top: 5px; letter-spacing: -0.5px; }

        /* [ë””ìì¸] JINSUL ê·œê²© ê³ ì • */
        .wm { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 0; }
        .wm img { width: min(760px, 78vw); opacity: .10; user-select: none; filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05); }
        header { width: 100%; padding: 30px 0; text-align: center; }
        .top-logo { width: 170px; height: auto; display: block; margin: 0 auto 10px; filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15); opacity: 0.8; }
        
        .container { width: 1550px; max-width: 98%; margin: 0 auto; display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 40px; padding-bottom: 100px; position: relative; z-index: 1; }
        .card { background: rgba(255, 255, 255, 0.10); border: 1px solid var(--border); border-radius: 12px; padding: 35px; backdrop-filter: blur(1px); -webkit-backdrop-filter: blur(1px); margin-bottom: 30px; }
        
        .section-title { font-size: 0.85em; font-weight: 800; color: #999; margin: 30px 0 15px 0; border-left: 3px solid #333; padding-left: 12px; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; background: transparent; }
        th { border-bottom: 2px solid #eee; padding: 12px 10px; text-align: left; font-size: 0.8em; color: #aaa; background: rgba(243, 244, 246, 0.5); }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 0.95em; }
        
        .target-input { font-size: 3.5em; width: 240px; background: none; border: none; border-bottom: 4px solid #333; color: #333; text-align: right; font-weight: 900; outline: none; }
        .lock-btn { background: none; border: none; font-size: 1.3em; cursor: pointer; opacity: 0.2; }
        .lock-btn.active { opacity: 1; color: var(--accent-red); }
        
        #loader { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; transition: 0.5s; font-weight: 900; font-size: 1.5em; }
        footer { width: 100%; text-align: center; padding: 60px 0; font-size: 12px; color: #aaa; }
    </style>
</head>
<body>

<div class="wm" aria-hidden="true"><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" alt=""></div>

<div id="syncBoard">
    <div class="sync-list" id="syncStatusList"></div>
    <div class="upload-btn-area" style="margin-top:5px;">
        <button onclick="document.getElementById('manualUpload').click()" style="width:100%; padding:7px; background:#333; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:10px; font-weight:bold;">ğŸ“‚ ìˆ˜ê°€ íŒŒì¼ ì—…ë¡œë“œ (ìŠ¤ë§ˆíŠ¸ ì¸ì‹)</button>
        <input type="file" id="manualUpload" accept=".xlsx, .xlsb, .csv" multiple style="display:none;" onchange="handleManualFiles(this)">
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 9px; font-weight: 700; color: #aaa;">
        <span>ë°ì´í„° DB: <span id="totalItems" style="color:#333;">0</span> ê±´</span>
        <span style="cursor:pointer; color:#007bff;" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨ â†»</span>
    </div>
    <div id="debugLog" class="debug-msg">ëŒ€ê¸° ì¤‘...</div>
</div>

<div id="loader">ë°ì´í„°ë¥¼ ì—°ë™ ì¤‘ì…ë‹ˆë‹¤</div>

<header><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo"></header>

<div class="container">
    <div class="main-column">
        <div class="card">
            <div style="display: flex; gap: 12px; margin-bottom: 35px;">
                <select id="bundleSelect" style="flex: 1; font-weight: 700; font-size: 1.1em; border: 2px solid #333; border-radius: 8px; padding: 12px; outline:none; background:#fff;"></select>
                <button onclick="loadBundle()" style="padding:0 40px; border-radius:10px; border:1px solid #ddd; font-weight:700; cursor:pointer; background: #333; color:#fff;">ì¡°íšŒí•˜ê¸°</button>
            </div>
            <div id="resultContent" style="display:none;">
                <div class="section-title">Chief Complaint</div>
                <div id="symptomDisplay" style="padding:25px; background:rgba(0,0,0,0.02); border-radius:12px; font-size:1em; line-height:1.8; margin-bottom:30px;"></div>
                <div class="section-title">Diagnosis</div>
                <table><tbody id="diagList"></tbody></table>
                <div class="section-title">Prescription / ìˆ˜ëŸ‰ ì—­ì‚°</div>
                <table>
                    <thead><tr><th style="width:18%">ì½”ë“œ</th><th>í•­ëª©ëª…</th><th style="width:22%">ë‹¨ê°€</th><th style="width:15%">ìˆ˜ëŸ‰</th><th style="width:10%; text-align:center;">ì ê¸ˆ</th></tr></thead>
                    <tbody id="itemList"></tbody>
                </table>
                <button style="background:#333; color:white; width:100%; padding:18px; border:none; border-radius:10px; font-weight:700; margin-top:20px; cursor:pointer;" onclick="autoBalance()">ê°•ì œ ì—­ì‚° ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <div class="side-column">
        <div class="card" style="background: rgba(0,0,0,0.03); text-align: center; padding: 45px;">
            <div style="font-size: 0.85em; color: #888; margin-bottom: 12px; font-weight: 600;">TARGET AMOUNT</div>
            <input type="number" id="targetPrice" class="target-input" value="89000" oninput="autoBalance()"> ì›
        </div>
        <div class="card" style="text-align: center; margin-top: 30px; border-top: 6px solid #333;">
            <div id="finalPayment" style="font-size: 4em; font-weight: 900; color: #333; letter-spacing: -3px;">0</div>
            <div style="margin-top:20px; font-size:1.1em; color:#888;">ë³¸ì¸ë¶€ë‹´ê¸ˆ: <span id="benefitPay" style="font-weight:800; color:#333;">0</span>ì›</div>
        </div>
    </div>
</div>

<footer>Â© JINSUL Â· ê²½í—˜ê³¼ ê°€ì¹˜ë¥¼ í˜„ì‹¤í™”í•˜ëŠ” ì»¨ì„¤íŒ…</footer>

<script id="worker-script" type="text/javascript">
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
    self.onmessage = async function(e) {
        const { url, buffer, source } = e.data;
        try {
            let dataBuffer = buffer;
            if (url) {
                const response = await fetch(url);
                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0, chunks = [];
                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value); receivedLength += value.length;
                    if (contentLength) self.postMessage({ type: 'progress', pct: Math.floor((receivedLength / contentLength) * 100), source });
                }
                dataBuffer = new Uint8Array(receivedLength);
                let pos = 0; for(let chunk of chunks) { dataBuffer.set(chunk, pos); pos += chunk.length; }
            }
            
            self.postMessage({ type: 'parsing', source });
            const workbook = XLSX.read(dataBuffer, { type: 'array', cellStyles: false, bookSheets: true });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true });
            
            // [ìŠ¤ë§ˆíŠ¸ ë¡œì§] í—¤ë” ìë™ ì°¾ê¸° (ì½”ë“œ, ëª…ì¹­, ë‹¨ê°€)
            let cIdx = -1, nIdx = -1, pIdx = -1, startRow = 0;
            
            // ìƒìœ„ 20ì¤„ ê²€ì‚¬
            for(let i=0; i<Math.min(rows.length, 20); i++) {
                const row = rows[i].map(x => String(x).replace(/\s/g, ''));
                if(cIdx === -1) cIdx = row.findIndex(v => v.includes('ì½”ë“œ') || v.includes('ìˆ˜ê°€'));
                if(nIdx === -1) nIdx = row.findIndex(v => v.includes('ëª…ì¹­') || v.includes('í•œê¸€ëª…') || v.includes('í’ˆëª…'));
                if(pIdx === -1) pIdx = row.findIndex(v => v.includes('ë‹¨ê°€') || v.includes('ê¸ˆì•¡') || v.includes('ìƒí•œê°€'));
                
                if(cIdx > -1 && nIdx > -1 && pIdx > -1) { startRow = i + 1; break; }
            }

            // ëª» ì°¾ìœ¼ë©´ ê¸°ë³¸ê°’ (C, D, F)
            if(cIdx === -1) cIdx = 2;
            if(nIdx === -1) nIdx = 3;
            if(pIdx === -1) pIdx = 5;

            self.postMessage({ type: 'debug', msg: `ì—´ ì¸ì‹ ê²°ê³¼: ì½”ë“œ(${cIdx}), ëª…ì¹­(${nIdx}), ë‹¨ê°€(${pIdx})`, source });

            const data = [];
            for(let i = startRow; i < rows.length; i++) {
                const r = rows[i];
                if(!r) continue;
                const code = String(r[cIdx] || '').trim().toUpperCase();
                if(code && code.length >= 4) {
                    data.push([code, String(r[nIdx] || 'ëª…ì¹­ì—†ìŒ').trim(), parseInt(String(r[pIdx] || '0').replace(/[^0-9]/g, '')) || 0]);
                }
            }
            self.postMessage({ type: 'done', data, source });
        } catch (err) { self.postMessage({ type: 'error', source, msg: err.message }); }
    };
</script>

<script>
    const REPO = "https://raw.githubusercontent.com/jinsul-lab/openteam/main/";
    let masterDB = new Map(), bundles = {};
    const fmt = (v) => Number(v || 0).toLocaleString();
    const clean = (v) => parseFloat(String(v).replace(/,/g, '')) || 0;

    const blob = new Blob([document.getElementById('worker-script').textContent], { type: 'text/javascript' });
    const worker = new Worker(URL.createObjectURL(blob));

    worker.onmessage = function(e) {
        const srv = document.getElementById('srv-' + e.data.source);
        const loc = document.getElementById('loc-' + e.data.source);
        
        if (e.data.type === 'progress') { srv.innerHTML = `ë‹¤ìš´ ${e.data.pct}%`; srv.className = "st-val loading-val"; }
        else if (e.data.type === 'parsing') { srv.innerHTML = "ë¶„ì„ ì¤‘.."; }
        else if (e.data.type === 'debug') { document.getElementById('debugLog').innerText = e.data.msg; }
        else if (e.data.type === 'done') {
            if (e.data.data && e.data.data.length > 0) {
                e.data.data.forEach(item => masterDB.set(item[0], { name: item[1], price: item[2] }));
                updateStatusUI(e.data.source, loc && loc.innerHTML !== "ë¡œì»¬âŒ" ? "Local" : "Server");
            } else { updateStatusUI(e.data.source, "ì„œë²„âŒ"); }
        } else if (e.data.type === 'error') { updateStatusUI(e.data.source, "ì„œë²„âŒ"); }
    };

    async function init() {
        const board = document.getElementById('syncStatusList');
        const items = [{id:'fee',n:'ì˜ì¹˜ê³¼ìˆ˜ê°€'},{id:'drug',n:'ì•½ê°€'},{id:'mat',n:'ì¹˜ë£Œì¬ë£ŒëŒ€'},{id:'bundle',n:'ì²˜ë°©ì„¸íŠ¸'}];
        items.forEach(item => {
            const div = document.createElement('div'); div.className = 'sync-item';
            div.innerHTML = `<span class="tag-name">${item.n}</span><div class="st-box"><span id="srv-${item.id}" class="st-val">ì—°ê²°..</span><span id="loc-${item.id}" class="st-val fail-val">ë¡œì»¬âŒ</span></div>`;
            board.appendChild(div);
        });

        // 1. ì„œë²„ ìë™ ì—°ë™ (suga_260101.xlsx)
        worker.postMessage({ url: REPO + "suga_260101.xlsx", source: 'fee' });

        // 2. ì•½ê°€, ì¬ë£ŒëŒ€ ë¡œë“œ
        fetchCSV(REPO + "ì•½ê°€.csv", 'drug', { code: 0, name: 6, price: 3 });
        fetchCSV(REPO + "ì¹˜ë£Œì¬ë£ŒëŒ€.csv", 'mat', { code: 0, name: 2, price: 5 });
        
        // 3. ì²˜ë°©ì„¸íŠ¸ ë¡œë“œ ë° ë¦¬ìŠ¤íŠ¸ ìƒì„±
        fetch(REPO + "ì²˜ë°©ì„¸íŠ¸.xls").then(r => r.arrayBuffer()).then(b => {
            const wb = XLSX.read(new Uint8Array(b), { type: 'array' });
            parseBundle(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 }));
            updateStatusUI('bundle', "Server");
            renderOptions(); // ë¡œë“œ ì™„ë£Œ ì¦‰ì‹œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        });

        setTimeout(() => { document.getElementById('loader').style.opacity = '0'; setTimeout(()=>document.getElementById('loader').style.display='none', 500); }, 1000);
    }

    async function fetchCSV(url, key, cfg) {
        try {
            const res = await fetch(url + "?t=" + Date.now());
            const text = new TextDecoder('euc-kr').decode(await res.arrayBuffer());
            let count = 0;
            text.split('\n').forEach(line => {
                const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const code = cols[cfg.code]?.replace(/"/g, '').trim().toUpperCase();
                if (code && code.length > 3) {
                    masterDB.set(code, { name: cols[cfg.name]?.replace(/"/g, '').trim() || "ëª…ì¹­ì—†ìŒ", price: parseInt(cols[cfg.price]?.replace(/[^0-9]/g, '')) || 0 });
                    count++;
                }
            });
            updateStatusUI(key, count > 0 ? "Server" : "ì„œë²„âŒ");
        } catch { updateStatusUI(key, "ì„œë²„âŒ"); }
    }

    // [ì¤‘ìš”] ë‹¤ì¤‘ íŒŒì¼ ìŠ¤ë§ˆíŠ¸ ì—…ë¡œë“œ
    function handleManualFiles(input) {
        const files = Array.from(input.files);
        files.forEach(file => {
            const name = file.name.toLowerCase();
            const key = (name.includes('ìˆ˜ê°€') || name.includes('suga') || name.includes('fee')) ? 'fee' : (name.includes('ì•½ê°€') ? 'drug' : (name.includes('ì¬ë£Œ') ? 'mat' : null));
            
            if (!key) return; // ì•Œ ìˆ˜ ì—†ëŠ” íŒŒì¼ì€ íŒ¨ìŠ¤

            const loc = document.getElementById('loc-' + key);
            loc.innerHTML = "ë¶„ì„ì¤‘.."; loc.className = "st-val loading-val";
            
            const reader = new FileReader();
            reader.onload = (e) => {
                if (name.endsWith('.csv')) {
                    // CSV ì²˜ë¦¬ (ì•½ê°€ ë“±)
                    const text = new TextDecoder('euc-kr').decode(e.target.result);
                    const cfg = (key === 'fee') ? { code: 0, name: 3, price: 7 } : (key === 'drug' ? { code: 0, name: 6, price: 3 } : { code: 0, name: 2, price: 5 });
                    const rows = text.split('\n');
                    rows.forEach(line => {
                        const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                        const code = cols[cfg.code]?.replace(/"/g, '').trim().toUpperCase();
                        if (code && code.length >= 4) {
                            masterDB.set(code, { name: cols[cfg.name]?.replace(/"/g, '').trim() || "ëª…ì¹­ì—†ìŒ", price: parseInt(cols[cfg.price]?.replace(/[^0-9]/g, '')) || 0 });
                        }
                    });
                    updateStatusUI(key, "Local");
                } else {
                    // ì—‘ì…€ ì²˜ë¦¬ (ìˆ˜ê°€ íŒŒì¼) - ìŠ¤ë§ˆíŠ¸ ì¸ì‹ ì—”ì§„ìœ¼ë¡œ ë³´ëƒ„
                    worker.postMessage({ buffer: new Uint8Array(e.target.result), source: key });
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function updateStatusUI(key, status) {
        const srv = document.getElementById('srv-' + key);
        const loc = document.getElementById('loc-' + key);
        if (status === "Server") { srv.innerHTML = `ì„œë²„âœ”`; srv.className = "st-val active-svr"; }
        else if (status === "Local") { loc.innerHTML = `ë¡œì»¬âœ”`; loc.className = "st-val active-loc"; }
        else if (status === "ì„œë²„âŒ") { srv.innerHTML = `ì„œë²„âŒ`; srv.className = "st-val fail-val"; }
        document.getElementById('totalItems').innerText = masterDB.size.toLocaleString();
        if (key === 'bundle') renderOptions();
    }

    // ì²˜ë°© ì„¸íŠ¸ ë¡œì§
    function parseBundle(data) {
        let cur = null, sec = "";
        data.forEach(r => {
            const a = String(r[0]||"").trim(), c = String(r[2]||"").trim();
            if (a.startsWith('+') || a.startsWith('Z')) {
                cur = a; bundles[cur] = { name: String(r[1]||a).trim(), symptoms: [], diags: [], items: [] };
                sec = ""; return;
            }
            if (!cur) return;
            if (c === "ì¦ìƒ") sec = "CC"; else if (c === "ìƒë³‘") sec = "DIAG"; else if (c === "ì²˜ë°©" || c === "ITEM") sec = "ITEM";
            if (sec === "CC" && r[4] && !String(r[4]).includes('PLAN')) bundles[cur].symptoms.push(r[4]);
            else if (sec === "DIAG" && r[3]) bundles[cur].diags.push({ code: r[3], name: r[4] });
            else if (sec === "ITEM" && r[3]) bundles[cur].items.push({ code: String(r[3]||"").toUpperCase(), name: r[4], qty: parseFloat(r[5])||1, isNB: String(r[9]||"").includes('ë¹„ê¸‰ì—¬') });
        });
    }

    function renderOptions() {
        const s = document.getElementById('bundleSelect');
        s.innerHTML = '<option value="">-- ì²˜ë°© ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>' + Object.keys(bundles).sort().map(k => `<option value="${k}">[${k}] ${bundles[k].name}</option>`).join('');
    }

    function loadBundle() {
        const c = document.getElementById('bundleSelect').value; if (!c) return;
        const b = bundles[c]; document.getElementById('resultContent').style.display = 'block';
        document.getElementById('symptomDisplay').innerHTML = b.symptoms.join('<br>') || "ê¸°ë¡ ì—†ìŒ";
        document.getElementById('diagList').innerHTML = b.diags.map(d => `<tr><td style="font-weight:700; color:#0052cc; width:25%">${d.code}</td><td>${d.name}</td></tr>`).join('');
        const list = document.getElementById('itemList');
        list.innerHTML = b.items.map(p => {
            const info = masterDB.get(p.code.trim()) || { price: 0, name: p.name };
            const isInsp = p.code.toLowerCase().includes('sono') || p.code.toLowerCase().includes('c-arm');
            const lock = (p.isNB && !isInsp) ? '' : 'active';
            return `<tr data-type="${p.isNB ? 'nonbenefit' : 'benefit'}">
                <td style="font-weight:700; color:#666;">${p.code}</td>
                <td><input type="text" value="${info.name}" style="border:none; background:transparent;" readonly></td>
                <td><input type="text" class="price" value="${fmt(info.price)}" oninput="this.value=fmt(clean(this.value)); calculate();"></td>
                <td><input type="number" class="qty" value="${p.qty}" step="0.01" oninput="calculate()" style="color:#d73a49; font-weight:800; border:1px solid #eee; border-radius:4px; padding:5px; width:80%;"></td>
                <td style="text-align:center;"><button class="lock-btn ${lock}" onclick="this.classList.toggle('active'); autoBalance();">${lock?'ğŸ”’':'ğŸ”“'}</button></td>
            </tr>`;
        }).join('');
        autoBalance();
    }

    function calculate() {
        let bSum = 0, nbSum = 0;
        document.querySelectorAll('#itemList tr').forEach(r => {
            const p = clean(r.querySelector('.price').value), q = parseFloat(r.querySelector('.qty').value)||0;
            if (r.dataset.type === 'benefit') bSum += p * q; else nbSum += p * q;
        });
        const finalB = Math.floor((bSum * 0.3) / 10) * 10;
        document.getElementById('benefitPay').innerText = fmt(finalB);
        document.getElementById('finalPayment').innerText = fmt(Math.floor((finalB + nbSum) / 10) * 10);
    }

    function autoBalance() {
        const target = clean(document.getElementById('targetPrice').value); calculate();
        const adjs = Array.from(document.querySelectorAll('#itemList tr[data-type="nonbenefit"]')).filter(r => !r.querySelector('.lock-btn').classList.contains('active'));
        if (adjs.length > 0) {
            const first = adjs[0], price = clean(first.querySelector('.price').value);
            if (price > 0) {
                let other = 0;
                document.querySelectorAll('#itemList tr').forEach(r => {
                    if (r !== first && r.dataset.type === 'nonbenefit') other += clean(r.querySelector('.price').value) * (parseFloat(r.querySelector('.qty').value)||0);
                });
                const bPay = clean(document.getElementById('benefitPay').innerText);
                first.querySelector('.qty').value = ((target - bPay - other) / price).toFixed(4);
            }
        }
        calculate();
    }
    window.onload = init;
</script>
</body>
</html>
