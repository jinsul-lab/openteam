<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINSUL - Auto Sync System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #333; --accent: #d73a49; --border: rgba(0, 0, 0, 0.1); }
        body { margin: 0; background-color: #ffffff; color: #333; font-family: 'Pretendard', sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        /* [UI] ì‚¬ìš©ì ì œê³µ í†µí•© ì‹±í¬ ë³´ë“œ UI ì ìš© */
        #syncBoard { position: fixed; top: 10px; right: 20px; background: #fff; border: 1px solid #222; border-radius: 10px; padding: 12px 18px; font-size: 11px; z-index: 1000; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 420px; }
        .sync-list { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .sync-item { display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; background: #ccc; }
        .dot-ok { background: #28a745; }
        .dot-fail { background: #dc3545; }
        .tag-name { font-weight: 800; color: #666; }
        .st-val { font-weight: 600; padding: 1px 4px; border-radius: 3px; font-size: 9px; }
        .active-svr { color: #007bff; }
        .fail-val { color: #dc3545; }

        .container { width: 1200px; max-width: 95%; margin: 0 auto; display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 40px; padding-bottom: 100px; }
        .card { background: rgba(255, 255, 255, 0); border: 1px solid var(--border); border-radius: 12px; padding: 35px; backdrop-filter: blur(1px); margin-bottom: 30px; }
        .section-title { font-size: 0.85em; font-weight: 800; color: #999; margin: 30px 0 15px 0; border-left: 3px solid #333; padding-left: 12px; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; }
        th { border-bottom: 2px solid #eee; padding: 15px 10px; text-align: left; font-size: 0.8em; color: #aaa; }
        td { padding: 15px 10px; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .target-input { font-size: 3.5em; width: 240px; background: none; border: none; border-bottom: 4px solid #333; color: #333; text-align: right; font-weight: 900; outline: none; }
        .lock-btn { background: none; border: none; font-size: 1.3em; cursor: pointer; opacity: 0.2; }
        .lock-btn.active { opacity: 1; color: var(--accent); }
        input[type="text"], input[type="number"] { background: rgba(0,0,0,0.02); border: 1px solid #ddd; border-radius: 6px; padding: 6px 10px; outline: none; width: 100%; }
        #loader { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; transition: 0.5s; }
    </style>
</head>
<body>

<div id="syncBoard">
    <div class="sync-list">
        <div class="sync-item"><span id="dot-fee" class="status-dot"></span><span class="tag-name">ì˜ì¹˜ê³¼ìˆ˜ê°€</span> <span id="st-fee" class="st-val">WAIT</span></div>
        <div class="sync-item"><span id="dot-drug" class="status-dot"></span><span class="tag-name">ì•½ê°€</span> <span id="st-drug" class="st-val">WAIT</span></div>
        <div class="sync-item"><span id="dot-mat" class="status-dot"></span><span class="tag-name">ì¹˜ë£Œì¬ë£ŒëŒ€</span> <span id="st-mat" class="st-val">WAIT</span></div>
        <div class="sync-item"><span id="dot-bundle" class="status-dot"></span><span class="tag-name">ì²˜ë°©ì„¸íŠ¸</span> <span id="st-bundle" class="st-val">WAIT</span></div>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
        <span style="font-weight: 800; color: #888;">TOTAL DB: <span id="totalItems" style="color:#333;">0</span></span>
        <span style="font-size: 9px; color: #aaa;">GITHUB AUTO MODE</span>
    </div>
</div>

<div id="loader">
    <div style="font-weight: 900; font-size: 1.8em; color: #333; letter-spacing: 5px;">JINSUL MEGA ENGINE (AUTO)</div>
    <div id="statusText" style="font-size: 0.9em; color: #888; margin-top: 20px;">ì„œë²„ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>

<header style="padding: 40px 0; text-align: center;">
    <img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" style="width: 220px; opacity: 0.8;">
</header>

<div class="container">
    <div class="main-column">
        <div class="card">
            <div style="display: flex; gap: 12px; margin-bottom: 35px;">
                <select id="bundleSelect" style="flex: 1; font-weight: 700; font-size: 1.1em; border: 2px solid #333; border-radius: 8px; padding: 12px;"></select>
                <button onclick="loadBundle()" style="padding:15px 30px; border-radius:10px; border:1px solid #ddd; font-weight:700; cursor:pointer; background:#fff;">ì¡°íšŒí•˜ê¸°</button>
            </div>
            <div id="resultContent" style="display:none;">
                <div class="section-title">Chief Complaint</div>
                <div id="symptomDisplay" style="padding:25px; background:rgba(0,0,0,0.02); border-radius:12px; line-height:1.8; margin-bottom:30px;"></div>
                <div class="section-title">Prescription / ì—­ì‚°</div>
                <table>
                    <thead><tr><th style="width:18%">ì½”ë“œ</th><th>í•­ëª©ëª…</th><th style="width:22%">ë‹¨ê°€</th><th style="width:12%">ìˆ˜ëŸ‰</th><th style="width:8%">ì ê¸ˆ</th></tr></thead>
                    <tbody id="itemList"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="side-column">
        <div class="card" style="background: rgba(0, 0, 0, 0.03); text-align: center; padding: 45px;">
            <div style="font-size: 0.85em; color: #888; margin-bottom: 12px; font-weight: 600;">TARGET AMOUNT</div>
            <input type="number" id="targetPrice" class="target-input" value="89000" oninput="autoBalance()"> ì›
        </div>
        <div class="card" style="text-align: center; margin-top: 30px; border-top: 6px solid #333;">
            <div id="finalPayment" style="font-size: 3.8em; font-weight: 900; color: #333;">0</div>
            <div style="margin-top:20px; font-size:1.1em; color:#888;">ë³¸ì¸ë¶€ë‹´ê¸ˆ: <span id="benefitPay" style="font-weight:700; color:#333;">0</span>ì›</div>
        </div>
    </div>
</div>

<script>
    const REPO = "https://raw.githubusercontent.com/jinsul-lab/openteam/main/";
    const CONFIG = {
        'fee': { file: "ì˜ì¹˜ê³¼ìˆ˜ê°€.csv", code: 0, name: 3, price: 7 },
        'drug': { file: "ì•½ê°€.csv", code: 0, name: 6, price: 3 },
        'mat': { file: "ì¹˜ë£Œì¬ë£ŒëŒ€.csv", code: 0, name: 2, price: 5 }
    };
    let masterDB = new Map(), bundles = {}, loadedCount = 0;

    const fmt = (v) => Number(v || 0).toLocaleString();
    const clean = (v) => parseFloat(String(v).replace(/,/g, '')) || 0;

    async function init() {
        for (const [key, cfg] of Object.entries(CONFIG)) fetchSource(REPO + encodeURIComponent(cfg.file), cfg, key);
        fetch(REPO + "ì²˜ë°©ì„¸íŠ¸.xls").then(res => res.arrayBuffer()).then(buffer => {
            const workbook = XLSX.read(new Uint8Array(buffer), { type: 'array' });
            const count = parseBundle(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 }));
            updateStatus('bundle', count > 0 ? "Server" : "ì„œë²„X");
        }).catch(() => updateStatus('bundle', "ì„œë²„X"));
    }

    async function fetchSource(url, cfg, key) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error();
            const buffer = await res.arrayBuffer();
            let text;
            try { text = new TextDecoder('utf-8', { fatal: true }).decode(buffer); } 
            catch { text = new TextDecoder('euc-kr').decode(buffer); }
            const count = parseCSV(text, cfg);
            // ìë£Œê°€ 0ê±´ì´ë©´ ì„œë²„Xë¡œ í‘œê¸°
            updateStatus(key, count > 0 ? "Server" : "ì„œë²„X");
        } catch { updateStatus(key, "ì„œë²„X"); }
    }

    function parseCSV(text, cfg) {
        const rows = text.split('\n');
        let count = 0;
        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
            const code = cols[cfg.code]?.replace(/"/g, '').trim().toUpperCase();
            if (code) {
                const price = parseInt(cols[cfg.price]?.replace(/"/g, '').replace(/[^0-9]/g, '')) || 0;
                masterDB.set(code, { name: cols[cfg.name]?.replace(/"/g, '').trim() || "ëª…ì¹­ì—†ìŒ", price: price });
                count++;
            }
        }
        return count;
    }

    function updateStatus(key, status) {
        const el = document.getElementById('st-' + key), dot = document.getElementById('dot-' + key);
        if (!el || !dot) return;
        el.innerText = status;
        if (status === "ì„œë²„X") { el.className = "st-val fail-val"; dot.className = "status-dot dot-fail"; }
        else { el.className = "st-val active-svr"; dot.className = "status-dot dot-ok"; loadedCount++; }
        document.getElementById('totalItems').innerText = masterDB.size.toLocaleString();
        if (loadedCount >= 4 || masterDB.size > 0) {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => { document.getElementById('loader').style.display = 'none'; renderOptions(); }, 500);
        }
    }

    function parseBundle(data) {
        let cur = null, sec = "", count = 0;
        data.forEach(r => {
            const a = String(r[0]||"").trim(), c = String(r[2]||"").trim();
            if (a.startsWith('+') || a.startsWith('Z')) {
                cur = a; bundles[cur] = { name: String(r[1]||a).trim(), symptoms: [], items: [] };
                sec = ""; count++; return;
            }
            if (!cur) return;
            if (c === "ì¦ìƒ") sec = "CC"; else if (c === "ì²˜ë°©") sec = "ITEM";
            if (sec === "CC" && r[4] && !String(r[4]).includes('PLAN')) bundles[cur].symptoms.push(r[4]);
            else if (sec === "ITEM" && r[3]) bundles[cur].items.push({ code: String(r[3]).toUpperCase(), name: r[4], qty: parseFloat(r[5])||1, isNB: String(r[9]||"").includes('ë¹„ê¸‰ì—¬') });
        });
        return count;
    }

    function renderOptions() {
        const s = document.getElementById('bundleSelect');
        s.innerHTML = '<option value="">-- ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>' + Object.keys(bundles).sort().map(k => `<option value="${k}">[${k}] ${bundles[k].name}</option>`).join('');
    }

    function loadBundle() {
        const c = document.getElementById('bundleSelect').value; if (!c) return;
        const b = bundles[c]; document.getElementById('resultContent').style.display = 'block';
        document.getElementById('symptomDisplay').innerHTML = b.symptoms.join('<br>') || "ê¸°ë¡ ì—†ìŒ";
        const list = document.getElementById('itemList');
        list.innerHTML = b.items.map(p => {
            const info = masterDB.get(p.code.trim()) || { price: 0, name: p.name };
            const isInsp = p.code.toLowerCase().includes('sono') || p.code.toLowerCase().includes('c-arm');
            const lock = (p.isNB && !isInsp) ? '' : 'active';
            return `<tr data-type="${p.isNB ? 'nonbenefit' : 'benefit'}">
                <td style="font-weight:700; color:#666;">${p.code}</td>
                <td><input type="text" value="${info.name}" style="border:none; background:transparent;" readonly></td>
                <td><input type="text" class="price" value="${fmt(info.price)}" oninput="this.value=fmt(clean(this.value)); calculate();"></td>
                <td><input type="number" class="qty" value="${p.qty}" step="0.01" oninput="calculate()"></td>
                <td><button class="lock-btn ${lock}" onclick="this.classList.toggle('active'); autoBalance();">${lock?'ğŸ”’':'ğŸ”“'}</button></td>
            </tr>`;
        }).join('');
        autoBalance();
    }

    function calculate() {
        let bSum = 0, nbSum = 0;
        document.querySelectorAll('#itemList tr').forEach(r => {
            const p = clean(r.querySelector('.price').value), q = parseFloat(r.querySelector('.qty').value)||0;
            if (r.dataset.type === 'benefit') bSum += p * q; else nbSum += p * q;
        });
        const finalB = Math.floor((bSum * 0.3) / 10) * 10;
        document.getElementById('benefitPay').innerText = fmt(finalB);
        document.getElementById('finalPayment').innerText = fmt(Math.floor((finalB + nbSum) / 100 * 100));
    }

    function autoBalance() {
        const target = clean(document.getElementById('targetPrice').value);
        calculate();
        const adjs = Array.from(document.querySelectorAll('#itemList tr[data-type="nonbenefit"]')).filter(r => !r.querySelector('.lock-btn').classList.contains('active'));
        if (adjs.length > 0) {
            const first = adjs[0], price = clean(first.querySelector('.price').value);
            if (price > 0) {
                let other = 0;
                document.querySelectorAll('#itemList tr').forEach(r => {
                    if (r === first) return;
                    const p = clean(r.querySelector('.price').value), q = parseFloat(r.querySelector('.qty').value)||0;
                    if (r.dataset.type === 'nonbenefit') other += p * q;
                });
                const bPay = clean(document.getElementById('benefitPay').innerText);
                first.querySelector('.qty').value = ((target - bPay - other) / price).toFixed(4);
            }
        }
        calculate();
    }
    window.onload = init;
</script>
</body>
</html>
