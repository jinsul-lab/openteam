<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINSUL - Case Verification System</title>
    <style>
        :root { --primary: #333; --accent: #d73a49; --border: #eee; --blue: #0052cc; --bg: #f6f6f7; }
        body { margin: 0; background-color: var(--bg); color: var(--primary); font-family: 'Pretendard', sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        .wm { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 0; }
        .wm img { width: min(760px, 78vw); opacity: .20; filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05); }

        header { width: 100%; padding: 25px 0; text-align: center; position: relative; z-index: 1; }
        .top-logo { width: 170px; filter: grayscale(1) brightness(.45) contrast(1.15); opacity: 0.8; }
        
        #syncBoard { position: absolute; top: 10px; right: 20px; background: rgba(255,255,255,0.8); border: 1px solid #222; border-radius: 8px; padding: 12px 18px; font-size: 12px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 240px; backdrop-filter: blur(5px); }
        .sync-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .sync-row:last-child { margin-bottom: 0; }
        .sync-label { color: #555; font-weight: 700; }
        .sync-val { font-weight: 800; color: #333; }

        .container { width: 1550px; max-width: 98%; margin: 0 auto; display: grid; grid-template-columns: 1.75fr 1.25fr; gap: 25px; padding-bottom: 80px; position: relative; z-index: 1; flex: 1; }
        
        .card { 
            background: rgba(255, 255, 255, 0.2); 
            border: 1px solid rgba(0,0,0,0.08); 
            border-radius: 12px; 
            padding: 25px; 
            backdrop-filter: blur(2px); 
            margin-bottom: 20px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.02); 
        }
        
        .section-title { font-size: 0.95em; font-weight: 800; color: #555; margin: 0 0 12px 0; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        .consult-group { display: flex; gap: 8px; margin-bottom: 20px; }
        .c-btn { flex: 1; padding: 12px; border: 1px solid rgba(0,0,0,0.2); border-radius: 8px; background: rgba(255,255,255,0.4); cursor: pointer; font-weight: 800; font-size: 13px; color: #444; transition: 0.2s; }
        .c-btn:hover { background: rgba(255,255,255,0.6); }
        .c-btn.active { border-color: var(--primary); background: var(--primary); color: #fff; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { 
            padding: 10px 10px; 
            text-align: left; 
            font-size: 0.8em; 
            color: #666; 
            text-transform: uppercase; 
            border-bottom: 2px solid rgba(0,0,0,0.1); 
            background: transparent !important; 
        }
        td { 
            padding: 12px 10px; 
            background: transparent !important; 
            font-size: 0.95em; 
            font-weight: 600; 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
        }
        
        .name-cell-group {
            display: flex;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.25); 
            border-radius: 4px;
            padding: 2px 8px;
            background: transparent;
            transition: 0.2s;
        }
        .name-cell-group:focus-within {
            border-color: var(--blue);
            background: rgba(255,255,255,0.15);
        }

        .box-input-name {
            border: none;
            background: transparent !important;
            padding: 6px 0;
            font-weight: 800;
            font-family: inherit;
            outline: none;
            font-size: 13px;
            flex: 1; 
            color: #333;
            min-width: 50px;
        }

        .box-input-num { 
            border: 1px solid rgba(0,0,0,0.25); 
            border-radius: 4px; 
            background: transparent !important; 
            padding: 6px; 
            font-weight: 800; 
            font-family: inherit; 
            outline: none; 
            font-size: 13px; 
            width: 100%;
            transition: 0.2s;
            color: #333;
        }
        .box-input-num:focus { border-color: var(--blue); background: rgba(255,255,255,0.2) !important; }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            border-radius: 6px;
            font-weight: 900;
            margin-left: 8px;
            white-space: nowrap;
            letter-spacing: -0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .badge-req { background: #ffeef0; color: #d73a49; border: 1px solid #ffcbd1; } 
        .badge-con { background: #f1f8ff; color: #0052cc; border: 1px solid #cce3ff; }

        .p-input { width: 90px; text-align: right; color: #333; }
        .q-input { width: 60px; text-align: center; color: var(--accent); }

        .diag-table { width: 100%; margin-bottom: 30px; }
        .diag-table td { background: transparent !important; border-bottom: 1px dashed rgba(0,0,0,0.1); color: #444; }
        .diag-code { font-weight: 800; color: var(--blue); }

        #setSel { background: rgba(255,255,255,0.3); border: 2px solid rgba(0,0,0,0.2); }

        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); }
        .summary-label { font-size: 13px; font-weight: 700; color: #666; }
        .summary-val { font-size: 16px; font-weight: 900; color: #333; }
        
        .target-input { font-size: 2.2em; width: 180px; background: none; border: none; border-bottom: 3px solid var(--primary); color: var(--primary); text-align: right; font-weight: 900; outline: none; }
        #finalPay { font-size: 3.2em; font-weight: 900; color: var(--accent); letter-spacing: -2px; line-height: 1; }

        .matrix-container { display: grid; grid-template-columns: repeat(1, 1fr); gap: 6px; margin-top: 15px; }
        .matrix-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: rgba(255,255,255,0.4); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .matrix-row:hover { background: rgba(240, 247, 255, 0.6); border-color: var(--blue); transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .matrix-target { font-weight: 800; color: #555; }
        .matrix-val { font-weight: 900; color: var(--blue); font-size: 13px; }

        .lock-btn, .carry-btn { background: none; border: none; font-size: 1.1em; cursor: pointer; opacity: 0.3; transition: 0.2s; }
        .lock-btn.active { opacity: 1; color: var(--accent); }
        .carry-btn.active { opacity: 1; color: var(--blue); }
        
        /* [ìˆ˜ì •] ì‚­ì œ ë²„íŠ¼ ë””ìì¸: íˆ¬ëª…ë„ ì œê±°, ê¸°ë³¸ì ìœ¼ë¡œ ì˜ ë³´ì´ê²Œ ì„¤ì • */
        .del-btn { 
            background: none; 
            border: none; 
            font-size: 1.1em; 
            cursor: pointer; 
            opacity: 1; /* íˆ¬ëª…ë„ 100% (ì™„ì „ ë¶ˆíˆ¬ëª…) */
            transition: 0.2s; 
            color: #888; /* ê¸°ë³¸ì€ íšŒìƒ‰ */
        } 
        .del-btn:hover { 
            color: #d73a49; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë¹¨ê°„ìƒ‰ */
            transform: scale(1.15); 
        }

        #searchLayer { position: absolute; width: 100%; top: 55px; background: rgba(255,255,255,0.95); z-index: 100; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display:none; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; }
        .search-item { padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; }
        .search-item:hover { background: #f5f5f5; }

        .alert-box { 
            padding: 12px 15px; border-radius: 8px; font-weight: 800; font-size: 13px; margin-bottom: 15px; 
            display: none; border: 1px solid transparent; 
        }
        .alert-red { background: rgba(255, 240, 241, 0.7); color: #d73a49; border-color: #d73a49; }
        .alert-orange { background: rgba(255, 248, 230, 0.7); color: #b7791f; border-color: #b7791f; }

        footer { width: 100%; text-align: center; padding: 50px 0; font-size: 12px; color: #888; background: transparent; font-weight: 600; }
    </style>
</head>
<body onclick="closeSearch(event)">

<div class="wm"><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png"></div>

<div id="syncBoard">
    <div class="sync-row"><span class="sync-label">ìˆ˜ê°€ ì ìš©ì¼ì</span><span id="st-date" class="sync-val">-</span></div>
    <div class="sync-row"><span class="sync-label">ë°ì´í„° ëˆ„ì ìˆ˜</span><span id="st-db" class="sync-val">...</span></div>
</div>

<header><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo"></header>

<div class="container">
    <div class="main-column">
        <div class="card">
            <div class="section-title">ì§„ì°°ë£Œ ì‚°ì •</div>
            <div class="consult-group">
                <button onclick="setConsult('first')" id="btn-first" class="c-btn">ì´ˆì§„</button>
                <button onclick="setConsult('follow')" id="btn-follow" class="c-btn">ì¬ì§„</button>
                <button onclick="setConsult('none')" id="btn-none" class="c-btn active">ì‚°ì • ì•ˆí•¨</button>
            </div>

            <div class="section-title">ì½”ë“œ ì„ íƒ</div>
            <select id="setSel" style="width:100%; font-weight:800; font-size:1.1em; border:2px solid rgba(0,0,0,0.2); border-radius:8px; padding:12px; outline:none; cursor:pointer;" onchange="changeSet()"></select>
            
            <div id="dataView" style="display:none; margin-top:30px;">
                <div class="section-title">í™˜ì ì¦ìƒ (C.C)</div>
                <div id="ccContent" style="padding:15px; background:rgba(0,0,0,0.05); border-radius:8px; font-size:0.95em; line-height:1.6; margin-bottom:30px; border-left: 0px solid #999; min-height:20px; font-weight: 600;"></div>

                <div id="diagSection" style="display:none;">
                    <div class="section-title" style="border-left-color: var(--blue); color:var(--blue);">ìƒë³‘ ë‚´ì—­</div>
                    <table class="diag-table">
                        <thead><tr><th style="width:20%">ìƒë³‘ì½”ë“œ</th><th>ìƒë³‘ëª…ì¹­</th></tr></thead>
                        <tbody id="diagList"></tbody>
                    </table>
                </div>
                
                <div class="section-title">ì²˜ë°© ë‚´ì—­ / ë¹„ê¸‰ì—¬ ì¡°ì •</div>
                <div id="mainAlertBox" class="alert-box"></div>

                <table>
                    <thead>
                        <tr>
                            <th style="width:15%">ì²˜ë°©ì½”ë“œ</th>
                            <th>ì²˜ë°©ëª…ì¹­</th>
                            <th style="width:18%; text-align:right;">ë‹¨ê°€</th>
                            <th style="width:12%; text-align:center;">ìˆ˜ëŸ‰</th>
                            <th style="width:6%; text-align:center;">ì ê¸ˆ</th>
                            <th style="width:6%; text-align:center;">ìœ ì§€</th>
                            <th style="width:6%; text-align:center;">ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="itemList"></tbody>
                </table>

                <div style="margin-top:20px; display:flex; gap:10px; position:relative;" id="searchBox">
                    <input type="text" id="searchInput" placeholder="ëª…ì¹­ ë˜ëŠ” ì½”ë“œë¡œ ì²˜ë°© ê²€ìƒ‰" 
                           style="flex:1; padding:12px; border-radius:8px; border:2px solid rgba(0,0,0,0.2); font-weight:800; outline:none; font-size: 13px; background: rgba(255,255,255,0.3);"
                           oninput="searchLive(this.value)" onkeydown="if(event.key==='Escape') clearSearch()">
                    <button onclick="addManualItem()" style="padding:0 20px; background:rgba(255,255,255,0.5); border:2px solid var(--primary); border-radius:8px; font-weight:800; cursor:pointer; font-size:12px;">+ ì„ì˜ ì¶”ê°€</button>
                    <div id="searchLayer"></div>
                </div>

                <button onclick="autoBalance()" style="background:var(--primary); color:white; width:100%; padding:18px; border:none; border-radius:10px; font-weight:900; margin-top:30px; cursor:pointer; font-size:1.05em; letter-spacing: 1px;">ê³„ì‚°</button>
            </div>
        </div>
    </div>

    <div class="side-column">
        <div class="card" style="background: rgba(255, 255, 255, 0.1); text-align: center; padding: 30px 20px;">
            <div style="font-size: 0.85em; color: #666; margin-bottom: 10px; font-weight: 800; letter-spacing: 1px;">ëª©í‘œê°€</div>
            <div>
                <input type="number" id="tAmt" class="target-input" value="89000" oninput="autoBalance()"> <span style="font-size: 1.2em; font-weight: 900;">ì›</span>
            </div>
        </div>

        <div class="card" style="border-top: 6px solid var(--primary);">
            <div class="summary-row"><span class="summary-label">ì´ ì§„ë£Œë¹„ í•©ê³„</span><span id="totalFull" class="summary-val">0</span></div>
            <div class="summary-row"><span class="summary-label">ê¸‰ì—¬ (ë³¸ì¸ë¶€ë‹´ 30%)</span><span id="summaryBenefit" class="summary-val">0</span></div>
            <div class="summary-row" style="border-bottom:none;"><span class="summary-label">ë¹„ê¸‰ì—¬ (100% ì „ì•¡)</span><span id="summaryNonBenefit" class="summary-val" style="color:var(--blue);">0</span></div>
            
            <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(0,0,0,0.1);">
                <div style="font-size: 12px; color: #777; font-weight: 800; margin-bottom: 8px;">ìµœì¢… ì‹¤ì œ ìˆ˜ë‚©ì•¡</div>
                <div id="finalPay">0</div>
            </div>

            <div class="section-title" style="margin-top:40px; border-left-color: var(--blue);">ê¸ˆì•¡ë³„ ì¡°ì • (Matrix)</div>
            <div id="matrixAdjustName" style="font-size:11px; color:var(--blue); font-weight:800; margin-bottom:10px; text-align:right;">-</div>
            <div id="matrixTable" class="matrix-container"></div>
        </div>
    </div>
</div>

<footer>Â© JINSUL Â· ê²½í—˜ê³¼ ê°€ì¹˜ë¥¼ í˜„ì‹¤í™”í•˜ëŠ” ì»¨ì„¤íŒ…</footer>

<script>
    let DB = { fee: {}, drug: {}, mat: {}, sets: {}, dates: { fee: "-", drug: "-", mat: "-" } };
    let flatDB = [];
    let carryOverItems = new Map();
    let currentCustomItems = []; 
    let deletedSetItems = new Set();
    const STRATEGY_DRUGS = ["ë¹„ì— íˆë£¨ë‹ˆë‹¤ì œ", "ë§ë¦°ë‹¤ì£¼", "ë¦¬í¬ë¼ì œì£¼"];
    const CONTRAST_REQUIRED_CODES = ["LA354", "LA359", "LA253", "LA355", "LA352"];
    const CONTRAST_KEYWORDS = [
        "ì¡°ì˜", "OMNI", "VISI", "IOP", "HEX", "BONO", "CONTRAST", 
        "ì˜´ë‹ˆ", "ìš¸íŠ¸ë¼", "ê°€ë„", "íŒŒë¯¸", "ë¹„ì§€", "ì´ì˜¤", "í—¥ì‚¬", "ë³´ë…¸", "ë„íƒ€", "ê²Œë„¤", "ì„¼ìŠ¤", "íŒŒí", "ìœ ë‹ˆ", "ë§ˆê·¸ë„¤", "í´ë¼ë¦¬"
    ];
    
    let CONSULT_PRICES = { first: 0, follow: 0 };
    let currentConsult = "none";

    const fmt = n => Math.floor(n || 0).toLocaleString();
    const clean = n => parseFloat(String(n).replace(/,/g, '')) || 0;

    async function init() {
        try {
            const res = await fetch("https://raw.githubusercontent.com/jinsul-lab/openteam/main/database.json?t=" + Date.now());
            DB = await res.json();
            
            let displayDate = "2026-01-01";
            if (DB.dates && DB.dates.fee && DB.dates.fee !== "-") displayDate = DB.dates.fee;
            document.getElementById('st-date').innerText = displayDate;

            const feeFirst = getFeePrice('AA154') || 17610;
            const feeFollow = getFeePrice('AA254') || 12590;
            CONSULT_PRICES = { first: feeFirst, follow: feeFollow };
            document.getElementById('btn-first').innerText = `ì´ˆì§„ (${fmt(feeFirst)})`;
            document.getElementById('btn-follow').innerText = `ì¬ì§„ (${fmt(feeFollow)})`;

            for(let cat in DB) {
                if(['sets', 'dates'].includes(cat)) continue;
                for(let code in DB[cat]) flatDB.push({ code, name: DB[cat][code][0], price: DB[cat][code][1] });
            }
            document.getElementById('st-db').innerText = fmt(flatDB.length) + "ê±´";
            document.getElementById('setSel').innerHTML = '<option value="">-- ì²˜ë°© ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>' + 
                Object.keys(DB.sets).sort().map(k => `<option value="${k}">[${k}] ${DB.sets[k].n}</option>`).join('');
        } catch(e) { console.error("DB ë¡œë“œ ì‹¤íŒ¨"); }
    }

    function getFeePrice(code) {
        if(DB.fee && DB.fee[code]) return DB.fee[code][1];
        if(DB.fee) { const key = Object.keys(DB.fee).find(k => k.startsWith(code)); if(key) return DB.fee[key][1]; }
        return 0;
    }

    function setTarget(val) { document.getElementById('tAmt').value = val; autoBalance(); }
    
    function changeSet() { 
        currentCustomItems = []; 
        deletedSetItems.clear(); 
        renderItems(); 
    }
    
    function setConsult(type) {
        currentConsult = type;
        document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + type).classList.add('active');
        renderItems();
    }

    function searchLive(val) {
        const layer = document.getElementById('searchLayer');
        if(!val || val.length < 2) { layer.style.display = 'none'; return; }
        const filtered = flatDB.filter(i => i.code.includes(val.toUpperCase()) || i.name.includes(val)).slice(0, 50);
        layer.innerHTML = filtered.map(i => `
            <div class="search-item" onclick="addSearchedItem('${i.code}', '${i.name.replace(/'/g, "\\'")}', ${i.price})">
                <span style="color:#0052cc; font-weight:800;">${i.code}</span>
                <span style="margin:0 10px; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${i.name}</span>
                <span style="font-weight:800;">${fmt(i.price)}ì›</span>
            </div>`).join('');
        layer.style.display = filtered.length ? 'block' : 'none';
    }

    function clearSearch() { document.getElementById('searchLayer').style.display = 'none'; document.getElementById('searchInput').value = ''; }
    function closeSearch(e) { if (!document.getElementById('searchBox').contains(e.target)) clearSearch(); }
    
    function addSearchedItem(code, name, price) {
        let finalPrice = price; if (STRATEGY_DRUGS.some(sd => name.includes(sd))) finalPrice = 100000;
        currentCustomItems.push({ code, name, price: finalPrice, q: 1, nb: true, lock: false, isManual: false });
        clearSearch(); renderItems();
    }
    
    function addManualItem() { 
        currentCustomItems.push({ code: "ETC", name: "ì„ì˜ í•­ëª©", price: 0, q: 1, nb: true, lock: false, isManual: true }); 
        renderItems(); 
    }

    function renderItems() {
        const key = document.getElementById('setSel').value;
        if(!key) return;
        const set = DB.sets[key];
        document.getElementById('dataView').style.display = 'block';
        
        document.getElementById('ccContent').innerHTML = (set.cc && set.cc.length > 0) ? set.cc.join('<br>') : "ë“±ë¡ëœ ì¦ìƒ ì—†ìŒ";
        
        const diagList = set.dg || [];
        const diagSection = document.getElementById('diagSection');
        const diagTbody = document.getElementById('diagList');
        diagTbody.innerHTML = '';
        
        if (diagList.length > 0) {
            diagSection.style.display = 'block';
            diagList.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="diag-code">${d.c}</td><td>${d.n}</td>`;
                diagTbody.appendChild(tr);
            });
        } else {
            diagSection.style.display = 'none';
        }

        const tbody = document.getElementById('itemList');
        tbody.innerHTML = '';
        
        if(currentConsult !== "none") {
            const price = CONSULT_PRICES[currentConsult];
            const name = currentConsult === 'first' ? "ì§„ì°°ë£Œ(ì´ˆì§„)" : "ì§„ì°°ë£Œ(ì¬ì§„)";
            addRow(tbody, "CONST", name, price, 1, false, true, false);
        }

        set.it.forEach(item => {
            const code = item.c.toUpperCase();
            if (deletedSetItems.has(code)) return; 

            if (carryOverItems.has(code)) {
                const c = carryOverItems.get(code);
                addRow(tbody, code, c.name, c.price, c.q, c.nb, c.lock, true);
            } else {
                const info = DB.fee[code] || DB.drug[code] || DB.mat[code] || null;
                let name = info ? info[0] : (item.n || code);
                let price = info ? info[1] : 0;
                if (STRATEGY_DRUGS.some(sd => name.includes(sd))) price = 100000;
                addRow(tbody, code, name, price, item.q, item.nb, !item.nb || code.includes('SONO') || code.includes('C-ARM'), false);
            }
        });

        currentCustomItems.forEach((item, idx) => {
            if (carryOverItems.has(item.code)) return;
            if (item.isDeleted) return; 
            addRow(tbody, item.code, item.name, item.price, item.q, item.nb, item.lock, false, true, idx);
        });

        carryOverItems.forEach((c, code) => {
            const exists = Array.from(tbody.rows).some(r => r.cells[0].innerText === code);
            if (!exists) addRow(tbody, code, c.name, c.price, c.q, c.nb, c.lock, true);
        });

        autoBalance();
    }

    function addRow(target, code, name, price, qty, isNB, isLocked, isCarry, isCustom = false, customIdx = null) {
        const tr = document.createElement('tr');
        tr.dataset.type = isNB ? 'nb' : 'b';
        tr.dataset.code = code;

        let nameHtml = `<div class="name-cell-group"><input class="box-input-name" value="${name}" ${isCustom && currentCustomItems[customIdx].isManual ? '' : 'readonly'} oninput="if(${isCustom}) currentCustomItems[${customIdx}].name=this.value">`;
        
        if (CONTRAST_REQUIRED_CODES.includes(code)) {
            nameHtml += `<span class="badge badge-req">ì¡°ì˜í•„ìš”</span>`;
        }
        const upperName = name.toUpperCase();
        if (CONTRAST_KEYWORDS.some(k => upperName.includes(k))) {
            nameHtml += `<span class="badge badge-con">ì¡°ì˜ì œ</span>`;
        }
        nameHtml += `</div><div class="audit-msg" style="color:var(--accent); font-size:11px; font-weight:800; margin-top:2px;"></div>`;

        tr.innerHTML = `
            <td style="color:#666; font-weight:800; font-size:11px;">${code}</td>
            <td>${nameHtml}</td>
            <td align="right"><input class="box-input-num p-input" value="${fmt(price)}" oninput="syncRow(this, '${code}', ${isCustom}, ${customIdx})"></td>
            <td align="center"><input class="box-input-num q-input" type="number" value="${qty}" step="0.1" oninput="syncRow(this, '${code}', ${isCustom}, ${customIdx})"></td>
            <td align="center"><button class="lock-btn ${isLocked?'active':''}" onclick="toggleLock(this, '${code}', ${isCustom}, ${customIdx})">ğŸ”’</button></td>
            <td align="center"><button class="carry-btn ${isCarry?'active':''}" onclick="toggleCarry(this, '${code}')">ğŸ“Œ</button></td>
            <td align="center"><button class="del-btn" onclick="deleteRow(this, '${code}', ${isCustom}, ${customIdx})">ğŸ—‘ï¸</button></td>
        `;
        target.appendChild(tr);
    }

    function deleteRow(btn, code, isCustom, idx) {
        if (carryOverItems.has(code)) carryOverItems.delete(code);
        if (isCustom && idx !== null) { currentCustomItems.splice(idx, 1); } 
        else { deletedSetItems.add(code); }
        renderItems(); 
    }

    function syncRow(el, code, isCustom, idx) {
        const tr = el.closest('tr');
        const p = clean(tr.querySelector('.p-input').value);
        const q = parseFloat(tr.querySelector('.q-input').value) || 0;
        const lock = tr.querySelector('.lock-btn').classList.contains('active');
        if (carryOverItems.has(code)) { const c = carryOverItems.get(code); c.price = p; c.q = q; c.lock = lock; }
        if (isCustom && idx !== null) { currentCustomItems[idx].price = p; currentCustomItems[idx].q = q; }
        if (el.classList.contains('p-input')) el.value = fmt(p);
        autoBalance();
    }

    function toggleLock(btn, code, isCustom, idx) {
        btn.classList.toggle('active');
        if (isCustom && idx !== null) currentCustomItems[idx].lock = btn.classList.contains('active');
        autoBalance();
    }
    function toggleCarry(btn, code) {
        const tr = btn.closest('tr');
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) {
            carryOverItems.set(code, { 
                name: tr.cells[1].querySelector('input').value, 
                price: clean(tr.querySelector('.p-input').value), 
                q: parseFloat(tr.querySelector('.q-input').value) || 0, 
                nb: tr.dataset.type === 'nb', 
                lock: tr.querySelector('.lock-btn').classList.contains('active') 
            });
        } else { carryOverItems.delete(code); }
    }

    function calc() {
        let bSum = 0, nbSum = 0, laSum = 0;
        let hasContrast = false;
        let needsContrastCode = null;

        document.querySelectorAll('#itemList tr').forEach(tr => {
            const name = tr.cells[1].querySelector('input').value.toUpperCase();
            if (CONTRAST_KEYWORDS.some(k => name.includes(k))) hasContrast = true;
        });

        document.querySelectorAll('#itemList tr').forEach(tr => {
            const code = tr.dataset.code || "";
            const name = tr.cells[1].querySelector('input').value;
            const p = clean(tr.querySelector('.p-input').value);
            const q = parseFloat(tr.querySelector('.q-input').value) || 0;
            const msgBox = tr.querySelector('.audit-msg');
            msgBox.innerText = ""; 

            if (code.startsWith('LA')) {
                laSum += q;
                if (code === 'LA357' && q > 1.5) msgBox.innerText = "âš ï¸ LA357 1.5 ì´ˆê³¼";
            }

            if (CONTRAST_REQUIRED_CODES.includes(code) && !hasContrast) {
                needsContrastCode = code;
            }

            if(tr.dataset.type === 'b') bSum += (p * q); else nbSum += (p * q);
        });

        const alertBox = document.getElementById('mainAlertBox');
        let alerts = [];
        if (laSum > 3.0) alerts.push("âš ï¸ ì°¨ë‹¨ìˆ  ì´ í•©ê³„ê°€ 3.0ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (ì‚­ê° ì£¼ì˜)");
        if (needsContrastCode) alerts.push("âš ï¸ ì¡°ì˜ì œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (í•„ìˆ˜ ì‹œìˆ  í¬í•¨ë¨)");

        if (alerts.length > 0) {
            alertBox.innerHTML = alerts.join("<br>");
            alertBox.style.display = "block";
            if (laSum > 3.0) { alertBox.className = "alert-box alert-red"; } 
            else { alertBox.className = "alert-box alert-orange"; }
        } else {
            alertBox.style.display = "none";
        }

        const bPay = Math.floor(Math.floor(bSum * 0.3) / 10) * 10;
        return { totalFull: Math.floor(bSum + nbSum), bPay, nbSum: Math.floor(nbSum), finalPay: Math.floor((bPay + nbSum) / 10) * 10 };
    }

    function autoBalance() {
        const target = clean(document.getElementById('tAmt').value);
        const res = calc();
        const rows = Array.from(document.querySelectorAll('#itemList tr'));
        
        let tRow = rows.find(r => r.dataset.type === 'nb' && !r.querySelector('.lock-btn').classList.contains('active') && STRATEGY_DRUGS.some(sd => r.querySelector('input').value.includes(sd)));
        
        if (!tRow) {
            const reversedRows = [...rows].reverse();
            tRow = reversedRows.find(r => r.dataset.type === 'nb' && !r.querySelector('.lock-btn').classList.contains('active'));
        }

        if (tRow) {
            const adjName = tRow.querySelector('input').value;
            document.getElementById('matrixAdjustName').innerText = `[ì¡°ì •: ${adjName}]`;
            let otherNb = 0;
            rows.forEach(r => { if(r !== tRow && r.dataset.type === 'nb') otherNb += clean(r.querySelector('.p-input').value) * (parseFloat(r.querySelector('.q-input').value) || 0); });
            const pAdj = clean(tRow.querySelector('.p-input').value);
            
            if(pAdj > 0) {
                tRow.querySelector('.q-input').value = ((target - res.bPay - otherNb) / pAdj).toFixed(4);
                
                let mHTML = '';
                const baseThousand = target % 10000;
                const startPrice = Math.max(0, Math.floor(target/10000)*10000 - 50000);
                const endPrice = Math.floor(target/10000)*10000 + 20000;

                for(let i = startPrice; i <= endPrice; i += 10000) {
                    const pt = i + baseThousand;
                    const qP = ((pt - res.bPay - otherNb) / pAdj).toFixed(4);
                    if(qP >= 0) {
                        const bgStyle = (pt === target) ? "background:#eef6ff; border-color:var(--blue);" : "";
                        mHTML += `<div class="matrix-row" onclick="setTarget(${pt})" style="${bgStyle}"><span class="matrix-target">${fmt(pt)}ì›</span><span class="matrix-val">${qP} ea</span></div>`;
                    }
                }
                document.getElementById('matrixTable').innerHTML = mHTML;
            }
        }
        const f = calc();
        document.getElementById('totalFull').innerText = fmt(f.totalFull);
        document.getElementById('summaryBenefit').innerText = fmt(f.bPay);
        document.getElementById('summaryNonBenefit').innerText = fmt(f.nbSum);
        document.getElementById('finalPay').innerText = fmt(f.finalPay);
    }
    window.onload = init;
</script>
</body>
</html>
