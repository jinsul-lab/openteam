<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINSUL - Case Verification System</title>
    <style>
        :root { --primary-grey: #333; --accent-red: #d73a49; --border: rgba(0, 0, 0, 0.1); --blue: #0052cc; }
        body { margin: 0; background-color: #f6f6f7; color: #333; font-family: 'Pretendard', sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        /* [ë””ìì¸] JINSUL ì˜¤ë¦¬ì§€ë„ ì›Œí„°ë§ˆí¬ */
        .wm { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 0; }
        .wm img { width: min(760px, 78vw); opacity: .10; user-select: none; filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05); }

        header { width: 100%; padding: 30px 0; text-align: center; position: relative; z-index: 1; }
        .top-logo { width: 170px; height: auto; display: block; margin: 0 auto 10px; filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15); opacity: 0.8; }
        
        #syncBoard { position: absolute; top: 10px; right: 20px; background: #fff; border: 1px solid #222; border-radius: 10px; padding: 12px 18px; font-size: 11px; z-index: 1000; box-shadow: 0 6px 20px rgba(0,0,0,0.05); width: 300px; }
        .sync-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }

        .container { width: 1550px; max-width: 98%; margin: 0 auto; display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 40px; padding-bottom: 100px; position: relative; z-index: 1; flex: 1; }
        .card { background: rgba(255, 255, 255, 0.75); border: 1px solid var(--border); border-radius: 12px; padding: 35px; backdrop-filter: blur(1px); margin-bottom: 30px; }
        
        .section-title { font-size: 0.85em; font-weight: 800; color: #999; margin: 30px 0 15px 0; border-left: 3px solid #333; padding-left: 12px; text-transform: uppercase; }
        
        table { width: 100%; border-collapse: collapse; }
        th { border-bottom: 2px solid #eee; padding: 12px 10px; text-align: left; font-size: 0.8em; color: #aaa; background: rgba(243, 244, 246, 0.5); }
        td { padding: 10px 10px; border-bottom: 1px solid #eee; font-size: 0.95em; font-weight: 600; }
        
        .box-input { border: 1px solid #ddd; background: #fff; padding: 8px; border-radius: 4px; font-weight: 800; font-family: inherit; outline: none; }
        .p-input { width: 100px; text-align: right; color: #333; }
        .q-input { width: 70px; text-align: center; color: var(--accent-red); }

        #searchLayer { position: absolute; background: #fff; border: 2px solid #333; border-radius: 10px; width: 100%; max-height: 400px; overflow-y: auto; display: none; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .search-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .search-item:hover { background: #f0f7ff; }

        /* ìš°ì¸¡ ì •ì‚° & ë¹„êµ ë³´ë“œ */
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .target-input { font-size: 2.2em; width: 160px; background: none; border: none; border-bottom: 3px solid #333; color: #333; text-align: right; font-weight: 900; outline: none; }
        #finalPay { font-size: 3.5em; font-weight: 900; color: var(--accent-red); letter-spacing: -2px; }

        /* ë©€í‹° íƒ€ê²Ÿ ìš”ì•½ í‘œ */
        .matrix-table { width: 100%; font-size: 12px; margin-top: 20px; border-top: 1px solid #eee; }
        .matrix-row { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #f9f9f9; }
        .matrix-target { font-weight: 800; color: #555; }
        .matrix-val { font-weight: 900; color: var(--blue); }

        .lock-btn, .carry-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.2; transition: 0.2s; }
        .lock-btn.active { opacity: 1; color: var(--accent-red); }
        .carry-btn.active { opacity: 1; color: var(--blue); }

        footer { width: 100%; text-align: center; padding: 60px 0; font-size: 12px; color: #aaa; background: transparent; }
        .c-btn { flex: 1; padding: 14px; border: 1px solid #ddd; border-radius: 8px; background: rgba(255,255,255,0.6); cursor: pointer; font-weight: 800; font-size: 13px; color: #666; }
        .c-btn.active { border-color: var(--primary-grey); background: var(--primary-grey); color: #fff; }
    </style>
</head>
<body>

<div class="wm" aria-hidden="true"><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png"></div>

<div id="syncBoard">
    <div class="sync-row"><span>ìˆ˜ê°€ ì ìš©ì¼ì</span><span class="sync-val">2026-01-01</span></div>
    <div class="sync-row"><span>ë°ì´í„° ëˆ„ì ìˆ˜</span><span id="st-db" class="sync-val">...</span></div>
</div>

<header><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo"></header>

<div class="container">
    <div class="main-column">
        <div class="card">
            <div class="section-title">Consultation Fee</div>
            <div class="consult-group" style="display:flex; gap:10px; margin-bottom:25px;">
                <button onclick="setConsult('first')" id="btn-first" class="c-btn">ì´ˆì§„</button>
                <button onclick="setConsult('follow')" id="btn-follow" class="c-btn">ì¬ì§„</button>
                <button onclick="setConsult('none')" id="btn-none" class="c-btn active">ì•ˆí•¨</button>
            </div>

            <div class="section-title">Set Selection</div>
            <select id="setSel" style="width:100%; font-weight:700; font-size:1.1em; border:2px solid #333; border-radius:8px; padding:12px; outline:none; background:#fff;" onchange="changeSet()"></select>
            
            <div id="dataView" style="display:none; margin-top:35px;">
                <div class="section-title">Chief Complaint</div>
                <div id="ccContent" style="padding:25px; background:rgba(0,0,0,0.02); border-radius:12px; font-size:1em; line-height:1.8; margin-bottom:30px;"></div>
                
                <div class="section-title">Prescription / Auto-Balance</div>
                <table>
                    <thead>
                        <tr><th style="width:15%">ì½”ë“œ</th><th>í’ˆëª… ë° ê·œê²©</th><th style="width:18%; text-align:right;">ë‹¨ê°€</th><th style="width:12%; text-align:center;">ìˆ˜ëŸ‰</th><th style="width:8%; text-align:center;">ì ê¸ˆ</th><th style="width:8%; text-align:center;">ìœ ì§€</th></tr>
                    </thead>
                    <tbody id="itemList"></tbody>
                </table>

                <div style="margin-top:20px; display:flex; gap:10px; position:relative;">
                    <input type="text" id="searchInput" placeholder="ì¶”ê°€ ì²˜ë°© ê²€ìƒ‰ (ëª…ì¹­ ë˜ëŠ” ì½”ë“œ)" 
                           style="flex:1; padding:15px; border-radius:10px; border:2px solid #ddd; font-weight:800; outline:none;"
                           oninput="searchLive(this.value)">
                    <button onclick="addManualItem()" style="padding:0 20px; background:#fff; border:2px solid #333; border-radius:10px; font-weight:800; cursor:pointer;">+ ì„ì˜ ì¶”ê°€</button>
                    <div id="searchLayer"></div>
                </div>

                <button onclick="autoBalance()" style="background:#333; color:white; width:100%; padding:20px; border:none; border-radius:10px; font-weight:900; margin-top:30px; cursor:pointer;">ê°•ì œ ì—­ì‚° ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <div class="side-column">
        <div class="card" style="background: rgba(0,0,0,0.02); text-align: center; padding: 40px;">
            <div style="font-size: 0.85em; color: #888; margin-bottom: 12px; font-weight: 600;">TARGET (ëª©í‘œê°€)</div>
            <input type="number" id="tAmt" class="target-input" value="89000" oninput="autoBalance()">
        </div>

        <div class="card" style="border-top: 6px solid #333;">
            <div class="summary-row"><span style="font-size:13px; font-weight:700; color:#888;">ì´ ì§„ë£Œë¹„ í•©ê³„</span><span id="totalFull" style="font-weight:800;">0</span></div>
            <div class="summary-row"><span style="font-size:13px; font-weight:700; color:#888;">ê¸‰ì—¬ (ë³¸ì¸ë¶€ë‹´ 30%)</span><span id="summaryBenefit" style="font-weight:800;">0</span></div>
            <div class="summary-row"><span style="font-size:13px; font-weight:700; color:#888;">ë¹„ê¸‰ì—¬ (100% ì „ì•¡)</span><span id="summaryNonBenefit" style="font-weight:800;">0</span></div>
            <div style="text-align: center; margin-top: 25px;">
                <div style="font-size: 11px; color: #888; font-weight: 800; margin-bottom: 5px;">ìµœì¢… ìˆ˜ë‚© ê¸ˆì•¡</div>
                <div id="finalPay">0</div>
            </div>

            <div class="section-title" style="margin-top:40px; border-left-color: var(--blue);">Adjustment Matrix</div>
            <div id="matrixAdjustName" style="font-size:11px; color:var(--blue); font-weight:800; margin-bottom:10px; text-align:right;">[ì¡°ì • í•­ëª© ì—†ìŒ]</div>
            <div class="matrix-table" id="matrixTable">
                </div>
        </div>
    </div>
</div>

<footer>Â© JINSUL Â· ê²½í—˜ê³¼ ê°€ì¹˜ë¥¼ í˜„ì‹¤í™”í•˜ëŠ” ì»¨ì„¤íŒ…</footer>

<script>
    let DB = { fee: {}, drug: {}, mat: {}, sets: {} };
    let flatDB = [];
    let carryOverItems = new Map();
    let currentCustomItems = []; 
    
    const STRATEGY_DRUGS = ["ë¹„ì— íˆë£¨ë‹ˆë‹¤ì œ", "ë§ë¦°ë‹¤ì£¼", "ë¦¬í¬ë¼ì œì£¼"];
    const CONSULT_DATA = { first: ["ì§„ì°°ë£Œ(ì´ˆì§„)", 17610], follow: ["ì§„ì°°ë£Œ(ì¬ì§„)", 12590], none: ["ì—†ìŒ", 0] };
    const TARGET_PRESETS = [59000, 69000, 79000, 89000, 99000];
    let currentConsult = "none";

    const fmt = n => Math.floor(n || 0).toLocaleString();
    const clean = n => parseFloat(String(n).replace(/,/g, '')) || 0;

    async function init() {
        try {
            const res = await fetch("https://raw.githubusercontent.com/jinsul-lab/openteam/main/database.json?t=" + Date.now());
            DB = await res.json();
            for(let cat in DB) {
                if(cat === 'sets') continue;
                for(let code in DB[cat]) flatDB.push({ code, name: DB[cat][code][0], price: DB[cat][code][1] });
            }
            document.getElementById('st-db').innerText = fmt(flatDB.length) + "ê±´";
            document.getElementById('setSel').innerHTML = '<option value="">-- ì²˜ë°© ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>' + 
                Object.keys(DB.sets).sort().map(k => `<option value="${k}">[${k}] ${DB.sets[k].n}</option>`).join('');
        } catch(e) { console.error("DB ë¡œë“œ ì‹¤íŒ¨"); }
    }

    function changeSet() {
        currentCustomItems = [];
        renderItems();
    }

    function searchLive(val) {
        const layer = document.getElementById('searchLayer');
        if(!val || val.length < 2) { layer.style.display = 'none'; return; }
        const filtered = flatDB.filter(i => i.code.includes(val.toUpperCase()) || i.name.includes(val)).slice(0, 50);
        if(filtered.length > 0) {
            layer.innerHTML = filtered.map(i => `
                <div class="search-item" onclick="addSearchedItem('${i.code}', '${i.name.replace(/'/g, "\\'")}', ${i.price})">
                    <span style="color:#0052cc; font-weight:800;">${i.code}</span>
                    <span style="margin:0 15px; flex:1; font-size:14px; overflow:hidden;">${i.name}</span>
                    <span style="font-weight:800;">${fmt(i.price)}ì›</span>
                </div>
            `).join('');
            layer.style.display = 'block';
        } else { layer.style.display = 'none'; }
    }

    function addSearchedItem(code, name, price) {
        let finalPrice = price;
        if (STRATEGY_DRUGS.some(sd => name.includes(sd))) finalPrice = 100000;
        currentCustomItems.push({ code, name, price: finalPrice, q: 1, nb: true, lock: false, isManual: false });
        document.getElementById('searchLayer').style.display = 'none';
        document.getElementById('searchInput').value = '';
        renderItems();
    }

    // â˜… ì„ì˜ í•­ëª© ìˆ˜ë™ ì¶”ê°€ í•¨ìˆ˜
    function addManualItem() {
        currentCustomItems.push({ code: "ETC", name: "ì„ì˜ í•­ëª©", price: 0, q: 1, nb: true, lock: false, isManual: true });
        renderItems();
    }

    function setConsult(type) {
        currentConsult = type;
        document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + type).classList.add('active');
        renderItems();
    }

    function renderItems() {
        const key = document.getElementById('setSel').value;
        if(!key) return;
        const set = DB.sets[key];
        document.getElementById('dataView').style.display = 'block';
        document.getElementById('ccContent').innerHTML = (set.cc||[]).join('<br>');
        const tbody = document.getElementById('itemList');
        tbody.innerHTML = '';
        
        if(currentConsult !== "none") {
            const [name, price] = CONSULT_DATA[currentConsult];
            addRow(tbody, "CONST", name, price, 1, false, true, false);
        }

        set.it.forEach(item => {
            const code = item.c.toUpperCase();
            if (carryOverItems.has(code)) {
                const c = carryOverItems.get(code);
                addRow(tbody, code, c.name, c.price, c.q, c.nb, c.lock, true);
            } else {
                const info = DB.fee[code] || DB.drug[code] || DB.mat[code] || null;
                let name = info ? info[0] : (item.n || code);
                let price = info ? info[1] : 0;
                if (STRATEGY_DRUGS.some(sd => name.includes(sd))) price = 100000;
                addRow(tbody, code, name, price, item.q, item.nb, !item.nb || code.includes('SONO') || code.includes('C-ARM'), false);
            }
        });

        currentCustomItems.forEach((item, idx) => {
            if (carryOverItems.has(item.code)) return;
            addRow(tbody, item.code, item.name, item.price, item.q, item.nb, item.lock, false, true, idx);
        });

        carryOverItems.forEach((c, code) => {
            const exists = Array.from(tbody.rows).some(r => r.cells[0].innerText === code);
            if (!exists) addRow(tbody, code, c.name, c.price, c.q, c.nb, c.lock, true);
        });

        autoBalance();
    }

    function addRow(target, code, name, price, qty, isNB, isLocked, isCarry, isCustom = false, customIdx = null) {
        const tr = document.createElement('tr');
        tr.dataset.type = isNB ? 'nb' : 'b';
        tr.innerHTML = `
            <td style="color:#666; font-weight:800; font-size:11px;">${code}</td>
            <td><input class="box-input" style="width:100%; border:none; background:transparent;" value="${name}" ${isCustom && currentCustomItems[customIdx].isManual ? '' : 'readonly'} oninput="updateCustomName(this, ${customIdx})"></td>
            <td align="right"><input class="box-input p-input" value="${fmt(price)}" oninput="syncRow(this, '${code}', ${isCustom}, ${customIdx})"></td>
            <td align="center"><input class="box-input q-input" type="number" value="${qty}" step="0.1" oninput="syncRow(this, '${code}', ${isCustom}, ${customIdx})"></td>
            <td align="center"><button class="lock-btn ${isLocked?'active':''}" onclick="toggleLock(this, '${code}', ${isCustom}, ${customIdx})">ğŸ”’</button></td>
            <td align="center"><button class="carry-btn ${isCarry?'active':''}" onclick="toggleCarry(this, '${code}')">ğŸ“Œ</button></td>
        `;
        target.appendChild(tr);
    }

    function updateCustomName(el, idx) {
        if(idx !== null) currentCustomItems[idx].name = el.value;
    }

    function syncRow(el, code, isCustom, idx) {
        const tr = el.closest('tr');
        const p = clean(tr.querySelector('.p-input').value);
        const q = parseFloat(tr.querySelector('.q-input').value) || 0;
        const lock = tr.querySelector('.lock-btn').classList.contains('active');
        
        if (carryOverItems.has(code)) {
            const item = carryOverItems.get(code);
            item.price = p; item.q = q; item.lock = lock;
        }
        if (isCustom && idx !== null) {
            currentCustomItems[idx].price = p;
            currentCustomItems[idx].q = q;
        }
        if (el.classList.contains('p-input')) el.value = fmt(p);
        autoBalance();
    }

    function toggleLock(btn, code, isCustom, idx) {
        btn.classList.toggle('active');
        if (isCustom && idx !== null) currentCustomItems[idx].lock = btn.classList.contains('active');
        autoBalance();
    }

    function toggleCarry(btn, code) {
        const tr = btn.closest('tr');
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) {
            carryOverItems.set(code, {
                name: tr.cells[1].querySelector('input').value,
                price: clean(tr.querySelector('.p-input').value),
                q: parseFloat(tr.querySelector('.q-input').value) || 0,
                nb: tr.dataset.type === 'nb',
                lock: tr.querySelector('.lock-btn').classList.contains('active')
            });
        } else { carryOverItems.delete(code); }
    }

    function calc(customTarget = null) {
        let bSum = 0, nbSum = 0;
        document.querySelectorAll('#itemList tr').forEach(tr => {
            const p = clean(tr.querySelector('.p-input').value);
            const q = parseFloat(tr.querySelector('.q-input').value) || 0;
            if(tr.dataset.type === 'b') bSum += (p * q); else nbSum += (p * q);
        });
        const bPay = Math.floor(Math.floor(bSum * 0.3) / 10) * 10;
        const totalFull = Math.floor(bSum + nbSum);
        const finalPay = Math.floor((bPay + nbSum) / 10) * 10;

        return { totalFull, bPay, nbSum, finalPay };
    }

    function autoBalance() {
        const target = clean(document.getElementById('tAmt').value);
        const res = calc();
        const rows = Array.from(document.querySelectorAll('#itemList tr'));
        
        // ì¡°ì • í•­ëª© ì„ ì • (ì „ëµì•½ì œ ìš°ì„ )
        let tRow = rows.find(r => r.dataset.type === 'nb' && !r.querySelector('.lock-btn').classList.contains('active') && STRATEGY_DRUGS.some(sd => r.querySelector('input').value.includes(sd)));
        if (!tRow) tRow = rows.find(r => r.dataset.type === 'nb' && !r.querySelector('.lock-btn').classList.contains('active'));

        if (tRow) {
            const adjName = tRow.querySelector('input').value;
            document.getElementById('matrixAdjustName').innerText = `[ì¡°ì • í•­ëª©: ${adjName}]`;
            
            let otherNb = 0;
            rows.forEach(r => { if(r !== tRow && r.dataset.type === 'nb') otherNb += clean(r.querySelector('.p-input').value) * (parseFloat(r.querySelector('.q-input').value) || 0); });
            const pAdj = clean(tRow.querySelector('.p-input').value);
            
            if(pAdj > 0) {
                // í˜„ì¬ íƒ€ê²Ÿ ê³„ì‚°
                tRow.querySelector('.q-input').value = ((target - res.bPay - otherNb) / pAdj).toFixed(4);
                
                // â˜… ë©€í‹° íƒ€ê²Ÿ ìš”ì•½ ì—…ë°ì´íŠ¸ (Matrix)
                let matrixHTML = '';
                TARGET_PRESETS.forEach(pt => {
                    const qProposed = ((pt - res.bPay - otherNb) / pAdj).toFixed(4);
                    matrixHTML += `<div class="matrix-row"><span class="matrix-target">${fmt(pt)}ì›</span><span class="matrix-val">${qProposed} ea</span></div>`;
                });
                document.getElementById('matrixTable').innerHTML = matrixHTML;
            }
        } else {
            document.getElementById('matrixAdjustName').innerText = `[ì¡°ì • ê°€ëŠ¥ í•­ëª© ì—†ìŒ]`;
            document.getElementById('matrixTable').innerHTML = '';
        }

        const finalRes = calc();
        document.getElementById('totalFull').innerText = fmt(finalRes.totalFull);
        document.getElementById('summaryBenefit').innerText = fmt(finalRes.bPay);
        document.getElementById('summaryNonBenefit').innerText = fmt(finalRes.nbSum);
        document.getElementById('finalPay').innerText = fmt(finalRes.finalPay);
    }
    window.onload = init;
</script>
</body>
</html>
