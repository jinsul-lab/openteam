<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINSUL - Case Verification System (Set Search)</title>
    <style>
        /* [UI ì ˆëŒ€ ìœ ì§€] fee-auto_final.html ìŠ¤íƒ€ì¼ 100% ë³´ì¡´ */
        :root { --primary: #333; --accent: #d73a49; --blue: #0052cc; --bg: #f6f6f7; --border: #ccc; }
        body { margin: 0; background-color: var(--bg); color: var(--primary); font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        input, select, button { font-family: inherit; } 

        .wm { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 0; }
        .wm img { width: min(760px, 78vw); opacity: .20; filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05); }

        header { width: 100%; padding: 25px 0; text-align: center; position: relative; z-index: 1; }
        .top-logo { width: 170px; filter: grayscale(1) brightness(.45) contrast(1.15); opacity: 0.8; }
        
        /* ë“œë¡­ë‹¤ìš´ ë°•ìŠ¤ ë„ˆë¹„ ì¶•ì†Œ (240px -> 210px) */
        #syncBoard { position: absolute; top: 10px; right: 20px; background: rgba(255,255,255,0.8); border: 1px solid #222; border-radius: 8px; padding: 12px 18px; font-size: 12px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 240px; backdrop-filter: blur(5px); }
        #setBoard { position: absolute; top: 10px; left: 20px; background: rgba(255,255,255,0.8); border: 1px solid #222; border-radius: 8px; padding: 12px 18px; font-size: 12px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 210px; backdrop-filter: blur(5px); }
        #setBoard select { width: 100%; margin-top: 6px; padding: 6px 8px; border-radius: 10px; border: 1px solid #ddd; font-weight: 700; font-size: 12px; background: rgba(255,255,255,0.9); }
        .sync-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .sync-row:last-child { margin-bottom: 0; }
        .sync-label { color: #555; font-weight: 700; }
        .sync-val { font-weight: 800; color: #333; }
        .ver-tag { font-size: 10px; color: #999; margin-left: 5px; font-weight: normal; }

        .container { width: 1550px; max-width: 98%; margin: 0 auto; display: grid; grid-template-columns: 1.75fr 1.25fr; gap: 25px; padding-bottom: 80px; position: relative; z-index: 1; flex: 1; }
        
        .card { 
            background: rgba(255, 255, 255, 0.2); 
            border: 1px solid rgba(0,0,0,0.08); 
            border-radius: 12px; 
            padding: 25px; 
            backdrop-filter: blur(2px); 
            margin-bottom: 20px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.02); 
        }
        
        .section-title { 
            font-size: 0.95em; 
            font-weight: 800; 
            color: #555; 
            margin: 0 0 12px 0; 
            border-left: 4px solid var(--primary); 
            padding-left: 10px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--blue); }
        input:checked + .slider:before { transform: translateX(14px); }

        .consult-group { display: flex; gap: 8px; margin-bottom: 20px; }
        .c-btn { flex: 1; padding: 12px; border: 1px solid rgba(0,0,0,0.2); border-radius: 8px; background: rgba(255,255,255,0.4); cursor: pointer; font-weight: 800; font-size: 13px; color: #444; transition: 0.2s; }
        .c-btn:hover { background: rgba(255,255,255,0.6); }
        .c-btn.active { border-color: var(--primary); background: var(--primary); color: #fff; }

        /* [ìˆ˜ì • v0.0.0.3] í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ëŒ€ê°œí¸: ëª…ì¹­ ì¹¸ í™•ì¥ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th { padding: 8px 10px; text-align: left; font-size: 0.8em; color: #666; border-bottom: 2px solid rgba(0,0,0,0.1); background: transparent !important; white-space: nowrap; }
        td { padding: 6px 10px; background: transparent !important; font-size: 0.95em; font-weight: 600; border-bottom: 1px solid rgba(0,0,0,0.05); vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ì—´ ë„ˆë¹„ ê³ ì • (ëª…ì¹­ ì¹¸ì„ ìµœëŒ€í•œ í™•ë³´í•˜ê¸° ìœ„í•¨) */
        th:nth-child(1) { width: 14%; } /* ì½”ë“œ */
        th:nth-child(2) { width: auto; } /* ëª…ì¹­ (ë‚˜ë¨¸ì§€ ì „ì²´) */
        th:nth-child(3) { width: 85px; text-align:right; } /* ë‹¨ê°€ */
        th:nth-child(4) { width: 65px; text-align:center; } /* ìˆ˜ëŸ‰ */
        th:nth-child(5) { width: 60px; text-align:center; } /* êµ¬ë¶„ */
        th:nth-child(6) { width: 45px; text-align:center; } /* ìœ ì§€ */
        th:nth-child(7) { width: 45px; text-align:center; } /* ì‚­ì œ */

        .input-wrapper {
            position: relative;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 0 24px 0 8px;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            height: 32px;
            transition: 0.2s;
        }
        .input-wrapper:focus-within {
            border-color: var(--blue);
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.1);
        }
        .input-wrapper::after {
            content: 'âœ';
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #999;
            pointer-events: none;
        }

        .box-input { 
            border: none; 
            background: transparent !important; 
            width: 100%; 
            font-weight: 800; 
            font-family: inherit; 
            outline: none; 
            font-size: 13px; 
            color: #333; 
            height: 100%;
        }
        
        .box-input-num { border: 1px solid rgba(0,0,0,0.25); border-radius: 4px; background: transparent !important; padding: 0 4px; height: 32px; font-weight: 800; outline: none; font-size: 13px; width: 100%; transition: 0.2s; color: #333; text-align: center; }
        .box-input-num:focus { border-color: var(--blue); background: rgba(255,255,255,0.2) !important; }

        .type-btn { border: 1px solid transparent; border-radius: 6px; padding: 0 10px; height: 28px; font-size: 11px; font-weight: 800; cursor: pointer; transition: 0.2s; width: 100%; text-align: center; }
        .type-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .type-b { background: #e3f2fd; color: #0052cc; border-color: #bbdefb; }
        .type-nb { background: #ffeef0; color: #d73a49; border-color: #ffcdd2; }

        .badge { display: inline-block; padding: 2px 6px; font-size: 10px; border-radius: 4px; font-weight: 900; margin-left: 6px; white-space: nowrap; letter-spacing: -0.5px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .badge-req { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .badge-con { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

        .p-input { width: 100%; text-align: right; color: #333; }
        .q-input { width: 100%; text-align: center; color: var(--accent); }

        .diag-table { width: 100%; margin-bottom: 25px; }
        .diag-table td { padding: 8px 10px; background: transparent !important; border-bottom: 1px dashed rgba(0,0,0,0.1); color: #444; }
        .diag-code { font-weight: 800; color: var(--blue); }

        .set-selector-group { display: flex; gap: 10px; position: relative; }
        #setSel { flex: 1; background: rgba(255,255,255,0.3); border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; outline: none; cursor: pointer; font-weight: 800; font-size: 1.1em;  min-width:0;}
        #setSearchInput { width: 140px; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; padding: 0 12px; background: rgba(255,255,255,0.5); font-weight: 800; outline: none; font-size: 13px; }
        #setSearchInput:focus { border-color: var(--blue); background: #fff; }

        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); }
        .summary-label { font-size: 13px; font-weight: 700; color: #666; }
        .summary-val { font-size: 16px; font-weight: 900; color: #333; }
        
        .target-input { font-size: 2.2em; width: 180px; background: none; border: none; border-bottom: 3px solid var(--primary); color: var(--primary); text-align: right; font-weight: 900; outline: none; }
        #finalPay { font-size: 3.2em; font-weight: 900; color: var(--accent); letter-spacing: -2px; line-height: 1; }

        .matrix-container { display: grid; grid-template-columns: repeat(1, 1fr); gap: 6px; margin-top: 15px; }
        .matrix-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: rgba(255,255,255,0.4); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .matrix-row:hover { background: rgba(240, 247, 255, 0.6); border-color: var(--blue); transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .matrix-target { font-weight: 800; color: #555; }
        .matrix-val { font-weight: 900; color: var(--blue); font-size: 13px; }

        .carry-btn { background: none; border: none; font-size: 1.1em; cursor: pointer; opacity: 0.3; transition: 0.2s; }
        .carry-btn.active { opacity: 1; color: var(--blue); }
        .del-btn { background: none; border: none; font-size: 1.1em; cursor: pointer; opacity: 1; color: #999; transition: 0.2s; } 
        .del-btn:hover { color: #d73a49; transform: scale(1.15); }

        .search-dropdown { position: absolute; background: rgba(255,255,255,0.98); z-index: 9999; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: none; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; width: 300px; }
        .search-item { padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; }
        .search-item:hover { background: #f5f5f5; }

        .alert-box { padding: 12px 15px; border-radius: 8px; font-weight: 800; font-size: 13px; margin-bottom: 15px; display: none; border: 1px solid transparent; }
        .alert-red { background: rgba(255, 240, 241, 0.7); color: #d73a49; border-color: #d73a49; }
        .alert-orange { background: rgba(255, 248, 230, 0.7); color: #b7791f; border-color: #b7791f; }

        footer { width: 100%; text-align: center; padding: 50px 0; font-size: 12px; color: #888; background: transparent; font-weight: 600; }
    
        .inj-only-toggle{display:flex;align-items:center;gap:6px;padding:6px 10px;border:2px solid rgba(0,0,0,0.15);border-radius:10px;background:rgba(255,255,255,0.35);cursor:pointer;font-weight:900;font-size:12px;user-select:none;white-space:nowrap;min-width:74px;}
        .inj-only-toggle input{accent-color: var(--blue); width:14px; height:14px;}

        /* ì•ˆì •ì ì¸ ë ˆì´ì•„ì›ƒ */
        .select-line select, .select-line input {min-width:0;}
        .inj-only-toggle{flex:0 0 auto;}

        /* ì°¨ë‹¨ìˆ  ì¡°ì • UI - íˆ¬ëª…ë„ 0.2 */
        .block-adjust-row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 12px; background:rgba(255,255,255,0.2); border:1px solid rgba(0,0,0,0.12); border-radius:8px; margin-top:8px;}
        .block-adjust-label{font-size:12px; font-weight:900; color:#444;}
        .block-adjust-ctrl{display:flex; align-items:center; gap:8px;}
        .block-btn{width:34px; height:30px; border-radius:8px; border:2px solid rgba(0,0,0,0.18); background:rgba(255,255,255,0.5); font-weight:900; cursor:pointer; font-size:14px; line-height:1;}
        .block-btn:hover{border-color: var(--blue); box-shadow:0 2px 5px rgba(0,0,0,0.06); transform: translateY(-1px);}
        .block-step{width:70px; padding:6px 8px; border-radius:8px; border:2px solid rgba(0,0,0,0.18); background:rgba(255,255,255,0.55); font-weight:900; text-align:center;}

</style>
</head>
<body onclick="closeSearch(event)">

<div class="wm"><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png"></div>


<div id="setBoard">
    <div class="sync-row"><span class="sync-label">ì²˜ë°©ì„¸íŠ¸</span><span id="setFileStatus" class="sync-val">-</span><span class="ver-tag">v0.0.0.3</span></div>
    <select id="setFileSel" onchange="changeSetFile()">
        <option value="">ë¡œë”©ì¤‘...</option>
    </select>
</div>

<div id="syncBoard">
    <div class="sync-row"><span class="sync-label">ìˆ˜ê°€ ì ìš©ì¼ì</span><span id="st-date" class="sync-val">-</span></div>
    <div class="sync-row"><span class="sync-label">ë°ì´í„° ëˆ„ì ìˆ˜</span><span id="st-db" class="sync-val">...</span></div>
</div>

<header><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo"></header>

<div class="container">
    <div class="main-column">
        <div class="card">
            <div class="section-title">ì§„ì°°ë£Œ ì‚°ì •</div>
            <div class="consult-group">
                <button onclick="setConsult('first')" id="btn-first" class="c-btn">ì´ˆì§„</button>
                <button onclick="setConsult('follow')" id="btn-follow" class="c-btn">ì¬ì§„</button>
                <button onclick="setConsult('none')" id="btn-none" class="c-btn active">ì‚°ì • ì•ˆí•¨</button>
            </div>

            <div class="section-title">ì½”ë“œ ì„ íƒ</div>
            <div class="set-selector-group">
                <select id="setSel" onchange="changeSet()"></select>
                <input type="text" id="setSearchInput" placeholder="ğŸ” ì„¸íŠ¸ ê²€ìƒ‰" oninput="searchSets(this.value, this)" onkeydown="if(event.key==='Escape') clearSearch()">
                <label class="inj-only-toggle" title="ì°¨ë‹¨ìˆ /ìˆ˜íŒ½/ê´€ì ˆì¡°ì˜ ë“± ì£¼ì‚¬ ì„¸íŠ¸ë§Œ í‘œì‹œ">
                    <input type="checkbox" id="injOnlyToggle" onchange="toggleInjectionOnly()"> ì£¼ì‚¬ë§Œ
                </label>
            </div>
            
            <div id="dataView" style="display:none; margin-top:30px;">
                <div class="section-title">
                    <span>í™˜ì ì¦ìƒ (C.C)</span>
                    <label class="switch">
                        <input type="checkbox" id="ccSwitch" checked onchange="toggleCC()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="ccContent" style="padding:15px; background:rgba(0,0,0,0.05); border-radius:8px; font-size:0.95em; line-height:1.6; margin-bottom:30px; border-left: 0px solid #999; min-height:20px; font-weight: 600;"></div>

                <div id="diagSection" style="display:none;">
                    <div class="section-title" style="border-left-color: var(--blue); color:var(--blue); cursor: default;">ìƒë³‘ ë‚´ì—­</div>
                    <table class="diag-table">
                        <thead><tr><th style="width:20%">ìƒë³‘ì½”ë“œ</th><th>ìƒë³‘ëª…ì¹­</th></tr></thead>
                        <tbody id="diagList"></tbody>
                    </table>
                </div>
                
                <div class="section-title" style="cursor: default;">ì²˜ë°© ë‚´ì—­ / ë¹„ê¸‰ì—¬ ì¡°ì •</div>
                <div id="mainAlertBox" class="alert-box"></div>

                <table>
                    <thead>
                        <tr>
                            <th>ì²˜ë°©ì½”ë“œ</th>
                            <th>ì²˜ë°©ëª…ì¹­</th>
                            <th style="text-align:right;">ë‹¨ê°€</th>
                            <th style="text-align:center;">ìˆ˜ëŸ‰</th>
                            <th style="text-align:center;">êµ¬ë¶„</th>
                            <th style="text-align:center;">ìœ ì§€</th>
                            <th style="text-align:center;">ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="itemList"></tbody>
                </table>

                <div style="margin-top:20px; display:flex; gap:10px; position:relative;" id="searchBox">
                    <input type="text" id="searchInput" placeholder="ëª…ì¹­ ë˜ëŠ” ì½”ë“œë¡œ ì²˜ë°© ê²€ìƒ‰" 
                           style="flex:1; padding:12px; border-radius:8px; border:2px solid rgba(0,0,0,0.2); font-weight:800; outline:none; font-size: 13px; background: rgba(255,255,255,0.3);"
                           oninput="searchLive(this.value, 'main', this)" onkeydown="if(event.key==='Escape') clearSearch()">
                    <button onclick="addManualItem()" style="padding:0 20px; background:rgba(255,255,255,0.5); border:2px solid var(--primary); border-radius:8px; font-weight:800; cursor:pointer; font-size:12px;">+ ì„ì˜ ì¶”ê°€</button>
                </div>

                <button onclick="autoBalance()" style="background:var(--primary); color:white; width:100%; padding:18px; border:none; border-radius:10px; font-weight:900; margin-top:30px; cursor:pointer; font-size:1.05em; letter-spacing: 1px;">ê³„ì‚°</button>
            </div>
        </div>
    </div>

    <div class="side-column">
        <div class="card" style="background: rgba(255, 255, 255, 0.1); text-align: center; padding: 30px 20px;">
            <div style="font-size: 0.85em; color: #666; margin-bottom: 10px; font-weight: 800; letter-spacing: 1px;">ëª©í‘œê°€</div>
            <div>
                <input type="number" id="tAmt" class="target-input" value="89000" oninput="autoBalance()"> <span style="font-size: 1.2em; font-weight: 900;">ì›</span>
            </div>
        </div>

        <div class="card" style="border-top: 6px solid var(--primary);">
            <div class="summary-row"><span class="summary-label">ì´ ì§„ë£Œë¹„ í•©ê³„</span><span id="totalFull" class="summary-val">0</span></div>
            <div class="summary-row"><span class="summary-label">ê¸‰ì—¬ (ë³¸ì¸ë¶€ë‹´ 30%)</span><span id="summaryBenefit" class="summary-val">0</span></div>
            <div class="summary-row" style="border-bottom:none;"><span class="summary-label">ë¹„ê¸‰ì—¬ (100% ì „ì•¡)</span><span id="summaryNonBenefit" class="summary-val" style="color:var(--blue);">0</span></div>
            
            <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(0,0,0,0.1);">
                <div style="font-size: 12px; color: #777; font-weight: 800; margin-bottom: 8px;">ìµœì¢… ì‹¤ì œ ìˆ˜ë‚©ì•¡</div>
                <div id="finalPay">0</div>
            </div>

            <div id="blockAdjustWrap" style="margin-top:25px; text-align:left; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 20px;">
                </div>

            <div class="section-title" style="margin-top:40px; border-left-color: var(--blue);">ê¸ˆì•¡ë³„ ìˆ˜ëŸ‰ ì¡°ì •</div>
            <div id="matrixAdjustName" style="font-size:11px; color:var(--blue); font-weight:800; margin-bottom:10px; text-align:right;">-</div>
            <div id="matrixTable" class="matrix-container"></div>
            
        </div>
    </div>
</div>

<div id="globalSearchLayer" class="search-dropdown"></div>

<footer>Â© JINSUL Â· ê²½í—˜ê³¼ ê°€ì¹˜ë¥¼ í˜„ì‹¤í™”í•˜ëŠ” ì»¨ì„¤íŒ…</footer>

<script>
    const LOCAL_DATA = {}; 

    let DB = LOCAL_DATA;
    let flatDB = [];
    let carryOverItems = new Map();
    let currentCustomItems = []; 
    let deletedSetItems = new Set();
    const STRATEGY_DRUGS = ["ë¹„ì— íˆë£¨ë‹ˆë‹¤ì œ", "ë§ë¦°ë‹¤ì£¼", "ë¦¬í¬ë¼ì œì£¼"];
    // [ìˆ˜ì •] ì¡°ì˜í•„ìš” ì½”ë“œ ë¦¬ìŠ¤íŠ¸ (LA ì¼íšŒì„± í¬í•¨ ê¸°ì¡´ ìœ ì§€)
    const CONTRAST_REQUIRED_CODES = ["LA354", "LA359", "LA253", "LA355", "LA352", "HA280", "MM410"];
    const CONTRAST_KEYWORDS = [
        "OMNI", "VISI", "IOP", "HEX", "BONO", "CONTRAST", 
        "ì˜´ë‹ˆ", "ìš¸íŠ¸ë¼", "ê°€ë„", "íŒŒë¯¸", "ë¹„ì§€", "ì´ì˜¤", "í—¥ì‚¬", "ë³´ë…¸", "ë„íƒ€", "ê²Œë„¤", "ì„¼ìŠ¤", "íŒŒí", "ìœ ë‹ˆ", "ë§ˆê·¸ë„¤", "í´ë¼ë¦¬"
    ];
    
    let CONSULT_PRICES = { first: 0, follow: 0 };
    let currentConsult = "none";
    let activeInputEl = null;

    const fmt = n => Math.floor(n || 0).toLocaleString();
    const clean = n => parseFloat(String(n).replace(/,/g, '')) || 0;

    
    // [ì‹ ê·œ] GitHub(main)ì—ì„œ JSON ë¶„ë¦¬ ë¡œë“œ (fee/drug/mat) + set*.json(ë³‘ì›ë³„ ì²˜ë°©ì„¸íŠ¸)
    const GITHUB_OWNER = "jinsul-lab";
    const GITHUB_REPO = "openteam";
    const GITHUB_BRANCH = "main";
    const RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/`;
    const API_BASE = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/`;

    const unwrapData = (obj) => (obj && typeof obj === 'object' && obj.data && typeof obj.data === 'object') ? obj.data : obj;

    async function fetchJsonFromGithub(fileName) {
        const res = await fetch(RAW_BASE + fileName + "?t=" + Date.now());
        if (!res.ok) throw new Error("fetch ì‹¤íŒ¨: " + fileName);
        return await res.json();
    }

    async function listSetFiles() {
        // ë ˆí¬ ë£¨íŠ¸ì—ì„œ set*.json ìë™ íƒìƒ‰
        try {
            const res = await fetch(API_BASE + "?ref=" + GITHUB_BRANCH);
            if (!res.ok) throw new Error("list ì‹¤íŒ¨");
            const items = await res.json();
            return (Array.isArray(items) ? items : [])
                .filter(it => it && it.type === "file" && /^set.*\.json$/i.test(it.name))
                .map(it => it.name)
                .sort((a,b) => a.localeCompare(b));
        } catch(e) {
            console.warn("set*.json ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", e);
            return [];
        }
    }

    
    // ===== [ì¶”ê°€] ì²˜ë°©ì„¸íŠ¸ íŒŒì¼ í‘œì‹œëª…/ì„¸íŠ¸ ë¼ë²¨/í•„í„°/ì •ë ¬ =====
    let INJ_ONLY = false;
    let SET_META = {};   // {key:{label, search, part, sortKey, isInj, blocksLabel, tier}}
    const PART_ORDER = ["ê²½ì¶”","í‰ì¶”","ìš”ì¶”","ì–´ê¹¨","íŒ”ê¿ˆì¹˜","ì†ëª©/ì†","ê³¨ë°˜/ê³ ê´€ì ˆ","ëŒ€í‡´/ë¬´ë¦","ë°œëª©/ë°œ","ê¸°íƒ€"];

    function setFileDisplayName(fileName){
        const f = (fileName||"").toString();
        const lower = f.toLowerCase();
        if (lower === "set_databaset.json" || lower === "ì‹ ê²½ì°¨ë‹¨ìˆ  ì¡°í•©.json") return "ì‹ ê²½ì°¨ë‹¨ìˆ  ì¡°í•©";
        // set_****.json => **** ë¬¶ìŒì½”ë“œ
        const m = lower.match(/^set_([^\/]+)\.json$/i);
        if (m) return `${m[1]} ë¬¶ìŒì½”ë“œ`;
        return f;
    }

    function normalizeCodeForLookup(code){
        const c = (code||"").toString().trim().toUpperCase();
        if (!c) return "";
        // ì ‘ë¯¸ì‚¬(HA280KNEE ë“±) -> HA280
        const m = c.match(/^([A-Z]{1,3}\d{2,6})[A-Z_]+$/);
        if (m) return m[1];
        return c;
    }

    function fmt1(n){
        const x = parseFloat(n);
        if (isNaN(x)) return "0.0";
        return x.toFixed(1);
    }

    function detectMainTag(setObj){
        const it = (setObj && setObj.it) ? setObj.it : [];
        const allNames = it.map(x => (x && x.n ? String(x.n) : "")).join(" ");
        const allCodes = it.map(x => (x && x.c ? String(x.c) : "")).join(" ").toUpperCase();

        const hasHydro = /ìˆ˜ì••íŒ½ì°½ìˆ |ìˆ˜ì••\s*íŒ½ì°½|hydrodilat/i.test(allNames);
        if (hasHydro) return "ìˆ˜íŒ½";

        const hasHA280 = /\bHA280\b/.test(allCodes) || /HA280/i.test(allCodes);
        if (hasHA280) return "ì¡°ì˜";

        return "";
    }

    function sumBlockQty(setObj, patterns){
        const it = (setObj && setObj.it) ? setObj.it : [];
        let sum = 0;
        it.forEach(x=>{
            const n = (x && x.n!=null) ? String(x.n) : "";
            const c = (x && x.c!=null) ? String(x.c).toUpperCase() : "";
            if (patterns.some(p=> (p instanceof RegExp) ? (p.test(n)||p.test(c)) : (n.includes(p)||c.includes(String(p).toUpperCase())) )) {
                const q = parseFloat(x.q) || 0;
                sum += q;
            }
        });
        return sum;
    }

    function inferSpineRegion(setObj){
        const cc = (setObj && setObj.cc) ? setObj.cc.join(" ") : "";
        const nAll = ((setObj && setObj.it) ? setObj.it.map(x=>String(x.n||"")).join(" ") : "");
        let s = (cc + " " + nAll).toUpperCase();

        // K-L grade(ë¬´ë¦ OA ë“±)ì²˜ëŸ¼ 'K-L 2~3' í‘œê¸°ëŠ” ìš”ì¶”(L)ë¡œ ì˜¤ì¸ë˜ê¸° ì‰¬ì›Œ ì œê±°
        s = s.replace(/K\s*-\s*L\s*\d\s*(?:~|\-|TO)?\s*\d?/gi, " ");
        s = s.replace(/K\s*-\s*L/gi, " ");

        // ëª…ì‹œì  C/T/L
        if (/\bC[\-\s]?\d/.test(s) || /CERV/i.test(s) || /ê²½ì¶”|ëª©/.test(s)) return "C";
        if (/\bT[\-\s]?\d/.test(s) || /THOR/i.test(s) || /í‰ì¶”|í‰/.test(s)) return "T";
        if (/\bL[\-\s]?\d/.test(s) || /LUMB/i.test(s) || /ìš”ì¶”|í—ˆë¦¬/.test(s)) return "L";

        // ê¸°íƒ€ íŒíŠ¸
        if (/(EPI\b|EPIDURO)/i.test(s) && /CERV/i.test(s)) return "C";
        if (/(EPI\b|EPIDURO)/i.test(s) && /THOR/i.test(s)) return "T";
        if (/(EPI\b|EPIDURO)/i.test(s) && /LUMB/i.test(s)) return "L";

        return "";
    }

    function inferPeripheralPart(setObj){
        const cc = (setObj && setObj.cc) ? setObj.cc.join(" ") : "";
        const nAll = ((setObj && setObj.it) ? setObj.it.map(x=>String(x.n||"")).join(" ") : "");
        const s = (cc + " " + nAll);

        // ê²½ì‹ ê²½ì´(ëª©) - SCPB/CPB/SFCP ë“±
        if (/SCPB|\bCPB\b|SFCP|ê²½ì‹ ê²½ì´|CERVICAL\s*PLEX/i.test(s)) return "ê²½ì¶”";

        // ì–´ê¹¨/ìƒì™„
        if (/ì–´ê¹¨|ê²¬ê´€ì ˆ|íšŒì „ê·¼|ê²¬ë´‰|ê²¬ê°‘|SSNB|ê²¬ê°‘ì‹ ê²½|ì•¡ì™€ì‹ ê²½|\bANB\b/i.test(s)) return "ì–´ê¹¨";
        if (/íŒ”ê¿ˆì¹˜|ì£¼ê´€ì ˆ|elbow/i.test(s)) return "íŒ”ê¿ˆì¹˜";
        if (/ì†ëª©|ìˆ˜ê·¼|ì†ê°€ë½|ì†\s*ì €ë¦¼|hand|wrist|\bAPNB\b|DIGITAL|MEDIAN|ULNAR|RADIAL/i.test(s)) return "ì†ëª©/ì†";

        // ê³¨ë°˜/ê³ ê´€ì ˆ
        if (/ê³ ê´€ì ˆ|hip|ì²œì¥ê´€ì ˆ|\bSIJ\b|ê³¨ë°˜/i.test(s)) return "ê³¨ë°˜/ê³ ê´€ì ˆ";

        // ëŒ€í‡´/ë¬´ë¦ (FNB/LFCNB/SCNB í¬í•¨)
        if (/ë¬´ë¦|ìŠ¬ê´€ì ˆ|knee|ëŒ€í‡´|í—ˆë²…ì§€|\bFNB\b|ëŒ€í‡´ì‹ ê²½|\bLFCNB\b|ì™¸ì¸¡ëŒ€í‡´í”¼|\bSCNB\b|ì¢Œê³¨ì‹ ê²½/i.test(s)) return "ëŒ€í‡´/ë¬´ë¦";

        // ë°œëª©/ë°œ (í•˜í‡´ í¬í•¨)
        if (/ë°œëª©|ì¡±ê´€ì ˆ|ankle|ë°œ\b|foot|í•˜í‡´|ì¢…ì•„ë¦¬|\bSNB\b|SUR/i.test(s)) return "ë°œëª©/ë°œ";

        return "ê¸°íƒ€";
    }

    function isInjectionSet(setObj){
        const it = (setObj && setObj.it) ? setObj.it : [];
        const all = it.map(x=>String(x.n||"") + " " + String(x.c||"")).join(" ").toUpperCase();
        // ì£¼ì‚¬ í‚¤ì›Œë“œ(ì°¨ë‹¨ìˆ /ë¸”ë¡/ì‹ ê²½/ê´€ì ˆì¡°ì˜/ìˆ˜ì••íŒ½ì°½)
        if (/ì°¨ë‹¨|BLOCK|MBB|SNRB|PDNB|FJB|EPI|EPIDUR|SSNB|FNB|LFCNB|PCB|SCNB|ì•¡ì™€|ê´€ì ˆì¡°ì˜|HA280|ìˆ˜ì••íŒ½ì°½|HYDRODILAT/.test(all)) return true;
        return false;
    }

    function buildBlocksLabel(setObj, spinePrefix){
        const parts = [];
        // ìˆ˜íŒ½/ì¡°ì˜ì€ ë³„ë„ mainTagë¡œ ì²˜ë¦¬(ì—¬ê¸°ì„œëŠ” ë¸”ë¡ë§Œ)

        // ì¤‘ì•™(ì²™ì¶”) ë¸”ë¡
        const mbbQ = sumBlockQty(setObj, [/í›„ì§€ë‚´ì¸¡ì§€/i, /\bMBB\b/i]);
        if (mbbQ>0) parts.push(`${spinePrefix?spinePrefix+"-":""}MBB ${fmt1(mbbQ)}`);

        const snrbQ = sumBlockQty(setObj, [/ì„ íƒê·¼ì‹ ê²½ê·¼/i, /\bSNRB\b/i]);
        if (snrbQ>0) parts.push(`${spinePrefix?spinePrefix+"-":""}SNRB ${fmt1(snrbQ)}`);

        const fjbQ = sumBlockQty(setObj, [/ì¶”ê°„ê´€ì ˆ/i, /\bFJB\b/i]);
        if (fjbQ>0) parts.push(`${spinePrefix?spinePrefix+"-":""}FJB ${fmt1(fjbQ)}`);

        const epiQ = sumBlockQty(setObj, [/ê²½ë§‰ì™¸|EPIDURO|EPI\b/i]);
        if (epiQ>0) parts.push(`${spinePrefix?spinePrefix+"-":""}EPI ${fmt1(epiQ)}`);

        // ë§ì´ˆ ë¸”ë¡
        const ssnbQ = sumBlockQty(setObj, [/ê²¬ê°‘ì‹ ê²½/i, /\bSSNB\b/i]);
        if (ssnbQ>0) parts.push(`SSNB ${fmt1(ssnbQ)}`);

        const fnbQ = sumBlockQty(setObj, [/ëŒ€í‡´ì‹ ê²½/i, /\bFNB\b/i]);
        if (fnbQ>0) parts.push(`FNB ${fmt1(fnbQ)}`);

        const lfcnQ = sumBlockQty(setObj, [/ì™¸ì¸¡ëŒ€í‡´í”¼/i, /\bLFCNB\b/i]);
        if (lfcnQ>0) parts.push(`LFCNB ${fmt1(lfcnQ)}`);

        const pcbQ = sumBlockQty(setObj, [/ìš”ì²œê³¨ì‹ ê²½ì´/i, /\bPCB\b/i]);
        if (pcbQ>0) parts.push(`PCB ${fmt1(pcbQ)}`);

        const scnbQ = sumBlockQty(setObj, [/ì¢Œê³¨ì‹ ê²½/i, /\bSCNB\b/i]);
        if (scnbQ>0) parts.push(`SCNB ${fmt1(scnbQ)}`);

        const anbQ = sumBlockQty(setObj, [/ì•¡ì™€ì‹ ê²½ì°¨ë‹¨/i, /\bANB\b/i]);
        if (anbQ>0) parts.push(`ANB ${fmt1(anbQ)}`);

        const apnbQ = sumBlockQty(setObj, [/ì•¡ì™€í•˜ë¶€|digital|median|ulnar|radial/i, /\bAPNB\b/i]);
        if (apnbQ>0) parts.push(`APNB ${fmt1(apnbQ)}`);

        // PDNBëŠ” ì²™ì¶” prefixë¥¼ ë‹¬ì§€ ì•ŠìŒ(ë§ì´ˆ ë”°ë¼ê°„ë‹¤ê³  í–ˆìœ¼ë¯€ë¡œ í‘œì‹œë§Œ)
        const pdnbQ = sumBlockQty(setObj, [/ì²™ìˆ˜ì‹ ê²½í›„ì§€/i, /\bPDNB\b/i, /^LA357$/i]);
        if (pdnbQ>0) parts.push(`PDNB ${fmt1(pdnbQ)}`);

        return parts;
    }

    function extractTierFromNameOrMeta(setObj, finalPay){
        // meta/fields
        if (setObj){
            const cand = [setObj.tier, setObj.t, setObj.target, setObj.amt, setObj.price];
            for (const v of cand){
                if (v==null) continue;
                const n = parseFloat(v);
                if (!isNaN(n) && n>=1 && n<100) return Math.round(n*10)/10;
            }
            // nameì—ì„œ tier ì¶”ì¶œ: "+0.211.003" ê°™ì€ ë‚´ë¶€ì½”ë“œ(0.x ê³„ì—´)ëŠ” ì œì™¸
            let name = String(setObj.n||"");
            name = name.replace(/\+\s*0\.\d{3}\.\d{3}/g, " ");
            name = name.replace(/0\.\d{3}\.\d{3}/g, " ");

            // 7.9 / 9.8 ê°™ì€ 'ë§Œì›ë‹¨ìœ„' í‘œê¸° ìš°ì„ 
            const floats = name.match(/\b\d{1,2}\.\d\b/g) || [];
            for (const f of floats){
                const n = parseFloat(f);
                if (!isNaN(n) && n>=1 && n<100) return Math.round(n*10)/10;
            }

            // "80,550ì›" ê°™ì€ ì›í™” í‘œê¸°
            const m2 = name.match(/(\d{1,3}(?:,\d{3})+)\s*ì›/);
            if (m2){
                const won = parseInt(m2[1].replace(/,/g,''),10);
                if (!isNaN(won) && won>0) return Math.round((won/10000)*10)/10;
            }
        }
        // fallback: ê³„ì‚°ëœ ë³¸ì¸ë¶€ë‹´ê¸ˆ(ë§Œì› ë‹¨ìœ„)
        if (finalPay && finalPay>0){
            return Math.round((finalPay/10000)*10)/10;
        }
        return null;
    }

    function calcFinalPayForSet(setObj){
        // DOMì„ ê±´ë“œë¦¬ì§€ ì•Šê³  ë™ì¼í•œ ê³„ì‚°ì‹(ê¸‰ì—¬ 30% + 10ì›ì ˆì‚¬)ë§Œ ë³µì œ
        // (ê°œë³„ í•­ëª©ì˜ ê¸‰/ë¹„ êµ¬ë¶„ì€ item.nb + ì¼ë¶€ ì½”ë“œ íŒíŠ¸ë§Œ ë°˜ì˜)
        let bSum = 0, nbSum = 0;

        // consult í¬í•¨(í˜„ì¬ ì„ íƒ ê¸°ì¤€)
        if (currentConsult && currentConsult !== "none"){
            const cPrice = CONSULT_PRICES[currentConsult] || 0;
            bSum += cPrice;
        }

        const it = (setObj && setObj.it) ? setObj.it : [];
        it.forEach(item=>{
            const rawCode = (item && item.c!=null) ? String(item.c) : "";
            const codeU = normalizeCodeForLookup(rawCode);
            const name = (item && item.n!=null) ? String(item.n) : "";
            const q = parseFloat(item.q) || 0;

            // ê°€ê²© ì¡°íšŒ (fee ìš°ì„ , ê·¸ ë‹¤ìŒ drug, mat)
            let info = null;
            if (DB.fee && DB.fee[codeU]) info = DB.fee[codeU];
            else if (DB.drug && DB.drug[codeU]) info = DB.drug[codeU];
            else if (DB.mat && DB.mat[codeU]) info = DB.mat[codeU];

            let p = info ? (info[1]||0) : 0;
            if (STRATEGY_DRUGS && STRATEGY_DRUGS.some(sd => name.includes(sd))) p = 100000;

            const isNb = !!(item.nb) || /SONO|C-ARM/i.test(codeU);
            if (isNb) nbSum += (p*q);
            else bSum += (p*q);
        });

        const bPay = Math.floor(Math.floor(bSum * 0.3) / 10) * 10;
        const finalPay = Math.floor((bPay + nbSum) / 10) * 10;
        return { bSum, nbSum, bPay, finalPay };
    }

    function computeSetMeta(){
        SET_META = {};
        if (!DB.sets) return;

        Object.keys(DB.sets).forEach(key=>{
            let setObj = DB.sets[key];
            setObj = normalizeSet(setObj);
            DB.sets[key] = setObj;

            const isInj = isInjectionSet(setObj);
            const spinePrefix = inferSpineRegion(setObj); // C/T/L or ""
            const mainTag = detectMainTag(setObj);

            // ë¶€ìœ„ ê²°ì •: central(ì²™ì¶”) íŒíŠ¸ê°€ ìˆìœ¼ë©´ spine, ì•„ë‹ˆë©´ ë§ì´ˆ
            let part = "ê¸°íƒ€";

            // ë¶€ìœ„ íŒì •:
            //  - central block(MBB/SNRB/FJB/EPI ë“±)ì´ ìˆìœ¼ë©´ ê²½ì¶”/í‰ì¶”/ìš”ì¶” ìš°ì„ 
            //  - peripheral blockë§Œ ìˆìœ¼ë©´ peripheral ë¶€ìœ„ ì‚¬ìš©
            //  - PDNBëŠ” ë³´ì¡°ì„±ê²©(ë‹¨ë…ì¼ ë•Œë§Œ spine íŒíŠ¸)
            const centralQty = (
                sumBlockQty(setObj, [/í›„ì§€ë‚´ì¸¡ì§€/i, /\bMBB\b/i]) +
                sumBlockQty(setObj, [/ì„ íƒê·¼ì‹ ê²½ê·¼/i, /\bSNRB\b/i]) +
                sumBlockQty(setObj, [/ì¶”ê°„ê´€ì ˆ/i, /\bFJB\b/i]) +
                sumBlockQty(setObj, [/ê²½ë§‰ì™¸|EPIDURO|\bEPI\b/i])
            );
            const pdnbQty = sumBlockQty(setObj, [/ì²™ìˆ˜ì‹ ê²½í›„ì§€/i, /\bPDNB\b/i]);

            const perPart = inferPeripheralPart(setObj);
            const spine = inferSpineRegion(setObj); // C/T/L or ""
            const spineToKo = (sp)=> (sp==="C"?"ê²½ì¶”":(sp==="T"?"í‰ì¶”":(sp==="L"?"ìš”ì¶”":"")));

            if (isInj){
                if (centralQty > 0){
                    part = spineToKo(spine) || "ìš”ì¶”";
                } else if (perPart && perPart !== "ê¸°íƒ€"){
                    part = perPart;
                } else if (pdnbQty > 0){
                    part = spineToKo(spine) || "ìš”ì¶”";
                } else {
                    part = perPart || "ê¸°íƒ€";
                }
            } else {
                part = perPart || "ê¸°íƒ€";
            }

            const blocks = buildBlocksLabel(setObj, spinePrefix);
            const calcRes = calcFinalPayForSet(setObj);
            const tier = extractTierFromNameOrMeta(setObj, calcRes.finalPay);

            // ë¼ë²¨ êµ¬ì„±(ê¸°ë³¸: [ì½”ë“œ] ì›ë³¸ëª… ìœ ì§€, ë‹¨ databaseëŠ” ê°€ê³µ)
            let label = `[${key}] ${setObj.n || ""}`;
            label = label.replace(/\+\s*0\.\d{3}\.\d{3}/g,"").replace(/\s{2,}/g," ").trim();

            // database ì„±ê²©ì˜ íŒŒì¼(set_databaset ì„ íƒ ì‹œ)ì—ì„œëŠ” ìµœëŒ€í•œ ê°€ê³µ ë¼ë²¨ ì‚¬ìš©
            const fLower = (CURRENT_SET_FILE || "").toLowerCase();
            const isDatabase = (fLower === "set_databaset.json" || fLower === "ì‹ ê²½ì°¨ë‹¨ìˆ  ì¡°í•©.json");
            if (isDatabase){
                const rightParts = [];
                if (mainTag) rightParts.push(mainTag);
                blocks.forEach(b=>rightParts.push(b));
                const right = rightParts.join(" + ");
                const tierTxt = (tier!=null) ? tier.toFixed(1) : "";
                label = `[${part}] ${tierTxt}${right?(" " + right):""}`.trim();
            }


            // ë¼ë²¨ì´ ë¹„ì—ˆê±°ë‚˜ []ë¡œ ì‹œì‘í•˜ë©´(ë¶„ë¥˜ ì‹¤íŒ¨/ì •ë¦¬ ê³¼ì •) ì›ë˜ ëª…ì¹­ìœ¼ë¡œ ë˜ëŒë¦¼
            if (!label || /^\[\s*\]/.test(label)) {
                label = ((setObj && setObj.n) ? setObj.n : key) || "(ì´ë¦„ì—†ìŒ)";
                label = String(label).replace(/\s{2,}/g, " ").trim();
            }
            const orderIdx = PART_ORDER.indexOf(part);
            const sortKey = (orderIdx<0?999:orderIdx).toString().padStart(3,"0") + "_" + key;
            const search = (key + " " + (setObj.n||"") + " " + label + " " + part + " " + blocks.join(" ")).toUpperCase();

            SET_META[key] = { label, search, part, sortKey, isInj, tier, mainTag, blocks };
        });
    }

    function toggleInjectionOnly(){
        INJ_ONLY = !!document.getElementById('injOnlyToggle')?.checked;
        refreshSetCodes();
        // ê²€ìƒ‰ ì…ë ¥ì´ ë‚¨ì•„ìˆìœ¼ë©´ ì¬í•„í„°
        const inp = document.getElementById('setSearchInput');
        if (inp && inp.value) searchSets(inp.value, inp);
    }

function refreshSetCodes() {
        const sel = document.getElementById('setSel');
        if (!sel) return;

        const prev = sel.value;

        if (!DB.sets || Object.keys(DB.sets).length === 0) {
            sel.innerHTML = '<option value="">-- ì²˜ë°© ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
            return;
        }

        // ë©”íƒ€ ì¬ê³„ì‚°
        computeSetMeta();

        // í‚¤ ëª©ë¡(í•„í„° + ì •ë ¬)
        let keys = Object.keys(DB.sets);
        if (INJ_ONLY) keys = keys.filter(k => SET_META[k] && SET_META[k].isInj);

        keys.sort((a,b)=>{
            const ka = SET_META[a]?.sortKey || a;
            const kb = SET_META[b]?.sortKey || b;
            return ka.localeCompare(kb);
        });

        // ê·¸ë£¹(ë¶€ìœ„)ë³„ í—¤ë” ì˜µì…˜ ì‚½ì…
        const byPart = {};
        keys.forEach(k=>{
            const p = SET_META[k]?.part || "ê¸°íƒ€";
            (byPart[p] ||= []).push(k);
        });

        const order = PART_ORDER.filter(p => byPart[p] && byPart[p].length);
        let html = '<option value="">-- ì²˜ë°© ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';

        order.forEach(p=>{
            // cycle header
            html += `<option value="" disabled>â”€â”€ ${p} â”€â”€</option>`;
            byPart[p].forEach(k=>{
                const lab = (SET_META[k] && SET_META[k].label) ? SET_META[k].label : `[${k}] ${(DB.sets[k]&&DB.sets[k].n)||""}`;
                html += `<option value="${k}">${lab}</option>`;
            });
        });

        // ê¸°íƒ€ê°€ ë‚¨ì•˜ìœ¼ë©´ ë§ˆì§€ë§‰ì—
        const rest = keys.filter(k => !order.includes(SET_META[k]?.part||"ê¸°íƒ€"));
        if (rest.length){
            html += `<option value="" disabled>â”€â”€ ê¸°íƒ€ â”€â”€</option>`;
            rest.forEach(k=>{
                const lab = SET_META[k]?.label || `[${k}] ${(DB.sets[k]&&DB.sets[k].n)||""}`;
                html += `<option value="${k}">${lab}</option>`;
            });
        }

        sel.innerHTML = html;

        if (prev && DB.sets && DB.sets[prev]) { sel.value = prev; }
    }

    // set íŒŒì¼ ì„ íƒ/ë¡œë“œ
    let CURRENT_SET_FILE = "";
    async function changeSetFile() {
        const sel = document.getElementById('setFileSel');
        const file = sel ? sel.value : "";
        if (!file) return;

        try {
            document.getElementById('setFileStatus').innerText = "ë¡œë”©...";
            const raw = await fetchJsonFromGithub(file);
            const sets = unwrapData(raw);
            DB.sets = (sets && typeof sets === 'object') ? sets : {};
            CURRENT_SET_FILE = file;

            // í‘œì‹œëª…
            document.getElementById('setFileStatus').innerText = setFileDisplayName(file) + ` (${Object.keys(DB.sets).length}ê°œ)`;

            // ë©”íƒ€/ì„¸íŠ¸ ì½”ë“œ ëª©ë¡ ê°±ì‹ 
            computeSetMeta();
            refreshSetCodes();
            // ì„ íƒ ì´ˆê¸°í™” + í™”ë©´ ì´ˆê¸°í™”
            document.getElementById('setSel').value = "";
            document.getElementById('dataView').style.display = 'none';

            currentCustomItems = [];
            deletedSetItems.clear();
            document.getElementById('ccSwitch').checked = true;
            document.getElementById('ccContent').style.display = 'block';

            // statusëŠ” í‘œì‹œëª… ìœ ì§€
            // document.getElementById('setFileStatus').innerText = file;
        } catch(e) {
            console.error("set íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:", e);
            document.getElementById('setFileStatus').innerText = "ë¡œë“œ ì‹¤íŒ¨";
            DB.sets = {};
            refreshSetCodes();
        }
    }

    // [í•µì‹¬] poket(í¬ì¼“) ìë™ ë¶„ë¦¬: it ì•ˆì— ì„ì¸ PLAN/ë©”ëª¨/ì¦ìƒ/ìƒë³‘ì„ cc/dgë¡œ ì •ë¦¬
    function dbHasCode(codeUpper) {
        return !!(
            (DB.fee && DB.fee[codeUpper]) ||
            (DB.drug && DB.drug[codeUpper]) ||
            (DB.mat && DB.mat[codeUpper])
        );
    }

    function looksLikeCC(codeRaw, nameRaw) {
        const c = (codeRaw || "").toString().trim();
        const n = (nameRaw || "").toString().trim();
        if (!c && !n) return true;

        if (/^\d+$/.test(c) && c.length <= 3) return true;  // 2,3,4... ê°™ì€ ë²ˆí˜¸ ë¼ì¸(ì§§ì€ ì½”ë“œë§Œ)
        if (/^\d+\.\s*/.test(n)) return true;             // "1. C : ..." ê°™ì€ ë¼ì¸
        if (/^â–¼.*â–¼$/.test(n)) return true;                // "â–¼PLANâ–¼", "â–¼F/Uâ–¼"
        if (n.startsWith("*")) return true;               // "* ì£¼ê¸°ì¹˜ë£Œì‚¬..."
        if (n.endsWith(":")) return true;                 // "ê²½ê³¼ì¼ :" "ë‹¤ìŒ ì£¼ì‚¬ì¼ :"
        const hints = ["PLAN", "F/U", "ê²½ê³¼ì¼", "ë‹¤ìŒ ì£¼ì‚¬ì¼", "ì£¼ê¸°ì¹˜ë£Œì‚¬"];
        if (hints.some(h => n.toUpperCase().includes(h.toUpperCase()))) return true;

        return false;
    }

    function looksLikeDiagnosis(codeUpper, nameRaw) {
        if (dbHasCode(codeUpper)) return false;           // DBì— ìˆìœ¼ë©´ ì²˜ë°© í•­ëª©
        if (!/^[A-Z]{1,2}\d{2,5}$/.test(codeUpper)) return false;

        const n = (nameRaw || "").toString();
        // ì§„ë‹¨ì´ ì•„ë‹ˆë¼ ì‹œìˆ /ê²€ì‚¬/ì¹˜ë£Œ ì„±ê²©ì´ë©´ ì œì™¸
        const procHints = ["ìˆ ", "ê²€ì‚¬", "ì´¬ì˜", "ì´ˆìŒíŒŒ", "ì£¼ì‚¬", "ì°¨ë‹¨", "ë„ìˆ˜", "ë¬¼ë¦¬", "ì¹˜ë£Œ", "ì‹œìˆ ", "í…Œì´í•‘", "C-ARM", "MRI", "X-RAY", "XRAY", "Xray"];
        if (procHints.some(h => n.includes(h))) return false;

        // [ìˆ˜ì •: io300 ê°™ì€ ì•½í’ˆì½”ë“œ ì˜¤ë¶„ë¥˜ ë°©ì§€]
        // ìƒë³‘ì½”ë“œ í˜•ì‹ì´ë”ë¼ë„, ëª…ì¹­ì— ì•½í’ˆ/ì¬ë£Œ ë‹¨ìœ„ë‚˜ íŠ¹ì • í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ìƒë³‘ ì•„ë‹˜(ì²˜ë°©ìœ¼ë¡œ ì´ë™)
        const drugHints = ["ì£¼", "mg", "ml", "g", "tab", "cap", "ì •", "ìº¡ìŠ", "ì•°í”Œ", "vial", "ë°”ì´ì•Œ", "ë¸Œë¦­ìŠ¤", "io", "block"];
        const upperN = n.toUpperCase();
        if (drugHints.some(h => upperN.includes(h.toUpperCase()))) return false;

        return true;
    }

    function normalizeSet(setObj) {
        if (!setObj || typeof setObj !== 'object') return setObj;
        if (setObj.__normalized) return setObj;

        const cc = Array.isArray(setObj.cc) ? [...setObj.cc] : [];
        const dg = Array.isArray(setObj.dg) ? [...setObj.dg] : [];
        const it = Array.isArray(setObj.it) ? [...setObj.it] : [];

        const newIt = [];
        it.forEach(item => {
            const cRaw = (item && item.c != null) ? String(item.c).trim() : "";
            const nRaw = (item && item.n != null) ? String(item.n).trim() : "";
            const codeUpper = cRaw.toUpperCase();

            // ë¹ˆ ì¤„(ë²ˆí˜¸ë§Œ ìˆê³  ë‚´ìš© ì—†ìŒ)ì€ ë¬´ì‹œ
            if (/^\d+$/.test(cRaw) && nRaw === "") return;

            if (looksLikeCC(cRaw, nRaw)) {
                if (nRaw) cc.push(nRaw);
                return;
            }

            if (looksLikeDiagnosis(codeUpper, nRaw)) {
                dg.push({ c: cRaw, n: nRaw || cRaw });
                return;
            }

            newIt.push(item);
        });

        return { ...setObj, cc, dg, it: newIt, __normalized: true };
    }

    async function init() {
        try {
            // fee/drug/mat ë¶„ë¦¬ ë¡œë“œ
            DB = { fee: {}, drug: {}, mat: {}, sets: {}, dates: {} };
            let datesFromDatabase = null;

            try {
                const feeRaw = await fetchJsonFromGithub("fee.json");
                DB.fee = unwrapData(feeRaw);
            } catch(e) { console.warn("fee.json ë¡œë“œ ì‹¤íŒ¨", e); }

            try {
                const drugRaw = await fetchJsonFromGithub("drug.json");
                DB.drug = unwrapData(drugRaw);
            } catch(e) { console.warn("drug.json ë¡œë“œ ì‹¤íŒ¨", e); }

            try {
                const matRaw = await fetchJsonFromGithub("mat.json");
                DB.mat = unwrapData(matRaw);
            } catch(e) { console.warn("mat.json ë¡œë“œ ì‹¤íŒ¨", e); }

            // [ì¶”ê°€] override.json (ì˜µì…˜) - ì»¤ìŠ¤í…€ ì½”ë“œ/ë‹¨ê°€/ì½”ë“œë³„ ì˜ˆì™¸ë¥¼ ì—¬ê¸°ì— ëˆ„ì 
            //  - fee/drug/mat ìµœìƒìœ„ë¡œ ë³‘í•©ë˜ë©°, ê°™ì€ ì½”ë“œëŠ” overrideê°€ ìš°ì„ í•©ë‹ˆë‹¤.
            let overrideRaw = null;
            try { overrideRaw = await fetchJsonFromGithub("override.json"); } catch(e) {}
            const overrideObj = overrideRaw ? unwrapData(overrideRaw) : null;

            // ê¸°ë³¸ ë‚´ì¥ override (ì‚¬ìš©ì ì œê³µ/ë¹ˆë²ˆ í•­ëª©)
            const BUILTIN_OVERRIDE = {
                drug: {
                    "LIDO2": ["ë¦¬ë„ì¹´ì¸ì—¼ì‚° 20ml 2% (íœ´ì˜¨ìŠ¤)", 649, "670603485"],
                    "NS100": ["ëŒ€í•œë©¸ê· ìƒë¦¬ì‹ì—¼ìˆ˜(0.9% 100mL)", 1110, "645100562"],
                    "DW100": ["í¬ë„ë‹¹ì£¼ì‚¬ì•¡(5%) 100mL", 1188, "645100973"]
                }
            };

            function applyOverrides(ov){
                if (!ov) return;
                ["fee","drug","mat"].forEach(cat=>{
                    if (ov[cat] && typeof ov[cat]==="object"){
                        Object.keys(ov[cat]).forEach(code=>{
                            DB[cat][code.toUpperCase()] = ov[cat][code];
                        });
                    }
                });
            }
            // ìˆœì„œ: built-in -> override.json
            applyOverrides(BUILTIN_OVERRIDE);
            applyOverrides(overrideObj);



            // fee/drug/mat ì¤‘ ì¼ë¶€ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ê¸°ì¡´ database.jsonì—ì„œ ë³´ê°•(í˜¸í™˜ìš©)
            try {
                if (!DB.fee || Object.keys(DB.fee).length === 0 ||
                    !DB.drug || Object.keys(DB.drug).length === 0 ||
                    !DB.mat || Object.keys(DB.mat).length === 0) {
                    const resAll = await fetch(RAW_BASE + "database.json?t=" + Date.now());
                    if (resAll.ok) {
                        const dbAll = await resAll.json();
                        if (dbAll) {
                            if ((!DB.fee || Object.keys(DB.fee).length === 0) && dbAll.fee) DB.fee = dbAll.fee;
                            if ((!DB.drug || Object.keys(DB.drug).length === 0) && dbAll.drug) DB.drug = dbAll.drug;
                            if ((!DB.mat || Object.keys(DB.mat).length === 0) && dbAll.mat) DB.mat = dbAll.mat;
                        }
                    }
                }
            } catch(e) {}

            // (í‘œì‹œìš©) datesëŠ” ê¸°ì¡´ database.jsonì—ì„œ ê°€ì ¸ì˜¤ë˜, fee/drug/matì€ ìœ„ ê°’ì„ ìœ ì§€
            try {
                const resDates = await fetch(RAW_BASE + "database.json?t=" + Date.now());
                if (resDates.ok) {
                    const dbAll = await resDates.json();
                    if (dbAll && dbAll.dates) datesFromDatabase = dbAll.dates;
                }
            } catch(e) {}

            if (datesFromDatabase) DB.dates = datesFromDatabase;

            // syncBoard
            const displayDate = (() => {
                // 1) database.json dates (í˜¸í™˜)
                if (DB.dates) {
                    const cand = DB.dates.fee || DB.dates.apply || DB.dates.applied || DB.dates.updated || DB.dates.date;
                    if (cand && cand !== "-") return String(cand);
                }
                // 2) fee.json meta ì¶”ì •
                try {
                    if (typeof feeRaw !== "undefined" && feeRaw) {
                        const meta = feeRaw.meta || feeRaw.dates || feeRaw.date || feeRaw.updated || feeRaw.updatedAt || feeRaw.applyDate || feeRaw.appliedDate;
                        if (meta && typeof meta === "string") return meta;
                        const txt = JSON.stringify(feeRaw);
                        const m = txt.match(/(\d{2,4}[\./-]\d{1,2}[\./-]\d{1,2})/);
                        if (m) return m[1];
                    }
                } catch(e) {}
                return "-";
            })();
            document.getElementById('st-date').innerText = displayDate;

            // ì§„ì°°ë£Œ ë²„íŠ¼
            const feeFirst = getFeePrice('AA154') || 17610;
            const feeFollow = getFeePrice('AA254') || 12590;
            CONSULT_PRICES = { first: feeFirst, follow: feeFollow };
            document.getElementById('btn-first').innerText = `ì´ˆì§„ (${fmt(feeFirst)})`;
            document.getElementById('btn-follow').innerText = `ì¬ì§„ (${fmt(feeFollow)})`;

            // flatDB ì¬êµ¬ì„± (ê²€ìƒ‰ìš©)
            flatDB = [];
            const cats = ["fee", "drug", "mat"];
            cats.forEach(cat => {
                if (!DB[cat]) return;
                for (let code in DB[cat]) {
                    flatDB.push({ code, name: DB[cat][code][0], price: DB[cat][code][1] });
                }
            });
            document.getElementById('st-db').innerText = fmt(flatDB.length) + "ê±´";

            // ì„¸íŠ¸ì½”ë“œ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            refreshSetCodes();

            // set*.json íŒŒì¼ ë“œë¡­ë‹¤ìš´ ì¤€ë¹„
            
            // set*.json íŒŒì¼ ë“œë¡­ë‹¤ìš´ ì¤€ë¹„
            const files = await listSetFiles();

            const setSel = document.getElementById('setFileSel');
            if (setSel) {
                // í‘œì‹œëª…(text)ë§Œ ë°”ê¾¸ê³ , value(ì‹¤ì œ íŒŒì¼ëª…)ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
                const options = [];
                if (!files || files.length === 0) {
                    setSel.innerHTML = '<option value="">set*.json ì—†ìŒ</option>';
                    document.getElementById('setFileStatus').innerText = "-";
                } else {
                    // ì •ë ¬: set_databaset ìš°ì„ , ë‚˜ë¨¸ì§€ëŠ” íŒŒì¼ëª… ê¸°ì¤€
                    const norm = (files || []).slice().sort((a,b)=>{
                        const al = a.toLowerCase(), bl = b.toLowerCase();
                        if (al === "set_databaset.json") return -1;
                        if (bl === "set_databaset.json") return 1;
                        return al.localeCompare(bl);
                    });

                    norm.forEach(f=>{
                        const text = setFileDisplayName(f);
                        options.push(`<option value="${f}">${text}</option>`);
                    });

                    setSel.innerHTML = options.join("");

                    // ê¸°ë³¸: set_databaset.jsonì´ ìˆìœ¼ë©´ ìë™ ë¡œë“œ, ì—†ìœ¼ë©´ ì²«ë²ˆì§¸
                    const preferred = norm.find(f=>{const l=f.toLowerCase(); return l==="set_databaset.json" || l==="ì‹ ê²½ì°¨ë‹¨ìˆ  ì¡°í•©.json";}) || norm[0];
                    setSel.value = preferred;
                    await changeSetFile();
                }
            }
} catch(e) {
            console.error("DB ë¡œë“œ ì‹¤íŒ¨", e);
        }
    }


    function getFeePrice(code) {
        if(DB.fee && DB.fee[code]) return DB.fee[code][1];
        if(DB.fee) { const key = Object.keys(DB.fee).find(k => k.startsWith(code)); if(key) return DB.fee[key][1]; }
        return 0;
    }

    function setTarget(val) { document.getElementById('tAmt').value = val; autoBalance(); }
    
    function changeSet() { 
        currentCustomItems = []; 
        deletedSetItems.clear(); 
        document.getElementById('ccSwitch').checked = true;
        document.getElementById('ccContent').style.display = 'block';
        renderItems(); 
    }
    
    function setConsult(type) {
        currentConsult = type;
        document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + type).classList.add('active');
        // ë“œë¡­ë‹¤ìš´ ë¼ë²¨(ê¸ˆì•¡/ë¶€ìœ„)ë„ consultì— ë”°ë¼ ë³€í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°±ì‹ 
        computeSetMeta();
        refreshSetCodes();
        renderItems();
    }

    function toggleCC() {
        const box = document.getElementById('ccContent');
        const sw = document.getElementById('ccSwitch');
        box.style.display = sw.checked ? 'block' : 'none';
    }

    // [ì‹ ê·œ] ì„¸íŠ¸ ê²€ìƒ‰ ê¸°ëŠ¥
    function searchSets(val, inputEl) {
        const layer = document.getElementById('globalSearchLayer');
        activeInputEl = inputEl; // ì„¸íŠ¸ ì„ íƒìš© ë§ˆí‚¹

        if(!val || val.length < 1) { layer.style.display = 'none'; return; }

        computeSetMeta();

        const rect = inputEl.getBoundingClientRect();
        layer.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        layer.style.left = (rect.left + window.scrollX) + 'px';
        layer.style.width = Math.max(300, rect.width) + 'px';

        const q = val.toUpperCase();
        let keys = Object.keys(DB.sets || {});
        if (INJ_ONLY) keys = keys.filter(k => SET_META[k] && SET_META[k].isInj);

        const filtered = keys.filter(k => {
            const meta = SET_META[k];
            if (!meta) return false;
            return meta.search.includes(q);
        }).slice(0, 40);

        layer.innerHTML = filtered.map(k => {
            const meta = SET_META[k];
            const lab = meta ? meta.label : `[${k}] ${(DB.sets[k]&&DB.sets[k].n)||""}`;
            return `
                <div class="search-item" onclick="selectSetFromSearch('${k}')">
                    <span style="color:#0052cc; font-weight:900;">${lab}</span>
                </div>`;
        }).join('');

        layer.style.display = filtered.length ? 'block' : 'none';
    }

    function selectSetFromSearch(key) {
        document.getElementById('setSel').value = key;
        document.getElementById('setSearchInput').value = '';
        clearSearch();
        changeSet();
    }

    // í†µí•© ê²€ìƒ‰ ë¡œì§ (ì²˜ë°©, ì½”ë“œ, ì„¸íŠ¸ ê³µìš©)
    function searchLive(val, mode, inputEl) {
        activeInputEl = inputEl;
        const layer = document.getElementById('globalSearchLayer');
        
        if(!val || val.length < 2) { layer.style.display = 'none'; return; }
        
        const rect = inputEl.getBoundingClientRect();
        layer.style.top = (rect.bottom + window.scrollY + 5) + 'px';
        layer.style.left = (rect.left + window.scrollX) + 'px';
        layer.style.width = Math.max(300, rect.width) + 'px';

        const filtered = flatDB.filter(i => i.code.includes(val.toUpperCase()) || i.name.includes(val)).slice(0, 30);
        
        layer.innerHTML = filtered.map(i => `
            <div class="search-item" onclick="selectItem('${i.code}', '${i.name.replace(/'/g, "\\'")}', ${i.price}, '${mode}')">
                <span style="color:#0052cc; font-weight:800;">${i.code}</span>
                <span style="flex:1; margin:0 10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${i.name}</span>
                <b>${fmt(i.price)}</b>
            </div>`).join('');
        layer.style.display = filtered.length ? 'block' : 'none';
    }

    function selectItem(code, name, price, mode) {
        const layer = document.getElementById('globalSearchLayer');
        if (mode === 'main') {
            addSearchedItem(code, name, price);
        } else if (mode === 'cell' && activeInputEl) {
            const tr = activeInputEl.closest('tr');
            const codeInput = tr.querySelector('.box-input.code-type'); 
            codeInput.value = code; 
            updateRowByCode(codeInput, tr.dataset.custom === 'true', tr.dataset.idx);
        }
        layer.style.display = 'none';
        activeInputEl = null;
    }

    function clearSearch() { document.getElementById('globalSearchLayer').style.display = 'none'; }
    function closeSearch(e) { 
        if (!e.target.closest('#searchBox') && !e.target.closest('.input-wrapper') && !e.target.closest('.set-selector-group') && !e.target.closest('.search-dropdown')) {
            clearSearch();
        }
    }
    
    function addSearchedItem(code, name, price) {
        let finalPrice = price; if (STRATEGY_DRUGS.some(sd => name.includes(sd))) finalPrice = 100000;
        currentCustomItems.push({ code, name, price: finalPrice, q: 1, nb: false, lock: false, isManual: false });
        clearSearch(); document.getElementById('searchInput').value = ''; renderItems();
    }
    
    function addManualItem() { 
        currentCustomItems.push({ code: "ETC", name: "ì„ì˜ í•­ëª©", price: 0, q: 1, nb: false, lock: false, isManual: true }); 
        renderItems(); 
    }

    function renderItems() {
        const key = document.getElementById('setSel').value;
        if(!key) return;
        let set = DB.sets[key];
        set = normalizeSet(set);
        DB.sets[key] = set;
        document.getElementById('dataView').style.display = 'block';
        
        document.getElementById('ccContent').innerHTML = (set.cc && set.cc.length > 0) ? set.cc.join('<br>') : "ë“±ë¡ëœ ì¦ìƒ ì—†ìŒ";
        
        const diagList = set.dg || [];
        const diagSection = document.getElementById('diagSection');
        const diagTbody = document.getElementById('diagList');
        diagTbody.innerHTML = '';
        
        if (diagList.length > 0) {
            diagSection.style.display = 'block';
            diagList.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="diag-code">${d.c}</td><td>${d.n}</td>`;
                diagTbody.appendChild(tr);
            });
        } else {
            diagSection.style.display = 'none';
        }

        const tbody = document.getElementById('itemList');
        tbody.innerHTML = '';
        
        
        if(currentConsult !== "none") {
            const consultCode = currentConsult === 'first' ? "AA154" : "AA254";
            const dbPrice = getFeePrice(consultCode);
            const price = dbPrice || CONSULT_PRICES[currentConsult] || 0;
            const dbName = (DB.fee && DB.fee[consultCode] && DB.fee[consultCode][0]) ? DB.fee[consultCode][0] : null;
            const name = dbName || (currentConsult === 'first' ? "ì§„ì°°ë£Œ(ì´ˆì§„)" : "ì§„ì°°ë£Œ(ì¬ì§„)");
            const codeToUse = dbPrice ? consultCode : "CONST";
            addRow(tbody, codeToUse, name, price, 1, false, true, false);
        }

        set.it.forEach(item => {
            const code = item.c.toUpperCase();
            if (deletedSetItems.has(code)) return; 

            if (carryOverItems.has(code)) {
                const c = carryOverItems.get(code);
                addRow(tbody, code, c.name, c.price, c.q, c.nb, c.lock, true);
            } else {
                const info = DB.fee[code] || DB.drug[code] || DB.mat[code] || null;
                let name = info ? info[0] : (item.n || code);
                let price = info ? info[1] : 0;
                if (STRATEGY_DRUGS.some(sd => name.includes(sd))) price = 100000;
                addRow(tbody, code, name, price, item.q, item.nb, !item.nb || code.includes('SONO') || code.includes('C-ARM'), false);
            }
        });

        currentCustomItems.forEach((item, idx) => {
            if (carryOverItems.has(item.code)) return;
            if (item.isDeleted) return; 
            addRow(tbody, item.code, item.name, item.price, item.q, item.nb, item.lock, false, true, idx);
        });

        carryOverItems.forEach((c, code) => {
            const exists = Array.from(tbody.rows).some(r => r.cells[0].innerText === code);
            if (!exists) addRow(tbody, code, c.name, c.price, c.q, c.nb, c.lock, true);
        });

        autoBalance();
        // [ì¶”ê°€] ì°¨ë‹¨ìˆ  ì¡°ì • ë²„íŠ¼ ì¬ë Œë”ë§
        renderBlockAdjuster();
    }

    function addRow(target, code, name, price, qty, isNB, isLocked, isCarry, isCustom = false, customIdx = null) {
        const tr = document.createElement('tr');
        tr.dataset.type = isNB ? 'nb' : 'b';
        tr.dataset.code = code;
        if(isCustom) { tr.dataset.custom = 'true'; tr.dataset.idx = customIdx; }

        let nameHtml = `<div class="input-wrapper"><input class="box-input" value="${name}" oninput="searchLive(this.value, 'cell', this)" onfocus="searchLive(this.value, 'cell', this)">`;
        
        // [ìˆ˜ì •] ì¡°ì˜í•„ìš” ë°°ì§€ ì¡°ê±´: HAë¡œ ì‹œì‘í•˜ê±°ë‚˜, ê¸°ì¡´ CONTRAST_REQUIRED_CODES ëª©ë¡ì— ìˆëŠ” ê²½ìš°(LA ì¼íšŒì„± ë“±)
        if (CONTRAST_REQUIRED_CODES.includes(code) || code.startsWith('HA')) {
            nameHtml += `<span class="badge badge-req">ì¡°ì˜í•„ìš”</span>`;
        }
        const upperName = name.toUpperCase();
        if (CONTRAST_KEYWORDS.some(k => upperName.includes(k))) {
            nameHtml += `<span class="badge badge-con">ì¡°ì˜ì œ</span>`;
        }
        nameHtml += `</div><div class="audit-msg" style="color:var(--accent); font-size:11px; font-weight:800; margin-top:2px;"></div>`;

        const typeBtnHtml = `
            <button class="type-btn ${isNB ? 'type-nb' : 'type-b'}" onclick="toggleType(this, '${code}', ${isCustom}, ${customIdx})">
                ${isNB ? 'ë¹„ê¸‰ì—¬' : 'ê¸‰ì—¬'}
            </button>
        `;

        tr.innerHTML = `
            <td><div class="input-wrapper"><input class="box-input code-type" value="${code}" onchange="updateRowByCode(this, ${isCustom}, ${customIdx})" oninput="searchLive(this.value, 'cell', this)"></div></td>
            <td>${nameHtml}</td>
            <td><input class="box-input-num p-input" value="${fmt(price)}" oninput="syncRow(this, '${code}', ${isCustom}, ${customIdx})"></td>
            <td><input class="box-input-num q-input" type="number" value="${qty}" step="0.1" oninput="syncRow(this, '${code}', ${isCustom}, ${customIdx})"></td>
            <td>${typeBtnHtml}</td>
            <td><button class="carry-btn ${isCarry?'active':''}" onclick="toggleCarry(this, '${code}')">ğŸ“Œ</button></td>
            <td><button class="del-btn" onclick="deleteRow(this, '${code}', ${isCustom}, ${customIdx})">ğŸ—‘ï¸</button></td>
        `;
        target.appendChild(tr);
    }

    function updateRowByCode(input, isCustom, idx) {
        const newCode = input.value.toUpperCase();
        const tr = input.closest('tr');
        
        const found = flatDB.find(i => i.code === newCode);
        
        if (found) {
            tr.querySelector('.box-input:not(.code-type)').value = found.name;
            tr.querySelector('.p-input').value = fmt(found.price);
            tr.dataset.code = newCode;
            
            if (isCustom && idx !== null) {
                currentCustomItems[idx].code = newCode;
                currentCustomItems[idx].name = found.name;
                currentCustomItems[idx].price = found.price;
            }
        }
        autoBalance();
        renderBlockAdjuster(); // [ì¶”ê°€] ì½”ë“œê°€ ë°”ë€Œë©´ ì°¨ë‹¨ìˆ  ëª©ë¡ë„ ë°”ë€” ìˆ˜ ìˆìŒ
    }

    function toggleType(btn, code, isCustom, idx) {
        const tr = btn.closest('tr');
        const isNowNB = btn.innerText === 'ê¸‰ì—¬'; 
        
        btn.innerText = isNowNB ? 'ë¹„ê¸‰ì—¬' : 'ê¸‰ì—¬';
        btn.className = `type-btn ${isNowNB ? 'type-nb' : 'type-b'}`;
        tr.dataset.type = isNowNB ? 'nb' : 'b';

        if (carryOverItems.has(code)) carryOverItems.get(code).nb = isNowNB;
        if (isCustom && idx !== null) currentCustomItems[idx].nb = isNowNB;
        
        autoBalance();
    }

    function deleteRow(btn, code, isCustom, idx) {
        if (carryOverItems.has(code)) carryOverItems.delete(code);
        if (isCustom && idx !== null) { currentCustomItems.splice(idx, 1); } 
        else { deletedSetItems.add(code); }
        renderItems(); 
    }

    function syncRow(el, code, isCustom, idx) {
        const tr = el.closest('tr');
        const p = clean(tr.querySelector('.p-input').value);
        const q = parseFloat(tr.querySelector('.q-input').value) || 0;
        if (carryOverItems.has(code)) { const c = carryOverItems.get(code); c.price = p; c.q = q; }
        if (isCustom && idx !== null) { currentCustomItems[idx].price = p; currentCustomItems[idx].q = q; }
        if (el.classList.contains('p-input')) el.value = fmt(p);
        autoBalance();
    }

    function toggleCarry(btn, code) {
        const tr = btn.closest('tr');
        btn.classList.toggle('active');
        const currentCode = tr.querySelector('.box-input.code-type').value; 
        
        if (btn.classList.contains('active')) {
            carryOverItems.set(currentCode, { 
                name: tr.querySelector('.box-input:not(.code-type)').value, 
                price: clean(tr.querySelector('.p-input').value), 
                q: parseFloat(tr.querySelector('.q-input').value) || 0, 
                nb: tr.dataset.type === 'nb', 
                lock: false
            });
        } else { carryOverItems.delete(code); } 
    }

    function calc() {
        let bSum = 0, nbSum = 0, laSum = 0;
        let hasContrast = false;
        let needsContrastCode = null;

        document.querySelectorAll('#itemList tr').forEach(tr => {
            const name = tr.querySelector('.box-input:not(.code-type)').value.toUpperCase();
            if (CONTRAST_KEYWORDS.some(k => name.includes(k))) hasContrast = true;
        });

        document.querySelectorAll('#itemList tr').forEach(tr => {
            const code = tr.querySelector('.box-input.code-type').value.toUpperCase(); 
            const name = tr.querySelector('.box-input:not(.code-type)').value;
            const p = clean(tr.querySelector('.p-input').value);
            const q = parseFloat(tr.querySelector('.q-input').value) || 0;
            const msgBox = tr.querySelector('.audit-msg');
            msgBox.innerText = ""; 

            if (code.startsWith('LA')) {
                laSum += q;
                if (code === 'LA357' && q > 1.5) msgBox.innerText = "âš ï¸ LA357 1.5 ì´ˆê³¼";
            }

            if (CONTRAST_REQUIRED_CODES.includes(code) && !hasContrast) {
                needsContrastCode = code;
            }

            if(tr.dataset.type === 'b') bSum += (p * q); else nbSum += (p * q);
        });

        const alertBox = document.getElementById('mainAlertBox');
        let alerts = [];
        if (laSum > 3.0) alerts.push("âš ï¸ ì°¨ë‹¨ìˆ  ì´ í•©ê³„ê°€ 3.0ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (ì‚­ê° ì£¼ì˜)");
        if (needsContrastCode) alerts.push("âš ï¸ ì¡°ì˜ì œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (í•„ìˆ˜ ì‹œìˆ  í¬í•¨ë¨)");

        if (alerts.length > 0) {
            alertBox.innerHTML = alerts.join("<br>");
            alertBox.style.display = "block";
            if (laSum > 3.0) { alertBox.className = "alert-box alert-red"; } 
            else { alertBox.className = "alert-box alert-orange"; }
        } else {
            alertBox.style.display = "none";
        }

        const bPay = Math.floor(Math.floor(bSum * 0.3) / 10) * 10;
        return { totalFull: Math.floor(bSum + nbSum), bPay, nbSum: Math.floor(nbSum), finalPay: Math.floor((bPay + nbSum) / 10) * 10 };
    }

    function autoBalance() {
        const target = clean(document.getElementById('tAmt').value);
        const res = calc();
        const rows = Array.from(document.querySelectorAll('#itemList tr'));
        
        let tRow = rows.find(r => r.dataset.type === 'nb' && STRATEGY_DRUGS.some(sd => r.querySelector('.box-input:not(.code-type)').value.includes(sd)));
        
        if (!tRow) {
            const reversedRows = [...rows].reverse();
            tRow = reversedRows.find(r => r.dataset.type === 'nb');
        }

        if (tRow) {
            const adjName = tRow.querySelector('.box-input:not(.code-type)').value;
            document.getElementById('matrixAdjustName').innerText = `[ì¡°ì •: ${adjName}]`;
            let otherNb = 0;
            rows.forEach(r => { if(r !== tRow && r.dataset.type === 'nb') otherNb += clean(r.querySelector('.p-input').value) * (parseFloat(r.querySelector('.q-input').value) || 0); });
            const pAdj = clean(tRow.querySelector('.p-input').value);
            
            if(pAdj > 0) {
                tRow.querySelector('.q-input').value = ((target - res.bPay - otherNb) / pAdj).toFixed(4);
                
                let mHTML = '';
                const baseThousand = target % 10000;
                const startPrice = Math.max(0, Math.floor(target/10000)*10000 - 50000);
                const endPrice = Math.floor(target/10000)*10000 + 20000;

                for(let i = startPrice; i <= endPrice; i += 10000) {
                    const pt = i + baseThousand;
                    const qP = ((pt - res.bPay - otherNb) / pAdj).toFixed(4);
                    if(qP >= 0) {
                        const bgStyle = (pt === target) ? "background:#eef6ff; border-color:var(--blue);" : "";
                        mHTML += `<div class="matrix-row" onclick="setTarget(${pt})" style="${bgStyle}"><span class="matrix-target">${fmt(pt)}ì›</span><span class="matrix-val">ìˆ˜ëŸ‰ ${qP}</span></div>`;
                    }
                }
                document.getElementById('matrixTable').innerHTML = mHTML;
            }
        }
        const f = calc();
        document.getElementById('totalFull').innerText = fmt(f.totalFull);
        document.getElementById('summaryBenefit').innerText = fmt(f.bPay);
        document.getElementById('summaryNonBenefit').innerText = fmt(f.nbSum);
        document.getElementById('finalPay').innerText = fmt(f.finalPay);
    }
    window.onload = init;


    // ===== [ì‹ ê·œ] ë™ì  ì°¨ë‹¨ìˆ  ë²„íŠ¼ ìƒì„± ë° ì œì–´ ë¡œì§ (ì™„ì „ ê°œí¸) =====
    
    // ì²˜ë°© ë‚´ì—­ì—ì„œ 'LA'ë¡œ ì‹œì‘í•˜ëŠ” í–‰ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì°¾ìŒ
    function getLArows() {
        const rows = Array.from(document.querySelectorAll('#itemList tr'));
        return rows.filter(r => {
            const code = (r.dataset.code || '').toUpperCase();
            // ì…ë ¥ì¹¸ì´ ë¹„ì–´ìˆëŠ” ê²½ìš°(ì´ˆê¸° ìƒíƒœ) ê³ ë ¤
            const inputVal = r.querySelector('.box-input.code-type').value.toUpperCase();
            return (code.startsWith('LA') || inputVal.startsWith('LA'));
        });
    }

    function renderBlockAdjuster() {
        const laRows = getLArows();
        const count = laRows.length;
        // ìµœì†Œ 3ê°œëŠ” ë³´ì—¬ì£¼ê³ , 4ê°œ ì´ìƒì´ë©´ ê·¸ë§Œí¼ ëŠ˜ë¦¼
        const displayCount = Math.max(3, count);
        
        let html = '<div class="section-title" style="border-left-color: var(--blue);">ì°¨ë‹¨ìˆ  ìˆ˜ëŸ‰ ì¡°ì •</div>';

        for(let i=0; i < displayCount; i++) {
            const exists = (i < count);
            let label = `${i+1}ì°¨ë‹¨ìˆ `;
            let name = "";
            let btnDisabled = "";
            
            if (exists) {
                const tr = laRows[i];
                const rawName = tr.querySelector('.box-input:not(.code-type)').value;
                name = `(${rawName})`;
            } else {
                name = `<span style="color:#aaa; font-weight:normal;">(ì—†ìŒ)</span>`;
                btnDisabled = "disabled style='opacity:0.3; cursor:default;'";
            }

            html += `
            <div class="block-adjust-row">
                <div class="block-adjust-label" style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${label} <span style="font-size:0.9em; margin-left:4px;">${name}</span></div>
                <div class="block-adjust-ctrl">
                    <button class="block-btn" ${btnDisabled} onclick="adjustBlockByIndex(${i}, -1)">âˆ’</button>
                    <input id="blockStep_${i}" class="block-step" type="number" value="0.25" step="0.05" ${btnDisabled}>
                    <button class="block-btn" ${btnDisabled} onclick="adjustBlockByIndex(${i}, +1)">ï¼‹</button>
                </div>
            </div>`;
        }
        
        document.getElementById('blockAdjustWrap').innerHTML = html;
    }

    function adjustBlockByIndex(index, dir) {
        const laRows = getLArows();
        if (!laRows[index]) return; // í•´ë‹¹ ìˆœë²ˆì˜ ì°¨ë‹¨ìˆ ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ

        const tr = laRows[index];
        const stepEl = document.getElementById(`blockStep_${index}`);
        const step = stepEl ? (parseFloat(stepEl.value) || 0) : 0;
        
        if (!step) return;

        const qEl = tr.querySelector('.q-input');
        if (!qEl) return;

        const cur = parseFloat(qEl.value) || 0;
        let next = cur + (dir * step);
        if (next < 0) next = 0;
        
        next = Math.round(next * 100) / 100;
        qEl.value = next.toFixed(2).replace(/\.00$/,'\.0').replace(/(\.\d)0$/,'$1');

        // ë³€ê²½ ì‚¬í•­ ë°˜ì˜
        const isCustom = tr.dataset.custom === 'true';
        const idx = isCustom ? parseInt(tr.dataset.idx, 10) : null;
        const code = tr.dataset.code; // or input val
        
        try { syncRow(qEl, code, isCustom, idx); } catch(e) {}
    }

</script>
</body>
</html>
