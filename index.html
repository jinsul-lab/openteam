<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINSUL - Professional Consulting System</title>
    <style>
        :root { --primary: #0052cc; --accent: #d73a49; }
        
        /* 1. ë””ìì¸ ë ˆì´ì•„ì›ƒ ë° ì›Œí„°ë§ˆí¬ */
        body { 
            margin: 0; background-color: #f8f9fa; color: #172b4d; 
            font-family: 'Pretendard', sans-serif; position: relative; min-height: 100vh;
        }
        
        /* ì¤‘ì•™ ì›Œí„°ë§ˆí¬ */
        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60%; opacity: 0.08; z-index: -1; pointer-events: none; filter: grayscale(1);
        }

        header { padding: 30px; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .top-logo { width: 220px; filter: grayscale(1); margin-bottom: 10px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

        /* 2. í‘œ ë° ì¹´ë“œ 100% íˆ¬ëª… ì„¤ì • (Blur íš¨ê³¼ë¡œ ê°€ë…ì„± ìœ ì§€) */
        .card { 
            background: rgba(255, 255, 255, 0); /* ì™„ì „ íˆ¬ëª… */
            border: 1px solid rgba(0,0,0,0.1); border-radius: 15px; padding: 25px; 
            backdrop-filter: blur(2px); margin-bottom: 20px;
        }

        table { width: 100%; border-collapse: collapse; background: transparent !important; }
        th { background: rgba(0,0,0,0.05); padding: 12px; text-align: left; font-size: 0.85em; }
        td { padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); background: transparent !important; }

        input { 
            background: rgba(255, 255, 255, 0.4); 
            border: 1px solid rgba(0, 0, 0, 0.1); 
            padding: 8px; border-radius: 6px; width: 100%; 
        }

        /* ëª©í‘œê°€ ë°•ìŠ¤ */
        .target-box { background: var(--primary); color: white; padding: 35px; border-radius: 20px; text-align: center; }
        .target-input { font-size: 2.8em; width: 200px; background: none; border: none; border-bottom: 3px solid white; color: white; text-align: right; font-weight: 800; outline: none; }

        /* 3. í•˜ë‹¨ ì¹´í”¼ë¼ì´íŠ¸ */
        footer { text-align: center; padding: 60px 0; color: #888; font-size: 0.9em; font-weight: 600; line-height: 1.6; }

        /* ë¡œë”© ì°½ */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        .error-log { color: red; font-size: 0.8em; margin-top: 15px; max-width: 80%; text-align: center; line-height: 1.4; }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; }
        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 20px; font-size: 1.1em; }
        .lock-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.3; }
        .lock-btn.active { opacity: 1; color: var(--accent); }
    </style>
</head>
<body>

<img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="watermark" onerror="this.style.display='none'">

<div id="loader">
    <div style="font-weight: 900; font-size: 1.5em; color: var(--primary); margin-bottom: 10px;">JINSUL ENGINE STARTING...</div>
    <div id="statusText">ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</div>
    <div id="errorLog" class="error-log"></div>
</div>

<header>
    <img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo" alt="JINSUL">
    <div style="font-weight: 700; color: var(--primary); letter-spacing: -0.5px;">í†µí•© ìˆ˜ê°€ ì»¨ì„¤íŒ… ì‹œìŠ¤í…œ</div>
</header>

<div class="container">
    <div class="main-content">
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <select id="bundleSelect" style="flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-weight: 700; background: rgba(255,255,255,0.6);">
                    <option value="">-- ë¶ˆëŸ¬ì˜¬ ë¬¶ìŒì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” (code.xls) --</option>
                </select>
                <button class="btn" onclick="loadBundle()" style="background: #eee;">ë°ì´í„° ë¡œë“œ</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">ì½”ë“œ</th>
                        <th>í•­ëª©ëª…</th>
                        <th style="width: 20%;">ë‹¨ê°€</th>
                        <th style="width: 10%;">ìˆ˜ëŸ‰</th>
                        <th style="width: 8%;">ê³ ì •</th>
                    </tr>
                </thead>
                <tbody id="itemList"></tbody>
            </table>
            <button class="btn btn-main" onclick="autoBalance()">ëª©í‘œ ìˆ˜ë‚©ì•¡ì— ë§ì¶° ë¹„ê¸‰ì—¬ ì—­ì‚° ì‹¤í–‰</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="target-box">
            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">ğŸ¯ ëª©í‘œ ìˆ˜ë‚©ì•¡</div>
            <input type="number" id="targetPrice" class="target-input" value="89000"> <span style="font-weight: 800; font-size: 1.2em;">ì›</span>
            <div style="margin-top: 20px;">
                <select id="seniorMode" onchange="calculate()" style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: 700; background: white; color: var(--primary);">
                    <option value="normal">ì¼ë°˜ ì™¸ë˜ (30%)</option>
                    <option value="senior">ë…¸ì¸ (65ì„¸ ì´ìƒ)</option>
                </select>
            </div>
        </div>

        <div class="card" style="text-align: center; margin-top: 20px; border: 2px solid var(--primary);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">í˜„ì¬ ìˆ˜ë‚© ì˜ˆìƒì•¡</div>
            <div id="finalPayment" style="font-size: 3.2em; font-weight: 900; color: var(--accent); letter-spacing: -1.5px;">0</div>
            <div style="margin-top: 10px; font-size: 0.9em; color: #444; border-top: 1px solid #eee; padding-top: 10px;">
                ë³¸ì¸ë¶€ë‹´ê¸ˆ: <span id="benefitPay" style="font-weight: 700;">0</span>ì›
            </div>
        </div>
    </div>
</div>

<footer>
    Â© JINSUL. All Rights Reserved. <br>
    <span style="opacity: 0.7; font-size: 0.85em; font-weight: 400; letter-spacing: 1px;">EXPERIENCE & VALUE REALIZATION</span>
</footer>

<script>
    // ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œ ì •ë³´ (0101 ë²„ì „ ë°˜ì˜)
    const REPO_URL = "https://raw.githubusercontent.com/jinsul-lab/openteam/main/";
    const FILES = [
        "ì˜ì¹˜ê³¼ìˆ˜ê°€(20260101).csv", // ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜ (0103 -> 0101)
        "ì•½ê°€(20260101).csv",
        "ì¹˜ë£Œì¬ë£ŒëŒ€(20250401).csv",
        "code.xls"
    ];

    let masterDB = {};
    let bundles = {};

    async function init() {
        const status = document.getElementById('statusText');
        const errorLog = document.getElementById('errorLog');
        
        try {
            for (const file of FILES) {
                status.innerText = `${file} ë™ê¸°í™” ì¤‘...`;
                // encodeURIComponentë¥¼ ì‚¬ìš©í•˜ì—¬ ê´„í˜¸ì™€ ê³µë°±ì´ í¬í•¨ëœ íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const res = await fetch(REPO_URL + encodeURIComponent(file));
                
                if (!res.ok) {
                    throw new Error(`[íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨] ${file}\nì›ì¸: ê¹ƒí—ˆë¸Œ ì„œë²„ ì‘ë‹µ ì—†ìŒ (íŒŒì¼ëª… ëŒ€ì†Œë¬¸ìë‚˜ ë¸Œëœì¹˜ëª…ì„ í™•ì¸í•˜ì„¸ìš”)`);
                }

                const arrayBuffer = await res.arrayBuffer();
                const text = new TextDecoder('euc-kr').decode(arrayBuffer);
                
                if (file.includes('code.xls')) {
                    parseBundle(text);
                } else {
                    parseMaster(text);
                }
            }
            document.getElementById('loader').style.display = 'none';
            renderOptions();
        } catch (e) {
            status.innerText = "âŒ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨";
            errorLog.innerText = e.message;
            console.error(e);
        }
    }

    function parseMaster(text) {
        const rows = text.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            const code = cols[0]?.trim().toUpperCase();
            if (code) {
                masterDB[code] = {
                    name: cols[3]?.trim() || cols[1]?.trim() || "í•­ëª©ëª… ì—†ìŒ",
                    price: parseInt(cols[7]) || parseInt(cols[4]) || 0
                };
            }
        });
    }

    function parseBundle(text) {
        const rows = text.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            const bCode = cols[0]?.trim();
            if (bCode) {
                if (!bundles[bCode]) bundles[bCode] = { name: cols[1], items: [] };
                const subCode = cols[3]?.trim().toUpperCase();
                if (subCode && subCode !== "ID") {
                    bundles[bCode].items.push({
                        code: subCode,
                        name: cols[4],
                        qty: parseFloat(cols[5]) || 1,
                        type: cols[9]?.includes('ë¹„ê¸‰ì—¬') ? 'nonbenefit' : 'benefit'
                    });
                }
            }
        });
    }

    function renderOptions() {
        const select = document.getElementById('bundleSelect');
        for (let code in bundles) {
            const opt = document.createElement('option');
            opt.value = code;
            opt.innerText = `[${code}] ${bundles[code].name}`;
            select.appendChild(opt);
        }
    }

    function loadBundle() {
        const code = document.getElementById('bundleSelect').value;
        if (!code) return;
        const list = document.getElementById('itemList');
        list.innerHTML = "";
        bundles[code].items.forEach(item => {
            const info = masterDB[item.code] || { price: 0, name: "ë°ì´í„° ì—†ìŒ" };
            const tr = document.createElement('tr');
            tr.dataset.type = item.type;
            tr.innerHTML = `
                <td style="font-weight:700; color:#42526e;">${item.code}</td>
                <td><input type="text" value="${item.name || info.name}" style="background:transparent; border:none; font-weight:500;"></td>
                <td><input type="number" class="price" value="${info.price}" oninput="calculate()"></td>
                <td><input type="number" class="qty" value="${item.qty}" step="0.01" oninput="calculate()"></td>
                <td><button class="lock-btn ${item.type==='benefit'?'active':''}" onclick="this.classList.toggle('active')">${item.type==='benefit'?'ğŸ”’':'ğŸ”“'}</button></td>
            `;
            list.appendChild(tr);
        });
        calculate();
    }

    function calculate() {
        let bSum = 0, nbSum = 0;
        const senior = document.getElementById('seniorMode').value === 'senior';
        document.querySelectorAll('tr[data-type]').forEach(row => {
            const p = parseFloat(row.querySelector('.price').value) || 0;
            const q = parseFloat(row.querySelector('.qty').value) || 0;
            if (row.dataset.type === 'benefit') bSum += p * q;
            else nbSum += p * q;
        });

        let bPay = bSum * 0.3;
        if (senior) {
            if (bSum <= 15000) bPay = 1500;
            else if (bSum <= 20000) bPay = bSum * 0.1;
            else if (bSum <= 25000) bPay = bSum * 0.2;
            else bPay = bSum * 0.3;
        }
        const finalB = Math.floor(bPay / 10) * 10;
        const total = Math.floor((finalB + nbSum) / 100) * 100;

        document.getElementById('benefitPay').innerText = finalB.toLocaleString();
        document.getElementById('finalPayment').innerText = total.toLocaleString();
    }

    function autoBalance() {
        const target = parseInt(document.getElementById('targetPrice').value);
        calculate();
        const bPay = parseInt(document.getElementById('benefitPay').innerText.replace(/,/g, ''));
        const neededNB = target - bPay;

        const nbRows = Array.from(document.querySelectorAll('tr[data-type="nonbenefit"]'));
        const adjustable = nbRows.filter(r => !r.querySelector('.lock-btn').classList.contains('active'));

        if (adjustable.length === 0) return alert("ë‹¨ê°€ë¥¼ ì¡°ì •í•  ë¹„ê¸‰ì—¬ í•­ëª©ì˜ ì ê¸ˆ(ğŸ”“)ì„ í’€ì–´ì£¼ì„¸ìš”.");

        const targetRow = adjustable[0];
        const qty = parseFloat(targetRow.querySelector('.qty').value) || 1;
        targetRow.querySelector('.price').value = Math.round(neededNB / qty);
        calculate();
    }

    window.onload = init;
</script>
</body>
</html>
