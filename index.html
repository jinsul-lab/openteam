<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINSUL - Integrated Case Verification</title>
    <style>
        /* [Design] Glassmorphism & Centered Layout */
        :root { 
            --primary-grey: #444444; 
            --accent-red: #d73a49;
            --border-light: rgba(0, 0, 0, 0.1);
        }
        
        body { 
            margin: 0; background-color: #ffffff; color: #333333; 
            font-family: 'Pretendard', -apple-system, sans-serif; 
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
        }
        
        /* ì¤‘ì•™ ì›Œí„°ë§ˆí¬ */
        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60%; opacity: 0.06; z-index: -1; pointer-events: none; filter: grayscale(1);
        }

        header { width: 100%; padding: 40px 0; text-align: center; background: transparent; }
        .top-logo { width: 220px; filter: grayscale(1); opacity: 0.8; margin-bottom: 10px; }

        .container { 
            width: 1200px; max-width: 95%; margin: 0 auto; 
            display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 30px; padding-bottom: 100px;
        }

        /* [UI] íˆ¬ëª…ë„ 0.0 (Glassmorphism) */
        .card { 
            background: rgba(255, 255, 255, 0); 
            border: 1px solid var(--border-light); 
            border-radius: 12px; padding: 30px; 
            backdrop-filter: blur(1px); margin-bottom: 20px;
        }

        table { width: 100%; border-collapse: collapse; background: transparent !important; }
        th { border-bottom: 2px solid #eee; padding: 12px; text-align: left; font-size: 0.8em; color: #888; }
        td { padding: 12px; border-bottom: 1px solid #eee; background: transparent !important; }

        input, select { 
            background: rgba(255, 255, 255, 0.4); 
            border: 1px solid #ddd; padding: 10px; border-radius: 6px; width: 100%; 
        }

        .target-box { 
            background: rgba(0, 0, 0, 0.02); border: 1px solid var(--border-light);
            padding: 40px; border-radius: 15px; text-align: center; 
        }
        .target-input { 
            font-size: 3em; width: 220px; background: none; border: none; 
            border-bottom: 3px solid var(--primary-grey); color: var(--primary-grey); 
            text-align: right; font-weight: 900; outline: none; 
        }

        footer { 
            width: 100%; text-align: center; padding: 40px 0; 
            color: #aaaaaa; font-size: 0.85em; font-weight: 500; 
            letter-spacing: 1px; margin-top: auto;
        }

        .btn { padding: 15px 25px; border-radius: 8px; border: 1px solid #ddd; font-weight: 700; cursor: pointer; }
        .btn-main { background: #333; color: white; width: 100%; margin-top: 20px; font-size: 1.1em; border: none; }
        .lock-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.2; }
        .lock-btn.active { opacity: 1; color: var(--accent-red); }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
    </style>
</head>
<body>

<img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="watermark" onerror="this.style.display='none'">

<div id="loader">
    <div style="font-weight: 900; font-size: 1.2em; color: #333; margin-bottom: 10px;">JINSUL DATA LOADING...</div>
    <div id="statusText" style="font-size: 0.8em; color: #888;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</div>
</div>

<header>
    <img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo" alt="JINSUL">
    <div style="font-weight: 400; font-size: 0.9em; color: #888; letter-spacing: 3px;">INTEGRATED CASE VERIFICATION</div>
</header>

<div class="container">
    <div class="main-content">
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <select id="bundleSelect" style="flex: 1; font-weight: 700;">
                    <option value="">-- ë¶ˆëŸ¬ì˜¬ ë¬¶ìŒì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                </select>
                <button class="btn" onclick="loadBundle()">ë¡œë“œ</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">ì½”ë“œ</th>
                        <th>í•­ëª©ëª…</th>
                        <th style="width: 20%;">ë‹¨ê°€</th>
                        <th style="width: 10%;">ìˆ˜ëŸ‰</th>
                        <th style="width: 8%;">ê³ ì •</th>
                    </tr>
                </thead>
                <tbody id="itemList"></tbody>
            </table>
            <button class="btn btn-main" onclick="autoBalance()">ëª©í‘œ ìˆ˜ë‚©ì•¡ì— ë§ì¶° ë¹„ê¸‰ì—¬ ì—­ì‚° ì‹¤í–‰</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="target-box">
            <div style="font-size: 0.8em; color: #888; margin-bottom: 10px; font-weight: 600;">TARGET PAYMENT</div>
            <input type="number" id="targetPrice" class="target-input" value="89000"> <span style="font-weight: 800; font-size: 1.2em;">ì›</span>
            <div style="margin-top: 25px;">
                <select id="seniorMode" onchange="calculate()" style="font-weight: 700;">
                    <option value="normal">ì¼ë°˜ ì™¸ë˜ (30%)</option>
                    <option value="senior">ë…¸ì¸ (65ì„¸ ì´ìƒ)</option>
                </select>
            </div>
        </div>

        <div class="card" style="text-align: center; margin-top: 20px; border-top: 4px solid #333;">
            <div style="font-size: 0.8em; color: #888; margin-bottom: 10px; font-weight: 600;">TOTAL ESTIMATED</div>
            <div id="finalPayment" style="font-size: 3.5em; font-weight: 900; color: #333; letter-spacing: -2px;">0</div>
            <div style="margin-top: 15px; font-size: 0.9em; color: #888;">
                ë³¸ì¸ë¶€ë‹´: <span id="benefitPay" style="font-weight: 700; color: #333;">0</span>ì›
            </div>
        </div>
    </div>
</div>

<footer>
    Â© JINSUL INTEGRATED SYSTEM. ALL RIGHTS RESERVED.<br>
    <span style="opacity: 0.5; font-size: 0.9em; letter-spacing: 1px;">EXPERIENCE & VALUE REALIZATION</span>
</footer>

<script>
    // ë‚ ì§œê°€ ì œê±°ëœ ê³ ì • íŒŒì¼ëª… ì„¤ì •
    const REPO_URL = "https://raw.githubusercontent.com/jinsul-lab/openteam/main/";
    const FILES = [
        "ì˜ì¹˜ê³¼ìˆ˜ê°€.csv",
        "ì•½ê°€.csv",
        "ì¹˜ë£Œì¬ë£ŒëŒ€.csv",
        "ì²˜ë°©ì„¸íŠ¸.xls"
    ];

    let masterDB = {};
    let bundles = {};

    async function init() {
        const status = document.getElementById('statusText');
        try {
            for (const file of FILES) {
                status.innerText = `${file} ë°ì´í„° ë™ê¸°í™” ì¤‘...`;
                const res = await fetch(REPO_URL + encodeURIComponent(file));
                if (!res.ok) throw new Error(`íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${file}`);

                const arrayBuffer = await res.arrayBuffer();
                const text = new TextDecoder('euc-kr').decode(arrayBuffer); // í•œê¸€ ê¹¨ì§ ë°©ì§€
                
                if (file === "ì²˜ë°©ì„¸íŠ¸.csv") {
                    parseBundle(text);
                } else {
                    parseMaster(text);
                }
            }
            document.getElementById('loader').style.display = 'none';
            renderOptions();
        } catch (e) {
            status.innerText = "âŒ ë°ì´í„° ë¡œë”© ì—ëŸ¬ (íŒŒì¼ëª… í™•ì¸ í•„ìš”)";
            console.error(e);
        }
    }

    function parseMaster(text) {
        const lines = text.split(/\r?\n/);
        lines.slice(1).forEach(line => {
            const cols = line.split(',');
            if (cols.length > 1) {
                const code = cols[0].replace(/"/g, '').trim().toUpperCase();
                if (code) {
                    masterDB[code] = {
                        name: (cols[1] || cols[3] || "ì´ë¦„ì—†ìŒ").replace(/"/g, '').trim(),
                        price: parseInt((cols[7] || cols[4] || "0").replace(/"/g, '')) || 0
                    };
                }
            }
        });
    }

    function parseBundle(text) {
        const lines = text.split(/\r?\n/);
        lines.slice(1).forEach(line => {
            const cols = line.split(',');
            if (cols.length > 3) {
                const bCode = cols[0].replace(/"/g, '').trim();
                if (bCode) {
                    if (!bundles[bCode]) bundles[bCode] = { name: cols[1].replace(/"/g, ''), items: [] };
                    const subCode = cols[3].replace(/"/g, '').trim().toUpperCase();
                    if (subCode && subCode !== "ID") {
                        bundles[bCode].items.push({
                            code: subCode,
                            name: (cols[4] || "").replace(/"/g, ''),
                            qty: parseFloat(cols[5]) || 1,
                            type: line.includes('ë¹„ê¸‰ì—¬') ? 'nonbenefit' : 'benefit'
                        });
                    }
                }
            }
        });
    }

    function renderOptions() {
        const select = document.getElementById('bundleSelect');
        const sortedCodes = Object.keys(bundles).sort();
        sortedCodes.forEach(code => {
            const opt = document.createElement('option');
            opt.value = code;
            opt.innerText = `[${code}] ${bundles[code].name}`;
            select.appendChild(opt);
        });
    }

    function loadBundle() {
        const code = document.getElementById('bundleSelect').value;
        if (!code) return;
        const list = document.getElementById('itemList');
        list.innerHTML = "";
        bundles[code].items.forEach(item => {
            const info = masterDB[item.code] || { price: 0, name: "ë°ì´í„° ì—†ìŒ" };
            const tr = document.createElement('tr');
            tr.dataset.type = item.type;
            tr.innerHTML = `
                <td style="font-weight:700; color:#666;">${item.code}</td>
                <td><input type="text" value="${item.name || info.name}" style="background:transparent; border:none;"></td>
                <td><input type="number" class="price" value="${info.price}" oninput="calculate()"></td>
                <td><input type="number" class="qty" value="${item.qty}" step="0.01" oninput="calculate()"></td>
                <td><button class="lock-btn ${item.type==='benefit'?'active':''}" onclick="this.classList.toggle('active')">${item.type==='benefit'?'ğŸ”’':'ğŸ”“'}</button></td>
            `;
            list.appendChild(tr);
        });
        calculate();
    }

    function calculate() {
        let bSum = 0, nbSum = 0;
        const senior = document.getElementById('seniorMode').value === 'senior';
        document.querySelectorAll('tr[data-type]').forEach(row => {
            const p = parseFloat(row.querySelector('.price').value) || 0;
            const q = parseFloat(row.querySelector('.qty').value) || 0;
            if (row.dataset.type === 'benefit') bSum += p * q;
            else nbSum += p * q;
        });

        let bPay = bSum * 0.3;
        if (senior) {
            if (bSum <= 15000) bPay = 1500;
            else if (bSum <= 20000) bPay = bSum * 0.1;
            else bPay = bSum * 0.2;
        }
        const finalB = Math.floor(bPay / 10) * 10;
        const total = Math.floor((finalB + nbSum) / 100) * 100;

        document.getElementById('benefitPay').innerText = finalB.toLocaleString();
        document.getElementById('finalPayment').innerText = total.toLocaleString();
    }

    function autoBalance() {
        const target = parseInt(document.getElementById('targetPrice').value);
        calculate();
        const bPay = parseInt(document.getElementById('benefitPay').innerText.replace(/,/g, ''));
        const neededNB = target - bPay;

        const nbRows = Array.from(document.querySelectorAll('tr[data-type="nonbenefit"]'));
        const adjustable = nbRows.filter(r => !r.querySelector('.lock-btn').classList.contains('active'));

        if (adjustable.length === 0) return alert("ë‹¨ê°€ë¥¼ ì¡°ì •í•  ë¹„ê¸‰ì—¬ í•­ëª©ì˜ ì ê¸ˆì„ í’€ì–´ì£¼ì„¸ìš”.");

        const targetRow = adjustable[0];
        const qty = parseFloat(targetRow.querySelector('.qty').value) || 1;
        targetRow.querySelector('.price').value = Math.round(neededNB / qty);
        calculate();
    }

    window.onload = init;
</script>
</body>
</html>
