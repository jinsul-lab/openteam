<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINSUL - Professional Consulting System</title>
    <style>
        :root { --blue: #0052cc; --gray: #f4f5f7; --text: #172b4d; }
        body { font-family: 'Pretendard', sans-serif; margin: 0; background: #fafbfc; color: var(--text); }
        header { background: white; padding: 20px; border-bottom: 1px solid #ddd; text-align: center; }
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Dashboard Styling */
        .dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .target-box { background: var(--blue); color: white; padding: 30px; border-radius: 15px; text-align: center; }
        .target-input { font-size: 2.5em; width: 180px; background: none; border: none; border-bottom: 3px solid white; color: white; text-align: right; outline: none; font-weight: 800; }
        
        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: var(--gray); padding: 12px; text-align: left; font-size: 0.85em; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        input[type="number"], input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn { padding: 12px 25px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--blue); color: white; width: 100%; font-size: 1.1em; }
        .status { font-size: 0.9em; color: #666; margin-top: 10px; text-align: center; }
        .result-area { font-size: 3em; font-weight: 900; color: #d73a49; }
        .lock-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; opacity: 0.5; }
        .lock-btn.active { opacity: 1; color: red; }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0; font-size: 1.5em; letter-spacing: -1px;">JINSUL CONSULTING</h1>
    <div id="loadingStatus" class="status">ë°ì´í„° ë¡œë”© ì¤‘... (GitHub ì—°ê²° ì¤‘)</div>
</header>

<div class="container">
    <div class="dashboard">
        <div>
            <div class="card">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <select id="bundleSelect" style="flex:1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-weight: 700;">
                        <option value="">-- ë¬¶ìŒì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” (ìµœì‹  ì²˜ë°©ì„¸íŠ¸) --</option>
                    </select>
                    <button class="btn" onclick="loadBundle()" style="background: #ebecf0;">ì„¸íŠ¸ ë¡œë“œ</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th style="width:15%">ì½”ë“œ</th>
                            <th>í•­ëª©ëª…</th>
                            <th style="width:15%">ë‹¨ê°€</th>
                            <th style="width:10%">ìˆ˜ëŸ‰</th>
                            <th style="width:8%">ê³ ì •</th>
                        </tr>
                    </thead>
                    <tbody id="itemList">
                        </tbody>
                </table>
                <button class="btn btn-primary" style="margin-top:20px;" onclick="autoBalance()">ìë™ ì—­ì‚° ì‹¤í–‰ (Goal Seek)</button>
            </div>
        </div>

        <div>
            <div class="target-box">
                <div style="opacity:0.8; margin-bottom:10px;">ğŸ¯ ëª©í‘œ ìˆ˜ë‚©ì•¡</div>
                <div><input type="number" id="targetPrice" class="target-input" value="89000"> ì›</div>
                <div style="margin-top:20px;">
                    <select id="seniorMode" onchange="calculate()" style="padding: 5px; border-radius: 5px;">
                        <option value="normal">ì¼ë°˜ ì™¸ë˜ (30%)</option>
                        <option value="senior">ë…¸ì¸ (65ì„¸ ì´ìƒ)</option>
                    </select>
                </div>
            </div>

            <div class="card" style="text-align: center; margin-top: 20px;">
                <div style="color: #666; font-size: 0.9em;">í˜„ì¬ í™˜ì ìˆ˜ë‚©ì•¡</div>
                <div id="finalPayment" class="result-area">0 ì›</div>
                <hr>
                <div style="text-align: left; font-size: 0.85em; line-height: 1.6;">
                    â€¢ ë³¸ì¸ë¶€ë‹´ê¸ˆ: <span id="benefitPay">0</span>ì›<br>
                    â€¢ ë¹„ê¸‰ì—¬ ì´ì•¡: <span id="nonBenefitPay">0</span>ì›
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const REPO_BASE = "https://raw.githubusercontent.com/jinsul-lab/opneteam/main/";
    const FILES = {
        master: "ì˜ì¹˜ê³¼ìˆ˜ê°€(20260103).csv",
        drug: "ì•½ê°€(20260101).csv",
        material: "ì¹˜ë£Œì¬ë£ŒëŒ€(20251201).csv",
        bundle: "code.xls - sheet.csv"
    };

    let masterDB = {};
    let bundles = {};

    // 1. ë°ì´í„° ë¡œë”© (GitHubì—ì„œ ì§ì ‘ ê¸ì–´ì˜¤ê¸°)
    async function init() {
        try {
            document.getElementById('loadingStatus').innerText = "GitHubì—ì„œ ë§ˆìŠ¤í„° ë°ì´í„°ë¥¼ ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤...";
            
            // ëª¨ë“  ë§ˆìŠ¤í„° íŒŒì¼ ë¡œë“œ
            await Promise.all([
                loadCSV(FILES.master, 'benefit'),
                loadCSV(FILES.drug, 'benefit'),
                loadCSV(FILES.material, 'benefit'),
                loadBundleCSV(FILES.bundle)
            ]);

            document.getElementById('loadingStatus').innerText = "âœ… ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ (LA358, MM010 í¬í•¨)";
            renderBundleOptions();
        } catch (e) {
            document.getElementById('loadingStatus').innerText = "âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. íŒŒì¼ëª…ì´ë‚˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        }
    }

    async function loadCSV(fileName, type) {
        const res = await fetch(REPO_BASE + encodeURIComponent(fileName));
        const text = await res.text();
        const rows = text.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            if(cols[0]) masterDB[cols[0].trim().toUpperCase()] = {
                name: cols[1] || cols[3] || "ì´ë¦„ ì—†ìŒ",
                price: parseInt(cols[7]) || parseInt(cols[4]) || 0,
                type: type
            };
        });
    }

    async function loadBundleCSV(fileName) {
        const res = await fetch(REPO_BASE + encodeURIComponent(fileName));
        const text = await res.text();
        const rows = text.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            const bCode = cols[0]?.trim();
            if(bCode) {
                if(!bundles[bCode]) bundles[bCode] = { name: cols[1], items: [] };
                const subCode = cols[3]?.trim().toUpperCase();
                if(subCode && subCode !== "ID") {
                    bundles[bCode].items.push({
                        code: subCode,
                        name: cols[4],
                        qty: parseFloat(cols[5]) || 1,
                        type: cols[9]?.includes('ë¹„ê¸‰ì—¬') ? 'nonbenefit' : 'benefit'
                    });
                }
            }
        });
    }

    function renderBundleOptions() {
        const select = document.getElementById('bundleSelect');
        for(let code in bundles) {
            const opt = document.createElement('option');
            opt.value = code;
            opt.innerText = `[ì„¸íŠ¸] ${bundles[code].name}`;
            select.appendChild(opt);
        }
    }

    function loadBundle() {
        const bCode = document.getElementById('bundleSelect').value;
        if(!bCode) return;
        const list = document.getElementById('itemList');
        list.innerHTML = "";
        
        bundles[bCode].items.forEach(item => {
            const info = masterDB[item.code] || { price: 0 };
            const tr = document.createElement('tr');
            tr.className = 'item-row';
            tr.dataset.type = item.type;
            tr.innerHTML = `
                <td><input type="text" value="${item.code}" readonly></td>
                <td><input type="text" value="${item.name || info.name}"></td>
                <td><input type="number" class="price" value="${info.price || 0}" oninput="calculate()"></td>
                <td><input type="number" class="qty" value="${item.qty}" oninput="calculate()"></td>
                <td><button class="lock-btn ${item.type==='benefit'?'active':''}" onclick="this.classList.toggle('active')">${item.type==='benefit'?'ğŸ”’':'ğŸ”“'}</button></td>
            `;
            list.appendChild(tr);
        });
        calculate();
    }

    function calculate() {
        let benefitTotal = 0;
        let nonBenefitTotal = 0;
        const seniorMode = document.getElementById('seniorMode').value;

        document.querySelectorAll('.item-row').forEach(row => {
            const p = parseFloat(row.querySelector('.price').value) || 0;
            const q = parseFloat(row.querySelector('.qty').value) || 0;
            if(row.dataset.type === 'benefit') benefitTotal += p * q;
            else nonBenefitTotal += p * q;
        });

        // ë³¸ì¸ë¶€ë‹´ê¸ˆ ê³„ì‚° (ì¼ë°˜ 30%, ë…¸ì¸ ì •ì•¡/ì •ë¥ ì œ ìƒëµí›„ 30% ê¸°ì¤€ ì˜ˆì‹œ)
        let bPay = benefitTotal * 0.3;
        if(seniorMode === 'senior') {
            if(benefitTotal <= 15000) bPay = 1500;
            else if(benefitTotal <= 20000) bPay = benefitTotal * 0.1;
            else bPay = benefitTotal * 0.2;
        }
        
        const finalBPay = Math.floor(bPay / 10) * 10; // 10ì› ì ˆì‚¬
        const total = finalBPay + nonBenefitTotal;
        const finalTotal = Math.floor(total / 100) * 100; // 100ì› ì ˆì‚¬

        document.getElementById('benefitPay').innerText = finalBPay.toLocaleString();
        document.getElementById('nonBenefitPay').innerText = Math.round(nonBenefitTotal).toLocaleString();
        document.getElementById('finalPayment').innerText = finalTotal.toLocaleString() + " ì›";
        
        return { finalBPay, nonBenefitTotal };
    }

    function autoBalance() {
        const target = parseInt(document.getElementById('targetPrice').value);
        const { finalBPay } = calculate();
        const neededNonBenefit = target - finalBPay;

        const rows = Array.from(document.querySelectorAll('.item-row[data-type="nonbenefit"]'));
        const adjustable = rows.filter(r => !r.querySelector('.lock-btn').classList.contains('active'));

        if(adjustable.length === 0) {
            alert("ì¡°ì •í•  ë¹„ê¸‰ì—¬ í•­ëª©ì˜ ì ê¸ˆ(ğŸ”“)ì„ í’€ì–´ì£¼ì„¸ìš”.");
            return;
        }

        const targetRow = adjustable[0];
        const qty = parseFloat(targetRow.querySelector('.qty').value) || 1;
        targetRow.querySelector('.price').value = Math.round(neededNonBenefit / qty);
        calculate();
    }

    window.onload = init;
</script>
</body>
</html>
