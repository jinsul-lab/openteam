<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINSUL - Integrated Consulting System</title>
    <style>
        :root { 
            --primary: #0052cc; 
            --accent: #d73a49;
            --text: #172b4d;
        }
        
        /* 1. Glassmorphism & Watermark ìŠ¤íƒ€ì¼ */
        body { 
            margin: 0; 
            background-color: #f0f2f5;
            color: var(--text); 
            font-family: 'Pretendard', -apple-system, sans-serif;
            min-height: 100vh;
            position: relative;
        }

        /* ì¤‘ì•™ ì›Œí„°ë§ˆí¬ */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            opacity: 0.08; /* ì›Œí„°ë§ˆí¬ íˆ¬ëª…ë„ */
            z-index: -1;
            pointer-events: none;
            filter: grayscale(1);
        }

        header { 
            padding: 30px; 
            text-align: center; 
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
        }

        /* ìƒë‹¨ ë¡œê³  í¬ê¸° ì¡°ì • */
        .top-logo { width: 220px; filter: grayscale(1); margin-bottom: 10px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        
        /* 2. í‘œ ë° ì¹´ë“œ íˆ¬ëª…ë„ 100% ì„¤ì • */
        .card { 
            background: rgba(255, 255, 255, 0.0); /* 100% íˆ¬ëª… */
            border-radius: 20px; 
            padding: 25px; 
            border: 1px solid rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(2px); /* ë°°ê²½ ì›Œí„°ë§ˆí¬ê°€ ë¹„ì¹˜ë˜ ê¸€ìëŠ” ë³´ì´ê²Œ í•¨ */
            margin-bottom: 25px;
        }

        table { width: 100%; border-collapse: collapse; background: transparent; }
        th { background: rgba(0, 0, 0, 0.05); padding: 12px; text-align: left; font-size: 0.85em; }
        td { padding: 12px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); }

        input { 
            background: rgba(255, 255, 255, 0.4); 
            border: 1px solid rgba(0, 0, 0, 0.1); 
            padding: 8px; 
            border-radius: 6px; 
            width: 100%;
        }

        /* ëª©í‘œê°€ ë°•ìŠ¤ */
        .target-box { 
            background: rgba(0, 82, 204, 0.8); 
            color: white; 
            padding: 30px; 
            border-radius: 20px; 
            text-align: center;
            backdrop-filter: blur(5px);
        }
        .target-input { 
            font-size: 2.5em; width: 180px; background: none; border: none; 
            border-bottom: 3px solid white; color: white; text-align: right; font-weight: 800; 
        }

        /* í•˜ë‹¨ ì¹´í”¼ë¼ì´íŠ¸ */
        footer { 
            text-align: center; 
            padding: 50px 0; 
            color: #888; 
            font-size: 0.9em; 
            font-weight: 600;
        }

        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 15px; }
        .lock-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; opacity: 0.3; }
        .lock-btn.active { opacity: 1; color: var(--accent); }

        #loadingOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; 
        }
    </style>
</head>
<body>

<img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="watermark" onerror="this.style.display='none'">

<div id="loadingOverlay">
    <p id="loadText" style="font-weight:700;">JINSUL ë°ì´í„° ì—”ì§„ ê°€ë™ ì¤‘...</p>
    <div style="font-size: 0.8em; color: #888;" id="detailStatus">GitHub ì—°ê²° í™•ì¸ ì¤‘...</div>
</div>

<header>
    <img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo" alt="JINSUL LOGO">
    <div style="font-weight: 800; letter-spacing: -1px;">í†µí•© ìˆ˜ê°€ ì»¨ì„¤íŒ… ì‹œìŠ¤í…œ</div>
</header>

<div class="container">
    <div class="work-area">
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <select id="bundleSelect" style="flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-weight: 700;">
                    <option value="">-- ì„¸íŠ¸ ì²˜ë°© ë¡œë“œ (code.xls) --</option>
                </select>
                <button class="btn" onclick="loadBundle()" style="background: #ddd;">ë¡œë“œ</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">ì½”ë“œ</th>
                        <th>í•­ëª©ëª…</th>
                        <th style="width: 20%;">ë‹¨ê°€</th>
                        <th style="width: 10%;">ìˆ˜ëŸ‰</th>
                        <th style="width: 8%;">ê³ ì •</th>
                    </tr>
                </thead>
                <tbody id="itemList"></tbody>
            </table>
            <button class="btn btn-main" onclick="autoBalance()">ëª©í‘œê°€ì— ë§ì¶° ë¹„ê¸‰ì—¬ ì—­ì‚° ì‹¤í–‰</button>
        </div>
    </div>

    <div class="side-area">
        <div class="target-box">
            <div style="font-size: 0.9em; margin-bottom: 10px;">ğŸ¯ ëª©í‘œ ìˆ˜ë‚©ì•¡</div>
            <input type="number" id="targetPrice" class="target-input" value="89000"> ì›
            <div style="margin-top: 20px;">
                <select id="seniorMode" onchange="calculate()" style="width: 100%; padding: 8px; border: none; border-radius: 8px; font-weight: 700;">
                    <option value="normal">ì¼ë°˜ ì™¸ë˜ (30%)</option>
                    <option value="senior">ë…¸ì¸ (65ì„¸ ì´ìƒ)</option>
                </select>
            </div>
        </div>

        <div class="card" style="text-align: center; margin-top: 20px; border: 1px solid var(--primary);">
            <div style="color: #666; font-size: 0.9em;">í˜„ì¬ í™˜ì ìˆ˜ë‚©ì•¡</div>
            <div id="finalPayment" style="font-size: 3em; font-weight: 900; color: var(--accent);">0</div>
            <div style="font-weight: 700; color: #666;">ë³¸ì¸ë¶€ë‹´ê¸ˆ: <span id="benefitPay">0</span>ì›</div>
        </div>
    </div>
</div>

<footer>
    Â© JINSUL. All Rights Reserved. <br>
    <span style="font-weight: 400; font-size: 0.8em; opacity: 0.6;">EXPERIENCE & VALUE REALIZATION</span>
</footer>

<script>
    // ì €ì¥ì†Œ ê²½ë¡œ ë° íŒŒì¼ëª… (ì‚¬ìš©ìë‹˜ GitHub ì •ë³´ ë°˜ì˜)
    const BASE_URL = "https://raw.githubusercontent.com/jinsul-lab/openteam/main/";
    const MASTER_FILES = [
        "ì˜ì¹˜ê³¼ìˆ˜ê°€(20260103).csv",
        "ì•½ê°€(20260101).csv",
        "ì¹˜ë£Œì¬ë£ŒëŒ€(20251201).csv"
    ];
    const BUNDLE_FILE = "code.xls - sheet.csv";

    let masterDB = {};
    let bundles = {};

    async function init() {
        const detail = document.getElementById('detailStatus');
        try {
            for (const file of MASTER_FILES) {
                detail.innerText = `${file} ë°ì´í„° ë™ê¸°í™” ì¤‘...`;
                await loadCSV(file);
            }
            detail.innerText = `ì„¸íŠ¸ ì²˜ë°©(Bundle) êµ¬ì„± ì¤‘...`;
            await loadBundleCSV(BUNDLE_FILE);
            
            document.getElementById('loadingOverlay').style.display = 'none';
            renderBundleOptions();
        } catch (e) {
            detail.innerHTML = "<span style='color:red'>ë°ì´í„° ë¡œë”© ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</span>";
            console.error(e);
        }
    }

    async function loadCSV(file) {
        const res = await fetch(BASE_URL + encodeURIComponent(file));
        if (!res.ok) throw new Error(file + " ë¡œë“œ ì‹¤íŒ¨");
        const arrayBuffer = await res.arrayBuffer();
        const decoder = new TextDecoder('euc-kr');
        const text = decoder.decode(arrayBuffer);
        const rows = text.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            const code = cols[0]?.trim().toUpperCase();
            if (code) {
                masterDB[code] = {
                    name: cols[3]?.trim() || cols[1]?.trim(),
                    price: parseInt(cols[7]) || parseInt(cols[4]) || 0
                };
            }
        });
    }

    async function loadBundleCSV(file) {
        const res = await fetch(BASE_URL + encodeURIComponent(file));
        const arrayBuffer = await res.arrayBuffer();
        const decoder = new TextDecoder('euc-kr');
        const text = decoder.decode(arrayBuffer);
        const rows = text.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            const bCode = cols[0]?.trim();
            if (bCode) {
                if (!bundles[bCode]) bundles[bCode] = { name: cols[1], items: [] };
                const subCode = cols[3]?.trim().toUpperCase();
                if (subCode && subCode !== "ID") {
                    bundles[bCode].items.push({
                        code: subCode,
                        name: cols[4],
                        qty: parseFloat(cols[5]) || 1,
                        type: cols[9]?.includes('ë¹„ê¸‰ì—¬') ? 'nonbenefit' : 'benefit'
                    });
                }
            }
        });
    }

    function renderBundleOptions() {
        const select = document.getElementById('bundleSelect');
        for (let code in bundles) {
            const opt = document.createElement('option');
            opt.value = code;
            opt.innerText = `[${code}] ${bundles[code].name}`;
            select.appendChild(opt);
        }
    }

    function loadBundle() {
        const code = document.getElementById('bundleSelect').value;
        if (!code) return;
        const list = document.getElementById('itemList');
        list.innerHTML = "";
        bundles[code].items.forEach(item => {
            const info = masterDB[item.code] || { price: 0 };
            const tr = document.createElement('tr');
            tr.dataset.type = item.type;
            tr.innerHTML = `
                <td style="font-weight:700;">${item.code}</td>
                <td><input type="text" value="${item.name || info.name}"></td>
                <td><input type="number" class="price" value="${info.price}" oninput="calculate()"></td>
                <td><input type="number" class="qty" value="${item.qty}" step="0.1" oninput="calculate()"></td>
                <td><button class="lock-btn ${item.type==='benefit'?'active':''}" onclick="this.classList.toggle('active')">${item.type==='benefit'?'ğŸ”’':'ğŸ”“'}</button></td>
            `;
            list.appendChild(tr);
        });
        calculate();
    }

    function calculate() {
        let bSum = 0, nbSum = 0;
        const senior = document.getElementById('seniorMode').value === 'senior';
        document.querySelectorAll('tr[data-type]').forEach(row => {
            const p = parseFloat(row.querySelector('.price').value) || 0;
            const q = parseFloat(row.querySelector('.qty').value) || 0;
            if (row.dataset.type === 'benefit') bSum += p * q;
            else nbSum += p * q;
        });

        let bPay = bSum * 0.3;
        if (senior) {
            if (bSum <= 15000) bPay = 1500;
            else if (bSum <= 20000) bPay = bSum * 0.1;
            else bPay = bSum * 0.2;
        }
        const finalB = Math.floor(bPay / 10) * 10;
        const total = Math.floor((finalB + nbSum) / 100) * 100;

        document.getElementById('benefitPay').innerText = finalB.toLocaleString();
        document.getElementById('finalPayment').innerText = total.toLocaleString();
    }

    function autoBalance() {
        const target = parseInt(document.getElementById('targetPrice').value);
        calculate();
        const bPay = parseInt(document.getElementById('benefitPay').innerText.replace(/,/g, ''));
        const neededNB = target - bPay;

        const nbRows = Array.from(document.querySelectorAll('tr[data-type="nonbenefit"]'));
        const adjustable = nbRows.filter(r => !r.querySelector('.lock-btn').classList.contains('active'));

        if (adjustable.length === 0) return alert("ë‹¨ê°€ë¥¼ ì¡°ì •í•  ë¹„ê¸‰ì—¬ í•­ëª©ì˜ ì ê¸ˆ(ğŸ”“)ì„ í’€ì–´ì£¼ì„¸ìš”.");

        const targetRow = adjustable[0];
        const qty = parseFloat(targetRow.querySelector('.qty').value) || 1;
        targetRow.querySelector('.price').value = Math.round(neededNB / qty);
        calculate();
    }

    window.onload = init;
</script>
</body>
</html>
