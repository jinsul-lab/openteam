<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINSUL - Integrated Consulting System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #0052cc; 
            --accent: #d73a49;
            --bg: #f8f9fa; 
            --card: #ffffff;
            --text: #172b4d;
            --border: #dfe1e6;
        }
        
        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        /* Layout */
        header { background: white; padding: 20px; border-bottom: 2px solid var(--primary); text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        
        /* Card & UI */
        .card { background: var(--card); border-radius: 16px; padding: 25px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        h2 { margin-top: 0; font-size: 1.2em; font-weight: 700; color: var(--primary); }
        
        /* Target Price Box */
        .target-box { background: linear-gradient(135deg, var(--primary), #0747a6); color: white; padding: 35px; border-radius: 20px; text-align: center; }
        .target-input { font-size: 3em; width: 220px; background: none; border: none; border-bottom: 4px solid rgba(255,255,255,0.4); color: white; text-align: right; outline: none; font-weight: 900; margin-bottom: 10px; }
        .target-input:focus { border-bottom-color: white; }
        
        /* Table Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        select, input[type="text"], input[type="number"] { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95em; }
        .bundle-select { flex: 1; font-weight: 700; background-color: #f4f5f7; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f4f5f7; padding: 12px; text-align: left; font-size: 0.8em; color: #6b778c; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        
        .item-code { font-weight: 700; color: #42526e; }
        .price-input, .qty-input { text-align: right; width: 100%; }

        /* Buttons */
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-main { background: var(--primary); color: white; width: 100%; font-size: 1.1em; margin-top: 15px; }
        .btn-main:hover { background: #0747a6; transform: translateY(-2px); }
        .btn-add { background: #ebecf0; color: #42526e; flex: 1; margin-top: 10px; }
        
        .lock-btn { background: none; border: none; font-size: 1.3em; cursor: pointer; opacity: 0.3; }
        .lock-btn.active { opacity: 1; color: var(--accent); }
        
        /* Result Area */
        .result-title { font-size: 0.9em; color: #6b778c; margin-bottom: 5px; }
        .result-val { font-size: 3.5em; font-weight: 900; color: var(--accent); letter-spacing: -2px; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <p id="loadText" style="margin-top:20px; font-weight:700;">GitHubì—ì„œ ë§ˆìŠ¤í„° ë°ì´í„°ë¥¼ ë™ê¸°í™” ì¤‘...</p>
</div>

<header>
    <div style="font-weight: 900; font-size: 1.8em; color: var(--primary);">JINSUL</div>
    <div style="font-size: 0.9em; font-weight: 600; color: #6b778c;">Value-added Healthcare Consulting System</div>
</header>

<div class="container">
    <div class="work-area">
        <div class="card">
            <h2>ì²˜ë°© êµ¬ì„± ë° ìˆ˜ê°€ ì„¤ì •</h2>
            <div class="controls">
                <select id="bundleSelect" class="bundle-select">
                    <option value="">-- ë¶ˆëŸ¬ì˜¬ ë¬¶ìŒì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                </select>
                <button class="btn" onclick="loadBundle()">ë¡œë“œ</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">ì½”ë“œ</th>
                        <th>í•­ëª©ëª…</th>
                        <th style="width: 18%;">ë‹¨ê°€</th>
                        <th style="width: 12%;">ìˆ˜ëŸ‰</th>
                        <th style="width: 8%;">ê³ ì •</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="itemList">
                    </tbody>
            </table>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-add" onclick="addRow('benefit')">+ ê¸‰ì—¬ ì¶”ê°€</button>
                <button class="btn btn-add" onclick="addRow('nonbenefit')">+ ë¹„ê¸‰ì—¬ ì¶”ê°€</button>
            </div>
            
            <button class="btn btn-main" onclick="autoBalance()">ìë™ ì—­ì‚° (Goal Seek) ì‹¤í–‰</button>
        </div>
    </div>

    <div class="side-area">
        <div class="target-box">
            <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">ğŸ¯ ëª©í‘œ ìˆ˜ë‚©ì•¡ ì„¤ì •</div>
            <div>
                <input type="number" id="targetPrice" class="target-input" value="89000" oninput="calculate()">
                <span style="font-size: 1.5em; font-weight: 800;">ì›</span>
            </div>
            <div style="margin-top: 20px;">
                <select id="seniorMode" onchange="calculate()" style="width: 100%; padding: 8px; border-radius: 8px; border: none; font-weight: 700;">
                    <option value="normal">ì¼ë°˜ ì™¸ë˜ (30%)</option>
                    <option value="senior">ë…¸ì¸ (65ì„¸ ì´ìƒ)</option>
                </select>
            </div>
        </div>

        <div class="card" style="margin-top: 20px; text-align: center;">
            <div class="result-title">í˜„ì¬ ìµœì¢… ìˆ˜ë‚©ì•¡</div>
            <div id="finalPayment" class="result-val">0</div>
            <div style="font-size: 1.5em; font-weight: 800; color: var(--accent); display: inline;">ì›</div>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
            
            <div style="text-align: left; font-size: 0.95em;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>ê¸‰ì—¬ ë³¸ì¸ë¶€ë‹´ê¸ˆ</span>
                    <span id="benefitPay" style="font-weight: 700;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ë¹„ê¸‰ì—¬ í•©ê³„</span>
                    <span id="nonBenefitPay" style="font-weight: 700;">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œ ì •ë³´ (ì˜¤íƒ€ ìˆ˜ì •ë¨)
    const REPO_BASE = "https://raw.githubusercontent.com/jinsul-lab/openteam/main/";
    const MASTER_FILES = [
        "ì˜ì¹˜ê³¼ìˆ˜ê°€(20260103).csv",
        "ì•½ê°€(20260101).csv",
        "ì¹˜ë£Œì¬ë£ŒëŒ€(20251201).csv"
    ];
    const BUNDLE_FILE = "code.xls - sheet.csv";

    let masterDB = {};
    let bundles = {};

    // ì´ˆê¸°í™”: ë°ì´í„° ë¡œë“œ
    async function init() {
        const loadText = document.getElementById('loadText');
        try {
            // 1. ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë“œ (EUC-KR ëŒ€ì‘)
            for (const file of MASTER_FILES) {
                loadText.innerText = `${file} ë¡œë”© ì¤‘...`;
                await loadCSV(file);
            }
            
            // 2. ë¬¶ìŒì½”ë“œ ë°ì´í„° ë¡œë“œ
            loadText.innerText = `ì²˜ë°© ì„¸íŠ¸ ë°ì´í„° êµ¬ì„± ì¤‘...`;
            await loadBundleCSV(BUNDLE_FILE);

            // 3. ì™„ë£Œ ì²˜ë¦¬
            document.getElementById('loadingOverlay').style.display = 'none';
            renderBundleOptions();
        } catch (e) {
            console.error(e);
            loadText.innerHTML = "âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>íŒŒì¼ëª…ê³¼ ê¹ƒí—ˆë¸Œ ì£¼ì†Œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
        }
    }

    async function loadCSV(fileName) {
        const res = await fetch(REPO_BASE + encodeURIComponent(fileName));
        if (!res.ok) return;
        
        const arrayBuffer = await res.arrayBuffer();
        const decoder = new TextDecoder('euc-kr');
        const text = decoder.decode(arrayBuffer);
        
        const rows = text.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            const code = cols[0]?.trim().toUpperCase();
            if(code) {
                masterDB[code] = {
                    name: cols[3]?.trim() || cols[1]?.trim() || "ì´ë¦„ì—†ìŒ",
                    price: parseInt(cols[7]) || parseInt(cols[4]) || 0
                };
            }
        });
    }

    async function loadBundleCSV(fileName) {
        const res = await fetch(REPO_BASE + encodeURIComponent(fileName));
        if (!res.ok) return;

        const arrayBuffer = await res.arrayBuffer();
        const decoder = new TextDecoder('euc-kr');
        const text = decoder.decode(arrayBuffer);
        
        const rows = text.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            const bCode = cols[0]?.trim();
            if(bCode) {
                if(!bundles[bCode]) bundles[bCode] = { name: cols[1], items: [] };
                const subCode = cols[3]?.trim().toUpperCase();
                if(subCode && subCode !== "ID") {
                    bundles[bCode].items.push({
                        code: subCode,
                        name: cols[4],
                        qty: parseFloat(cols[5]) || 1,
                        type: cols[9]?.includes('ë¹„ê¸‰ì—¬') ? 'nonbenefit' : 'benefit'
                    });
                }
            }
        });
    }

    function renderBundleOptions() {
        const select = document.getElementById('bundleSelect');
        for(let code in bundles) {
            const opt = document.createElement('option');
            opt.value = code;
            opt.innerText = `[ì„¸íŠ¸] ${bundles[code].name}`;
            select.appendChild(opt);
        }
    }

    function addRow(type, code="", name="", price=0, qty=1) {
        const list = document.getElementById('itemList');
        const tr = document.createElement('tr');
        tr.className = 'item-row';
        tr.dataset.type = type;
        
        tr.innerHTML = `
            <td class="item-code"><input type="text" value="${code}" onchange="lookup(this)"></td>
            <td><input type="text" value="${name}" class="name-input"></td>
            <td><input type="number" class="price-input" value="${price}" oninput="calculate()"></td>
            <td><input type="number" class="qty-input" value="${qty}" step="0.01" oninput="calculate()"></td>
            <td><button class="lock-btn ${type==='benefit'?'active':''}" onclick="this.classList.toggle('active')">${type==='benefit'?'ğŸ”’':'ğŸ”“'}</button></td>
            <td><button onclick="this.closest('tr').remove();calculate();" style="color:red; border:none; background:none; cursor:pointer;">Ã—</button></td>
        `;
        list.appendChild(tr);
        return tr;
    }

    function lookup(el) {
        const code = el.value.trim().toUpperCase();
        if(masterDB[code]) {
            const row = el.closest('tr');
            row.querySelector('.name-input').value = masterDB[code].name;
            row.querySelector('.price-input').value = masterDB[code].price;
            calculate();
        }
    }

    function loadBundle() {
        const bCode = document.getElementById('bundleSelect').value;
        if(!bCode) return;
        document.getElementById('itemList').innerHTML = "";
        
        bundles[bCode].items.forEach(item => {
            const info = masterDB[item.code] || { price: 0 };
            addRow(item.type, item.code, item.name || info.name, info.price, item.qty);
        });
        calculate();
    }

    function calculate() {
        let bSum = 0; // ê¸‰ì—¬ ì´ì (ê°€)
        let nbSum = 0; // ë¹„ê¸‰ì—¬ í•©ê³„
        const isSenior = document.getElementById('seniorMode').value === 'senior';

        document.querySelectorAll('.item-row').forEach(row => {
            const p = parseFloat(row.querySelector('.price-input').value) || 0;
            const q = parseFloat(row.querySelector('.qty-input').value) || 0;
            if(row.dataset.type === 'benefit') bSum += p * q;
            else nbSum += p * q;
        });

        // ë³¸ì¸ë¶€ë‹´ê¸ˆ ê³„ì‚° (30% ê¸°ì¤€)
        let bPay = bSum * 0.3;
        if(isSenior) {
            if(bSum <= 15000) bPay = 1500;
            else if(bSum <= 20000) bPay = bSum * 0.1;
            else if(bSum <= 25000) bPay = bSum * 0.2;
            else bPay = bSum * 0.3;
        }
        
        const finalBPay = Math.floor(bPay / 10) * 10; // 10ì› ì ˆì‚¬
        const total = finalBPay + nbSum;
        const finalTotal = Math.floor(total / 100) * 100; // 100ì› ì ˆì‚¬

        document.getElementById('benefitPay').innerText = finalBPay.toLocaleString();
        document.getElementById('nonBenefitPay').innerText = Math.round(nbSum).toLocaleString();
        document.getElementById('finalPayment').innerText = finalTotal.toLocaleString();
    }

    function autoBalance() {
        const target = parseInt(document.getElementById('targetPrice').value);
        if(!target) return;

        // 1. í˜„ì¬ ê¸‰ì—¬ ë³¸ì¸ë¶€ë‹´ê¸ˆ ê³„ì‚°
        calculate();
        const currentBPay = parseInt(document.getElementById('benefitPay').innerText.replace(/,/g, ''));
        const neededNB = target - currentBPay;

        // 2. ì¡°ì • ê°€ëŠ¥í•œ ë¹„ê¸‰ì—¬ í•­ëª© ì°¾ê¸° (ì ê¸ˆ í•´ì œëœ ê²ƒ)
        const rows = Array.from(document.querySelectorAll('.item-row[data-type="nonbenefit"]'));
        const adjustable = rows.filter(r => !r.querySelector('.lock-btn').classList.contains('active'));

        if(adjustable.length === 0) {
            alert("ê°€ê²©ì„ ì¡°ì •í•  ë¹„ê¸‰ì—¬ í•­ëª©ì˜ ì ê¸ˆ(ğŸ”“)ì„ í’€ì–´ì£¼ì„¸ìš”!");
            return;
        }

        // 3. ì²« ë²ˆì§¸ ë¹„ê¸‰ì—¬ í•­ëª©ìœ¼ë¡œ ê¸ˆì•¡ ëª°ì•„ì£¼ê¸°
        const targetRow = adjustable[0];
        const qty = parseFloat(targetRow.querySelector('.qty-input').value) || 1;
        
        // ë‹¤ë¥¸ ê³ ì •ëœ ë¹„ê¸‰ì—¬ì•¡ ë¹¼ê¸°
        let fixedNB = 0;
        rows.filter(r => r.querySelector('.lock-btn').classList.contains('active')).forEach(r => {
            fixedNB += (parseFloat(r.querySelector('.price-input').value) || 0) * (parseFloat(r.querySelector('.qty-input').value) || 0);
        });

        targetRow.querySelector('.price-input').value = Math.round((neededNB - fixedNB) / qty);
        calculate();
    }

    window.onload = init;
</script>

</body>
</html>
